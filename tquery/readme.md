# tQuery - 轻量级节点检索器

## 前言

传统的 `jQuery` 使用十分方便友好，但随着 `ES6`、`HTML5/CSS3` 的逐步成熟，我们可以编写一个轻量级的类 `jQuery` 工具，这就是 `tQuery`。它采用 `ES6` 语法编写，仅包含 `jQuery` 中有关 `DOM`、`CSS` 和 `Event` 的部分，即省略了 `Ajax`、`Deferred` 和 `Effect` 等，这些部分由 `ES6/HTML5` 中原生的 `Fetch`、`Promise` 和 `CSS3` 来支持。

大部分接口与 `jQuery` 相似，少数地方略有变化，也有一些扩展和增强，如支持嵌入代理（见 `$.embedProxy`），用户可以修改接口的默认行为。`tQuery` 名称里的 `t` 来源于 `Tpb` 里的 `Template`，但也可以理解为 `tiny`。

> **注：**<br>
> 本设计中的接口虽然与 jQuery 中的接口相似，但并不兼容，同名的接口只是在功能上相似而已。<br>
> 可以打开 `test.html` 在浏览器控制台执行 `console.dir($)` 或 `console.dir($(''))` 简单的查看接口情况。<br>



## Api 设计

`jQuery` 中对检索结果集的操作，在这里都有一个**单元素**的版本，如：`$.next(el, slr)`、`$.hasClass(el, names)` ，以及相应的集合版本：`$('xx').next(...)`、`$('xx').hasClass(...)`。单元素版通常返回 `$` 自身，集合版会返回一个 `Collector` 实例或值数组。与 `jQuery` 中类似，集合版的返回值 `Collector` 实例可以链式调用。

与 `jQuery` 对比，大多数情况下同名接口的行为相似，但少数地方依然有明显区别。如对元素集的属性取值，`jQuery` 中是仅取集合内**首个元素**的值，如 `$('a').attr('href')` 取首个 `<a>` 元素的 `href` 属性值，而 `tQuery` 中则会返回集合里全部元素的属性值（作为一个数组）。

又如 `$.html` 接口，`jQuery` 中它既可以处理文本，也处理节点元素，效果与连续的 `$.empty().append()` 调用相似。但在 `tQuery` 中该接口只负责文本的逻辑：设置元素内容时接收文本或提取元素的 `outerHTML` 文本，获取源码时提取元素的 `innerHTML` 值。另外也扩展了文本关联的功能，如转换源码。

在接口参数中，类名、事件名、特性/属性名、样式名支持空格分隔的多名称指定。在实现上，对浏览器原生事件对象无侵入，元素上也不存储额外数据，设计尽量精简，只要有可能就把任务交给原生的 `ES6`、`HTML5/CSS3` 去处理。


## 附录

### 与 jQuery 同名接口的差异简表

> **注：**<br>
> 下面接口的名称中，前置 `$.` 的指 `$` 的成员，前置 `.` 表示 `$(...)` 检索结果（`Collector` 实例）的成员。

- `.contains()`
    - *jQuery*: 仅针对内部子孙元素，不含容器元素自身测试。
    - *tQuery*: 包含容器元素自身测试，与DOM同名接口行为相同。

- `.hasClass()`
    - *jQuery*: 对空格分隔的名称序列视为一个整体。
    - *tQuery*: 空格分隔的名称序列被视为多个名称，逐个判断，因此 `class="A B"` 与 `class="B A"` 是一样的。

- `.is()`
    - *jQuery*: 只要集合中有一个匹配即为true，且可接受多种类型的参数。
    - *tQuery*: 对集合中每一个元素判断，返回一个true和false值混合的集合（数组），参数类型较为简单。

- `.first()/.last()`
    - *jQuery*: 简单返回集合中首个或最后一个成员。
    - *tQuery*: 返回集合中首个或最后一个**匹配**的成员。接受一个可选的选择器匹配参数，无实参调用时与jQuery相同。

- `$.data()/.data()`
    - *jQuery*: 存储与目标元素关联的任意数据，或者返回集合中匹配首个元素的存储的值。
    - *tQuery*: 没有该接口。元素的data-xx系属性融入在 `attr` 和 `prop` 接口中，支持名称简写（`-xx` 表示 `data-xx`）。

- `$.get()/.get()`
    - *jQuery*: `$.get` 为用 `Ajax` 方式通过 `GET` 方法获取目标网站的内容。`.get` 为获取集合内的某个成员。
    - *tQuery*: `$.get` 为获取文档中单个元素的版本，如通过 `id` 定位或 `querySelector` 检索。`.get` 为集合版的同功能接口，获取集合内某个成员采用 `.item` 接口。

- `$.wrap()/.wrap()/$.wrapInner()/.wrapInner()`
    - *jQuery*: 传递包含子元素的包裹容器时，会递进到最深层子元素为实际包裹容器，整个容器为复制方式。支持选择器选择目标元素。返回原始被包裹元素的集合。
    - *tQuery*: 与jQuery相同，包含子元素的包裹容器会递进到最深层子元素为包裹元素，但容器元素的克隆是可选的，并且返回的是包裹容器（根）本身，同时也支持被包裹内容为文本。如果包裹元素是既有的元素，可以指定是否同时克隆元素（及其子孙元素）上绑定的事件处理器。另外，集合版支持包裹元素的数组式指定（与被包裹数据一一对应）和前值默认等功能。

- `.wrapAll()`
    - *jQuery*: 用目标容器元素包裹集合内的全部成员，与 `$.wrap()` 等接口类似，容器元素会递进到首个最深层子元素（也为克隆方式），返回原始被包裹内容的集合。
    - *tQuery*: 用目标容器元素包裹集合内的全部成员，也与本库的 `$.wrap()` 等接口类似，支持包裹元素的克隆选项，返回包裹容器本身（`Collector` 封装），因此可以简单的链式调用（如 `.appendTo()` 等）。

- `$.html()/.html()`
    - *jQuery*: 接收节点参数时，是执行简单的复制和移动，实参节点会从原来的地方脱离DOM树。数组实参会被合并为单一的值，然后拷贝赋值到各个目标。
    - *tQuery*: 接收节点参数时，会提取元素的 `outerHTML` 或文本节点的 `textContent`，这里是纯粹的文本逻辑，不会影响原节点，同时也可以指定插入的位置。集合版版中数组实参是一一对应的逻辑。

- `$.text()/.text()`
    - *jQuery*: 接收节点参数时，只是简单地将节点转换为字符串，因此一个元素实际上会被转换为 `[object HTMLElement]` 之类的值。数组实参会被转换为数组的字符串表示，然后赋值。
    - *tQuery*: 接收节点参数时，会取节点的 `textContent` 值，不论这个节点是元素、文本节点还是注释节点。同样地，也可以指定插入的位置。集合版数组实参的说明参考 `.html` 接口说明。

- `$.val()/.val()`
    - *jQuery*: 获取或设置表单控件 `value` 属性的值，不论该表单控件是否已 `disabled`，效果与 `.prop('value', '...')` 相同。
    - *tQuery*: 严格遵循表单逻辑：取值时返回 `value` 属性的值，设置时部分控件为**对比目标值并改变控件状态**（如单/复选按钮、选单等），而非修改 `value` 属性本身。例如不能对 `<option>` 控件直接取值或设置，因为它们由 `<select>` 管理。另外，如果控件已 `disabled`，则取值返回 `null`，设置不起作用。（**注**：这是一个与 jQuery 版差异较大的接口）


### 与 jQuery 的其它差异

> **注：**<br>
> tQuery 只涉及 jQuery 中与 DOM 相关的部分，因此差异对比也仅限于这一子集。
> 因为 `$(...)` 的检索结果为 `Collector`（继承自Array），所以数组的方法也可以用，如 `.slice()` 可以提取集合中的部分成员（**注**：内部的链式栈不再有效）。

1. 元素和节点创建。
    - *jQuery*: 通过 `$( html )` 方式创建元素，但仅能创建元素（`Element`）而无法创建单纯的文本节点（`Text`）。
    - *tQuery*: 通过 `$.Element( tag, data, conf )` 创建元素，通过 `$.Text( data )` 创建文本节点。另外还有 SVG 和 Table 的特定接口。

2. 数据集合对元素集合的赋值。
    - *jQuery*: 当数据赋值到jQuery检索的结果集时，数据被视为一个单元执行拷贝赋值。如：`$('p').text([1, 3, 5])`，数组被转化为一个字符串：`1,3,5`，然后拷贝赋值到集合中每一个段落元素。
    - *tQuery*: 当目标元素是集合时（`Collector`），部分接口中数据源的类型被区别对待：如果是一个数组，则是各自**一一对应**。如上述例子，集合中的前3个段落被分别填充为 `1`、`2`、`3` 等值。

3. append/prepend/html/text 等接口的功能限定。

4. tQuery 中的工具函数。

5. 关于嵌入代理（$.embedProxy）。



### 嵌入代理的应用

#### plugins/tracker.js

追踪用户对页面元素的修改操作，提供回溯（Undo/Redo）的简便处理方式。
