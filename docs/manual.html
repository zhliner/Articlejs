<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>编辑器操作手册</title>
<link rel="stylesheet" href="../styles/example/main.css" />
<link rel="stylesheet" href="../styles/example/codes.css" />
<link rel="stylesheet" href="../base/tpb/default.css" />
<script src="../base/tquery/tquery.min.js"></script>
<style>
    body {
        margin: 0;
    }
    main {
        width: 800px;
        margin-left: 21em;
    }
</style>
<script type="module" async>
    import { Tpb } from "../base/tpb/tpb.esm.js";
    // 大纲导航：
    // 单击链接条目定位到目标章节。
    Tpb.build(
        document.querySelector('nav'),
        { on: "click(a)|evo(2) paths('nav[role=toc]', 'li') str('>section:nth-of-type(', ')') join str('/', '>h2') $('article') pop $(_1) intoView" }
    );
    // 列表滚动隐显
    // 单击目录标题条子表折叠
    Tpb.build(
        document.querySelector('nav>ol'),
        {
            on: "mouseenter|('auto'); mouseleave|('hidden'); click(~h4)|evo(2) parent fold(2)",
            to: "|css('overflow-y'); |css('overflow-y')"
        }
    )
</script>
</head>
<body>
    <main class="content">
        <h1>编辑操作</h1>
        <nav role="toc">
            <h3>目录</h3>
            <ol role="cascade">
                <li>
                    <h4><a>普通模式</a></h4>
                    <ol>
                        <li>
                            <h4><a>焦点元素</a></h4>
                            <ol>
                                <li><a>焦点移动</a></li>
                                <li><a>附：顶元素</a></li>
                            </ol></li>
                        <li>
                            <h4><a>元素选取</a></h4>
                            <ol>
                                <li><a>鼠标点选</a></li>
                                <li><a>按键选取</a></li>
                                <li><a>选取扩展</a></li>
                                <li><a>虚焦点支持</a></li>
                                <li><a>路径辅助选取</a></li>
                                <li><a>选取集排序</a></li>
                            </ol></li>
                        <li>
                            <h4><a>编辑操作</a></h4>
                            <ol>
                                <li><a>普通编辑</a></li>
                                <li><a>移动与缩进</a></li>
                                <li><a>进入微编辑</a></li>
                                <li><a>定位移动</a></li>
                                <li><a>复制和粘贴事件</a></li>
                            </ol></li>
                        <li><a>杂项功能</a></li>
                        <li><a>关于格式刷</a></li>
                    </ol></li>
                <li>
                    <h4><a>录入面板</a></h4>
                    <ol>
                        <li>
                            <h4><a>快捷键</a></h4>
                            <ol>
                                <li><a>录入文本框&lt;textarea&gt;</a></li>
                                <li><a>表格单元录入&lt;th|td&gt;</a></li>
                            </ol></li>
                    </ol></li>
                <li>
                    <h4><a>修订模式</a></h4>
                    <ol>
                        <li><a>代码元素</a></li>
                    </ol></li>
                <li><a>属性框</a></li>
                <li>
                    <h4><a>命令行</a></h4>
                    <ol>
                        <li><a>搜索（/）</a></li>
                        <li><a>查询（?）</a></li>
                    </ol></li>
                <li>
                    <h4><a>注记</a></h4>
                    <ol>
                        <li><a>单元移动/转换</a></li>
                        <li><a>表格的容错编辑</a></li>
                        <li><a>兼容性依赖</a></li>
                    </ol></li>
            </ol>
        </nav>
        <article>
            <header>
                <p>与常见的编辑器不同，本编辑器有<strong>两种</strong>模式：</p>
                <ol>
                    <li><strong>普通模式</strong>。键盘友好，用户可以通过快捷键（通常就是一个字符键）执行各种操作，如：复制、移动、删除、章节缩进、本地保存、源码导出、撤销或重做等。同时，这也是从下方<strong>主面板区</strong>插入各种内容的模式。</li>
                    <li><strong>修订模式</strong>。对录入的内容作小量修改时使用，此时回车键被严格限制，以兼容不同浏览器对<code>contenteditable</code>元素的<code>Enter</code>行为。该模式有时也称为<strong>微编辑</strong>模式。考虑便捷性，该模式下也支持创建<em>同类或逻辑新行</em>的能力。</li>
                </ol>
                <p>进入<em>修订模式</em>很简单：选中目标元素，键入热键<kbd>m</kbd>或<kbd>Tab</kbd>键（后者适用多个选中目标的连续进入）。或者，右击鼠标展开上下文菜单，点选<em>修改</em>条目进入。</p>
            </header>
            <section role="s1">
                <h2>普通模式</h2>
                <header>
                    <p>编辑器初始的常规状态即为普通模式。此时无法对文本进行编辑，但可以对内容进行各种控制。</p>
                    <ul>
                        <li><strong>选取</strong>：鼠标单击选取目标元素，按 <code>Ctrl</code> 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。</li>
                        <li><strong>克隆</strong>：将选取集元素克隆并插入到焦点元素前后。</li>
                        <li><strong>移动</strong>：将选取集元素移动到焦点元素前后。如果克隆/移动是在兄弟元素之间发生，则不会发生可能需要的内容转换。</li>
                        <li><strong>删除</strong>：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（如选取的是 <code>&lt;tbody&gt;</code> 元素），此时只会删除其<strong>内容</strong>，完整的单元才会被整体删除。</li>
                        <li><strong>录入</strong>：从编辑器主面板下方的功能区可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。</li>
                    </ul>
                    <aside>
                        <h3>附：快捷辅助键使用原则约定</h3>
                        <p>普通模式下大量的操作都可以使用热键（快捷键），这可以提高编辑效率。为便于记忆，快捷键的设定遵循如下原则。</p>
                        <ul>
                            <li><code>Shift</code>: 当前功能增强。</li>
                            <li><code>Ctrl</code>: 当前功能相关、衍生功能。</li>
                            <li><code>Alt</code>: 提供当前功能的额外能力，多与系统级相关联（系统能力支持），或逻辑差异较大。</li>
                        </ul>
                        <p>当然，用户也可以根据自己的习惯修改系统默认的热键配置（详见：<em>base/shortcuts.js</em>）。</p>
                    </aside>
                </header>
                <section role="s2">
                    <h2>焦点元素</h2>
                    <header>
                        <p>选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。</p>
                        <p>但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是<strong>当前正在或需要被操作的目标</strong>，它与浏览器文档节点树上的元素焦点并不相同。焦点之下的元素称为焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。</p>
                        <p>为了与浏览器节点树上的元素焦点概念区别，有时我们称之为<strong>选取焦点</strong>（注：下文中提到的焦点皆指此）。</p>
                    </header>
                    <section role="s3">
                        <h2>焦点移动</h2>
                        <p>选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 <code style="font-weight: bold; color: rgb(204, 0, 102);">hjkl</code>）移动。移动分为两个维度：</p>
                        <ul>
                            <li><strong>兄弟/平级</strong>：在DOM树的同级元素方向上，即兄弟元素间移动。</li>
                            <li><strong>父子/纵向</strong>：在DOM树的纵深方向上，即父子元素间的跨层级移动。</li>
                        </ul>
                        <p>借鉴于DOM的树逻辑，方向键含义如下：</p>
                        <ul>
                            <li><code>↑</code>： 平级移动，定位到前一个（<code>prev</code>）兄弟元素。支持数字指定移动距离，默认值 <code>1</code>（即前一个兄弟元素），特殊值 <code>0</code> 表示头部首个兄弟元素。</li>
                            <li><code>↓</code>： 平级移动，定位到下一个（<code>next</code>）兄弟元素。支持数字指定移动距离，默认值 <code>1</code>（即下一个兄弟元素），特殊值 <code>0</code> 表示末尾最后一个兄弟元素。</li>
                            <li><code>←</code>：纵向移动，定位到父元素（<em>父级方向</em>）。支持数字指定移动层级，默认值 <code>1</code>（即父元素），需提供准确数值，不支持 <code>0</code> 特殊值。</li>
                            <li><code>→</code>：纵向移动，定位到子元素（<em>子级方向</em>），支持数字指定子元素位置下标，默认值 <code>0</code>（即首个子元素），负值表示从末尾算起（<code>-1</code> 表示最后一个子元素）。</li>
                        </ul>
                        <p role="note"><strong>注记</strong>：方向键的逻辑设计实际上也符合文章纵向为平级罗列的表现。</p>
                    </section>
                    <section role="s3">
                        <h2>附：顶元素</h2>
                        <p>支持一个特殊的键 <code>t</code> 将焦点移动到当前焦点元素的<strong>顶元素</strong>上。顶元素是一个特意设计的<strong>虚拟</strong>根容器，以方便用户快速定位经常操作的目标。</p>
                        <ul>
                            <li>对于内联单元来说，顶元素是其所在行块的内容行元素。如 <code>&lt;p&gt;</code>、<code>&lt;li&gt;</code>、<code>&lt;dd&gt;</code> 和 <code>&lt;td&gt;</code> 等（<code>&lt;th&gt;, &lt;td&gt;</code> 被视为特殊内容块）。</li>
                            <li>对于行块单元内的中间结构元素，其顶元素即为单元根元素。如 <code>&lt;tr&gt;</code> 的顶元素为 <code>&lt;table&gt;</code>，列表项 <code>&lt;li&gt;</code> 的顶元素为其所在 <code>&lt;ol&gt;</code> 或 <code>&lt;ul&gt;</code>。</li>
                            <li>对于内联单元内的结构元素，其顶元素即是该内联单元本身。如 <code>&lt;rt&gt;</code> 的顶元素为 <code>&lt;ruby&gt;</code>，SVG 系子元素的顶元素为 <code>&lt;svg&gt;</code>。</li>
                        </ul>
                    </section>
                </section>
                <section role="s2">
                    <h2>元素选取</h2>
                    <section role="s3">
                        <h2>鼠标点选</h2>
                        <p>通过鼠标<strong>单击</strong>的方式可以定位焦点元素并实现选取或取消选取。</p>
                        <ul>
                            <li><code>单选：单击</code>: 简单单击选取目标元素，之前的选取会被取消。</li>
                            <li><code>多选：Ctrl + 单击</code>: 增加选取目标元素，之前的选取无影响。如果单击的是已经选取的元素，则为取消选取（切换逻辑）。</li>
                            <li><code>聚焦：Alt + 单击</code>: 仅将焦点移动到目标元素上，不作任何选取类动作。这在编辑操作中定位目标时有用。</li>
                        </ul>
                        <p>下面的选取有一定的智能性，单击的目标不一定是最终目标（与焦点元素有关）。</p>
                        <ul>
                            <li><code>跨选：Shift + 单击</code>: 同态焦点元素至目标元素的同级兄弟元素，如果目标元素层级较深，自动取与焦点元素同级的父级元素为目标。焦点移动到目标元素。</li>
                            <li><code>浮选：Ctrl + Shift + 单击</code>: 以焦点元素所在层级为依据，获取目标的同层级父级元素<strong>切换</strong>选取。如果目标与焦点元素不在同一父容器内则无效。</li>
                        </ul>
                        <p>任意目标的父级元素选取（与焦点元素无关）。</p>
                        <ul>
                            <li><code>父选（多选）：Alt + Ctrl + 单击</code>: 选取鼠标单击目标的父元素，不影响已有选取。比如直接选取表格行（<code>&lt;tr&gt;</code>）元素。</li>
                            <li><code>父焦（聚焦）：Shift + Alt + 单击</code>: 聚焦鼠标单击目标的父元素，不影响已有选取。</li>
                        </ul>
                        <aside>
                            <h3>同态：</h3>
                            <p>焦点元素有选取和非选取两者状态，使得目标与焦点元素状态相同，称之为<strong>同态</strong>操作。</p>
                        </aside>
                    </section>
                    <section role="s3">
                        <h2>按键选取</h2>
                        <p>在鼠标选取的基础上，通过键盘按键操作，我们可以实现更多的选取逻辑。</p>
                        <ul>
                            <li><code>Space | Enter</code>: 选取切换。焦点元素选取或取消选取，不影响其它已选取元素（类似 <code>Ctrl + 单击</code>）。</li>
                            <li><code>Shift + 箭头键</code>: 单选游走。移动焦点的同时改选目标元素（类似鼠标单击）。</li>
                        </ul>
                        <p role="tips"><strong>注</strong>：另外也支持 <code>Shift + t</code> 单选游走到焦点元素的<strong>顶元素</strong>（含义见后）。</p>
                    </section>
                    <section role="s3">
                        <h2>选取扩展</h2>
                        <p>在现有选取集的基础上，可以通过简单的键位操作将选取集进行扩展。扩展以当前焦点元素为参考，键位功能定义如下：</p>
                        <p>下面的扩展与焦点元素状态有关，会执行<strong>同态</strong>操作。</p>
                        <ul>
                            <li><code>a</code>: 定位全部兄弟元素，使得与焦点元素状态相同。焦点不变。</li>
                            <li><code>e</code>: 定位相同标签名的兄弟元素，使之与焦点元素状态相同，焦点不变。</li>
                            <li><code>Shift + e</code>: 定位叔伯元素（父元素的兄弟元素）内的相同标签子元素，使之与焦点元素状态相同，焦点不变。<strong>注</strong>：可用于同态所在章节内的标题，或跨行的列头单元格（<code>&lt;th&gt;</code>）。</li>
                            <li><code>Alt + Shift + e</code>: 定位叔伯元素内相同标签且相同位置的子元素，使之与焦点元素状态相同，焦点不变。<strong>注</strong>：定位表格列单元格时位置为逻辑列（容错跨列）。</li>
                        </ul>
                        <p>下面在移动焦点的同时按 <code>Ctrl + Shift</code> 键会执行<strong>同态</strong>操作。</p>
                        <ul>
                            <li><code>Ctrl + Shift + ↑</code>: 同级向前（<code>previous</code>）状态扩展，支持数字指定距离，焦点移动到最终元素上。</li>
                            <li><code>Ctrl + Shift + ↓</code>: 同级向后（<code>next</code>）状态扩展，逻辑同上。</li>
                        </ul>
                        <p>下面在移动焦点的同时按 <code>Ctrl + Shift</code> 键会同时执行<strong>选取</strong>操作。<strong>注</strong>：纵深方向上未设计同态逻辑（选取成员不会相互包含）。</p>
                        <ul>
                            <li><code>Ctrl + Shift + ←</code>: 向上移动焦点到父元素上，同时选取父元素。支持数字指定距离。</li>
                            <li><code>Ctrl + Shift + →</code>: 向下移动焦点到目标子元素上，同时选取目标子元素。支持数字指定子元素下标。</li>
                            <li><code>Ctrl + Shift + t</code>: 移动焦点到当前元素的顶元素（<code>Top</code>）上并选取。</li>
                        </ul>
                        <p>下面的操作与焦点元素状态无关，为固定的选取或取消选取逻辑。</p>
                        <ul>
                            <li><code>v</code>: 同级反选：已选取的取消选取，未选取的则选取。焦点不变。</li>
                            <li><code>w</code>: 选取焦点元素内全部内容根元素添加到现有选取集。焦点移动到首个内容根元素（<strong>注记</strong>：这可体现出视觉上的变化，如 <code>&lt;tr&gt;</code> 到 <code>&lt;td&gt;</code>）。</li>
                            <li><code>Shift + w</code>: 同上选取逻辑，但新的元素插入到现有选取集头部。焦点移动同上。</li>
                            <li><code>q</code>: 取消焦点元素之外的同级已选取，保留焦点元素选取或自动选取（若未选取）。</li>
                            <li><code>Shift + q</code>: 取消焦点元素之外全部已选取，焦点逻辑同上。</li>
                            <li><code>ESC</code>: 取消全部选取（<strong>注</strong>：可撤销），同时焦点也会被取消。</li>
                        </ul>
                    </section>
                    <section role="s3">
                        <h2>虚焦点支持</h2>
                        <p>大部分的选取操作都是基于焦点元素，但焦点元素只有一个。对于需要批量操作的场景，这并不友好，因此这里引入了<strong>虚焦点</strong>的设计。</p>
                        <p>虚焦点是：<strong>把当前选取集内的每一个成员都视为焦点元素</strong>，并据此执行特定的选取操作。支持虚焦点的操作并不多，并且只能是选取的逻辑而非<strong>同态</strong>（未选取即无法成为虚焦点）。</p>
                        <p>因为每一个成员都变成了焦点，所以这里有一些限制：</p>
                        <ol>
                            <li>仅适用部分简单的选取，比如 <code>e</code> 选取同级同类元素。而对于复杂的叔伯元素选取（<code>Shift + e</code>），则不适用。</li>
                            <li>平级操作时（如 <code>e</code>、<code>Shift + ↓</code>），选取集内的成员不能互为兄弟元素。即：每个成员只能是在其父元素内唯一选取的元素。纵向操作（如 <code>w</code>、<code>Shift + →</code>）则不限。</li>
                        </ol>
                        <p>通常，支持虚焦点的操作的快捷键辅助键为<code>Alt</code>，可用操作共计<strong>8</strong>个：</p>
                        <ul>
                            <li>平级类：<code>a</code>、<code>e</code>、<code>Shift + ↑</code>、<code>Shift + ↓</code>。每个成员在各自父元素内为单选，且仅为选取（<strong>非同态</strong>）。因为选取之后就失去了唯一性前提，所以这是<strong>一次性</strong>的。</li>
                            <li>纵深类：<code>w</code>、<code>Shift + →</code>、<code>Shift + ←</code>、<code>Shift + t</code>。向下操作时元素各自独立，向上操作时可能会有共同的父级元素（会自动去重）。</li>
                        </ul>
                        <p>如果操作使用了虚焦点，平级类操作会保留原来的实际焦点不变，但纵深类操作则会将焦点移到整个选取集的首个成员上。</p>
                    </section>
                    <section role="s3">
                        <h2>路径辅助选取</h2>
                        <p>在编辑器内容区的底部会显示当前焦点元素的<strong>DOM树路径</strong>，用鼠标单击其中任何一段，即可<strong>选取</strong>相应的元素。路径提供了清晰的节点树层次，可用于精确选取。</p>
                        <p>路径选取也有切换选取的逻辑，此时按住 <code>Ctrl</code> 键即可（否则为确定多选）。如果仅仅只是需要从路径上<strong>聚焦</strong>目标元素，则可以在单击的时候按住聚焦辅助键（<code>Alt</code>），此时只是改变焦点，而路径序列也不会重构。</p>
                        <p role="tips"><strong>提示</strong>：将鼠标滑过路径上的不同部分，会有其相应元素的背景阴影提示，便于用户识别其指代的目标。</p>
                    </section>
                    <section role="s3">
                        <h2>选取集排序</h2>
                        <p>元素选取的方式非常多也十分地灵活，有时候需要让选取的元素保有看上去（DOM树方向）的顺序，以便于进一步的操作（比如后面的系统级复制/粘贴）。</p>
                        <p>因此这里设计了两个快捷排序操作。</p>
                        <ul>
                            <li><code>s</code>: 选取集按DOM节点树排序，焦点定位到排序后的首个成员。</li>
                            <li><code>Shift + s</code>: 选取集按DOM节点树逆序，焦点定位同上（从DOM上看就是最后一个元素）。</li>
                        </ul>
                    </section>
                </section>
                <section role="s2">
                    <h2>编辑操作</h2>
                    <header>
                        <p>与选取类操作以焦点元素为中心不同，编辑操作的目标就是整个选取集元素。焦点元素在这里有另外的含义——用于定位与操作关联的目标（详见后）。</p>
                        <p>借鉴<strong>Vim</strong>编辑器的操作便利性，这里大部分的操作都采用单个键位（加辅助键）执行。</p>
                    </header>
                    <section role="s3">
                        <h2>普通编辑</h2>
                        <ul>
                            <li><code>del</code>: 智能删除。删除选取集中的元素，但仅限于完整单元和可删除的中间结构元素（如 <code>&lt;li&gt;</code>、<code>&lt;tr&gt;</code>、<code>&lt;dd&gt;</code> 等）。</li>
                            <li><code>Shift + del</code>: 增强删除。删除选取集中元素的可编辑内容（即内容根元素内的内容）。</li>
                            <li><code>Alt + Shift + del</code>: 强制删除。删除选取集中的任意元素，有破坏性。<strong>注</strong>：提供用户自主的能力，如高级用户编辑异形表格时。</li>
                        </ul>
                        <ul>
                            <li><code>u</code>: 撤消（Undo）。</li>
                            <li><code>r</code>: 重做（Redo）。</li>
                            <li><code>x</code>: 逆序。将选取集内的同级兄弟元素逆序重排，不相邻的元素会保持其位置。</li>
                            <li><code>z</code>: 合并。将选取集内元素的内容合并为一，合并顺序按选取时的顺序，首个选取元素为容器。仅限于内容元素。</li>
                            <li><code>Alt + z</code> 对内容区全文执行规范化（normalize），通常在命令行执行搜索时需要。</li>
                        </ul>
                        <ul>
                            <li><code>c</code>: 分组克隆。以选取集内<strong>相邻成员</strong>为分组，整体克隆并插入原组之后（<code>after</code>）。选取集更新为新插入的元素。<strong>特例</strong>：如果选取集只有一个成员，支持数字指定克隆数量。</li>
                            <li><code>Shift + c</code>: 各别克隆。选取集内每一个成员分别克隆并插入自身之后（<code>after</code>）。选取集更新为新插入的元素。特例支持同上。</li>
                        </ul>
                        <p>以下操作与焦点元素相关。</p>
                        <ul>
                            <li><code>f</code>: 向内填充。将选取集<strong>移动</strong>填充到焦点元素之内（<code>fill</code>），焦点元素<strong>不应当</strong>被选取。若源为非法子元素，会取内容创建默认子单元。</li>
                            <li><code>Shift + f</code>: 克隆填充。将选取集<strong>克隆</strong>填充到焦点元素之内（<code>fill</code>），焦点元素可以作为数据源。非法子元素规则同上。</li>
                            <li><code>d</code>: 向内添加。将选取集<strong>移动</strong>添加到焦点元素之内（<code>append</code>），焦点元素<strong>不应当</strong>被选取。非法子元素规则同上。</li>
                            <li><code>Shift + d</code>: 克隆添加。将选取集<strong>克隆</strong>添加到焦点元素之内（<code>append</code>），焦点元素可以作为数据源。非法子元素规则同上。</li>
                        </ul>
                        <ul>
                            <li><code>i</code>: 移动前插入。将选取集<strong>移动</strong>并插入到焦点元素之前（<code>before</code>）。不可删除元素会移除其内容，焦点元素不可选取。</li>
                            <li><code>Shift + i</code>: 克隆前插入。将选取集<strong>克隆</strong>并插入到焦点元素之前（<code>before</code>）。焦点元素可以作为数据源。</li>
                            <li><code>b</code>: 移动后插入。将选取集<strong>移动</strong>并插入到焦点元素之后（<code>after</code>）。不可删除规则同上，焦点元素不可选取。</li>
                            <li><code>Shift + b</code>: 克隆后插入。将选取集<strong>克隆</strong>并插入到焦点元素之后（<code>after</code>）。焦点元素可以作为数据源。</li>
                        </ul>
                        <aside>
                            <h3>注意</h3>
                            <p>插入的顺序是按照选取的顺序逐个提取，这样的设计可以有较大的灵活性。如果需要有序，可以先按 <code>s</code> 排序。</p>
                            <p>上面的移动逻辑并不专注于元素自身的移动，它们只是一种方便，表达东西被<strong>移动了</strong>的逻辑，有时只是取走了其内容（如果位置不匹配的话）。</p>
                            <p>这里的移动是跨层级的，适用任意目标位置。如果位置非法，内容会被自动转换。</p>
                        </aside>
                    </section>
                    <section role="s3">
                        <h2>移动与缩进</h2>
                        <p>移动与缩进是编辑中常见的操作，这里的移动是元素自身的移动，但受限于内容单元规定的HTML结构，这里的移动仅限于兄弟元素之间的<strong>平级</strong>移动。</p>
                        <p><strong>缩进</strong>的逻辑针对章节，因此操作仅适用于章节（<code>s1-s5</code>）或片区单元（<code>section</code>）单元，包含升级和降级两种操作。</p>
                        <ul>
                            <li><code>Alt + ↑</code>: 平级向前移动。选取集成员在各自父元素内移动，支持数字指定距离，超出范围会导致部分或全部逆序插入。<code>0</code> 值表示端部，有汇聚插入效果。</li>
                            <li><code>Alt + ↓</code>: 平级向后移动。支持同上。</li>
                            <li><code>Alt + ←</code>: 片区单元（<code>section</code>）左缩进（升级），升级之后排列到当前父片区之后（<code>after</code>）。<strong>注</strong>：这是一种层级递升，不一定必然表现在视觉上。</li>
                            <li><code>Alt + →</code>: 片区单元（<code>section</code>）右缩进（降级），会在原地创建一个空的片区容器来包含被降级的片区。</li>
                        </ul>
                        <aside>
                            <h3>注：</h3>
                            <p>顶层章节的升级会被简单忽略，因为已经没有更高的层级可用了。</p>
                            <p>末层章节（<code>s5</code>）再降级会变成没有 <code>role</code> 定义的<strong>深片区</strong>，深片区可以无限递进缩进。</p>
                        </aside>
                    </section>
                    <section role="s3">
                        <h2>进入微编辑</h2>
                        <p>可以对元素内容进行简单的修订（<code>modify</code>），这通过进入一种被称为<strong>微编辑</strong>的状态实现。这种修订仅适用于内容元素，非内容元素无效果（会有错误提示）。</p>
                        <p>微编辑按选取的元素顺序逐个进入，编辑完成后按快捷键（详见后）确认退出。同一时刻只有一个元素处于微编辑状态。</p>
                        <ul>
                            <li><code>m</code>: 进入微编辑，光标定位到单击点或可编辑内容元素的末端。</li>
                            <li><code>Shift + m</code>: 进入微编辑，光标定位到元素内容的前端。</li>
                            <li><code>Tab</code> 进入微编辑（同 <code>m</code>）。主要用于多个选取元素的顺序确认并进入下一个。</li>
                        </ul>
                        <p role="tips"><strong>提示</strong>：非内容元素不能直接进入微编辑，此时可以按 <code>w</code> 或 <code>Shift + w</code> 选取其内容元素然后再继续。</p>
                    </section>
                    <section role="s3">
                        <h2>定位移动</h2>
                        <p>有时侯需要内容保持绝对准确的相对位置，这时通常是设置其样式为 <code>position:absolute</code>。但这种定位方法需要用户了解 CSS 相关知识（对容器再设置 <code>position: relative</code> 样式），因此这里并不鼓励，用户需要自己在特性设置面板里编辑 <code>style</code> 特性来实现。</p>
                        <p>不过如果元素设置了绝对定位，这里提供方便的操作来微调其位置。</p>
                        <ul>
                            <li><code>Ctrl + ←</code>: 向左移动<strong>1</strong>像素。如果加按 <code>Shift</code> 则以<strong>10</strong>像素为单位。</li>
                            <li><code>Ctrl + →</code>: 向右移动<strong>1</strong>像素。<code>Shift</code> 键同上。</li>
                            <li><code>Ctrl + ↑</code>: 向上移动<strong>1</strong>像素。<code>Shift</code> 键同上。</li>
                            <li><code>Ctrl + ↓</code>: 向下移动<strong>1</strong>像素。<code>Shift</code> 键同上。</li>
                        </ul>
                        <aside>
                            <h3>注：</h3>
                            <p>上面的箭头键为真实的箭头键（非 <code>hlkj</code>），否则与单选游走冲突。</p>
                            <p>对于没有设置绝对定位的元素，这些组合键操作会被简单忽略。</p>
                            <p>插图单元的讲解在样式文件中有 <code>position:absolute</code> 和容器的 <code>position: relative</code> 定义。</p>
                        </aside>
                    </section>
                    <section role="s3">
                        <h2>复制和粘贴事件</h2>
                        <p>普通模式下支持选取集元素的<strong>复制、剪切和粘贴</strong>，这些操作由系统的复制、剪切和粘贴操作触发。普通模式下元素并不是可编辑的，因此这里的操作规则如下。</p>
                        <ul>
                            <li><strong>复制</strong>：提取被选取元素的文本内容（<code>textContent</code>）到剪贴板，多个选取元素的内容以换行符分隔。</li>
                            <li><strong>剪切</strong>：规则同复制，但同时会删除元素本身，如果元素可以被删除的话。</li>
                            <li><strong>粘贴</strong>：以换行符切分剪贴板里的文本内容，分别对应添加到选取集元素（或根内容）内。如果只选取了一个元素，则内容不切分。默认为末尾添加（<code>append</code>）方式，加按 <code>Shift</code> 键为覆盖（<code>fill</code>）方式。</li>
                        </ul>
                        <aside>
                            <h3>注意：</h3>
                            <p>粘贴里的分组插入仅与<strong>选取</strong>有关。比如选取一个 <code>&lt;tr&gt;</code>，会将相同的内容插入到内部所有的单元格中，如果需要与单元格一一对应，则应当选取单元格。</p>
                            <p>提取或插入的分组是以选取顺序为一一对应的（更灵活），但可能有点混乱的感觉。如果需要DOM的顺序，按 <code>s</code> 键先排序即可。</p>
                        </aside>
                    </section>
                </section>
                <section role="s2">
                    <h2>杂项功能</h2>
                    <ul>
                        <li><code>n</code>: 显示焦点元素关联的插入面板（并聚焦）。</li>
                        <li><code>p</code>: 打开单元属性编辑面板。</li>
                        <li><code>Alt + p</code>: 导出文章内容源码（打开导出对话框）。</li>
                        <li><code>Alt + Shift + p</code> 同上导出内容源码，但会在适当的位置插入大纲（目录）。</li>
                        <li><code>Ctrl + s</code>: 手动执行本地暂存（localStorage）。</li>
                        <li><code>g</code>: 章节跳转。根据键入的章节序列（如：<code>3.12.5</code>），将目标章节显示到当前视口。<strong>注</strong>：键入需要内容区聚焦。</li>
                    </ul>
                </section>
                <section role="s2">
                    <h2>关于格式刷</h2>
                    <p>将选取集内的元素样式应用为<strong>焦点元素</strong>的样式。焦点元素可以为选中或非选中状态（实质兼容）。</p>
                    <p>这与普通编辑器（如 Word）中的格式刷操作逻辑稍有不同。</p>
                </section>
            </section>
            <section role="s1">
                <h2>录入面板</h2>
                <header>
                    <p>与普通编辑器的原地输入不同，本设计中的内容录入主要通过内容面板来实现。</p>
                    <p>因为文章的内容单元有结构性限制，即该内容只能出现在什么位置（比如 <code>&lt;address&gt;</code> 应当只存在于 <code>&lt;footer&gt;</code> 内），所以录入面板的创建方式更合理，因为这样可以很方便的限定可以在目标位置创建什么内容。</p>
                    <p>目标位置用选取元素来标识，新的内容可以插入到该位置之前、之后或内部。如果选取了多个元素，可插入项目是各目标可插入项目的交集，且内容会同时插入到多个目标位置处。</p>
                </header>
                <section role="s2">
                    <h2>快捷键</h2>
                    <section role="s3">
                        <h2>录入文本框&lt;textarea&gt;</h2>
                        <ul>
                            <li><code>Alt+F</code><strong>切换</strong>录入框最大化（充满面板）。</li>
                            <li><code>Ctrl+Enter</code> 直接<strong>提交</strong>插入，效果同单击插入按钮。<strong>注</strong>：焦点会保持在录入框内。</li>
                            <li><code>Alt+Ctrl+Enter</code> 同上直接提交。但如果录入框已铺满，恢复为普通状态。</li>
                        </ul>
                    </section>
                    <section role="s3">
                        <h2>表格单元录入&lt;th|td&gt;</h2>
                        <ul>
                            <li><code>Enter</code> 纵向向下切换单元格（并选取）。</li>
                            <li><code>Shift + ↓</code> 同上效果。</li>
                            <li><code>Shift + ↑</code> 纵向向上切换单元格并选取。</li>
                            <li><code>Shift + Enter</code> 插入换行符（浏览器自身功能）。</li>
                        </ul>
                        <ul>
                            <li><code>粘贴</code> 内容以换行符切分，从焦点单元格开始，同行后续单元格连续粘贴（内容覆盖式）。</li>
                            <li><code>Shift + 粘贴</code> 普通方式粘贴，可能为纯文本（浏览器能力）。</li>
                        </ul>
                        <p role="tips"><strong>提示</strong>：智能切分粘贴只支持单行单元格序列。如果需要一次性对多行粘贴，可以插入后在内容区操作。</p>
                    </section>
                </section>
            </section>
            <section role="s1">
                <h2>修订模式</h2>
                <header>
                    <p>内容元素的 <code>contenteditable</code> 特性被设置为 <code>true</code>，此时即进入修订模式，编辑范围严格受限于容器元素之内。这种模式应当仅用于简单的文本修改。</p>
                    <p>在这种模式中，<code>Enter</code> 键的功能被严格限制，以回避不同浏览器的兼容性问题。</p>
                    <ul>
                        <li><code>Enter</code> 确认并退出。<strong>注</strong>：会提前执行 <code>normalize</code>。</li>
                        <li><code>Shift + Enter</code> 插入一个换行元素 <code>&lt;br&gt;</code>，或者在 <code>&lt;pre&gt;</code> 元素内插入一个换行字符 <code>\n</code>。<strong>注</strong>：浏览器默认行为。</li>
                        <li><code>Ctrl + Enter</code> 新建一个同类空行，原行确认，光标在新行内。仅限于段落类 <code>&lt;p:xx&gt;</code> 和列表项元素 <code>&lt;li&gt;, &lt;dt&gt;, &lt;dd&gt;</code>。</li>
                        <li><code>Alt + Enter</code> 新建一个逻辑空行。特定于 <code>dt &gt; dd</code> 和 <code>td|th ~ tr</code> 两种情况。</li>
                        <li><code>Tab</code> 完成并切换。功能与 <code>Enter</code> 类似，但会取消当前元素的选取并进入下一个已选取元素的微编辑（如果有）。</li>
                        <li><code>ESC</code> 取消当前修订并退出微编辑。元素选取保持。</li>
                    </ul>
                    <aside>
                        <h3>附：换行兼容性</h3>
                        <p><code>Enter</code> 的行为在不同浏览器之间差异较大，<code>Shift+Enter</code> 则较为一致。</p>
                        <p><code>&lt;pre&gt;</code> 元素微编辑修订后，其中的换行元素 <code>&lt;br&gt;</code> 会被强制替换为换行字符 <code>\n</code>，以保证内容的一致性。</p>
                    </aside>
                </header>
                <section role="s2">
                    <h2>代码元素</h2>
                    <p>对于普通的内容元素，修订时是所见即所得的。但对于代码内容，则是纯文本的（语法标注 <code>&lt;b&gt;</code> 会被清除），系统会在确认提交时重新解析语法。</p>
                    <p role="tips"><strong>提示</strong>：后期可能提供代码编辑时的即时解析高亮能力。</p>
                </section>
            </section>
            <section role="s1">
                <h2>属性框</h2>
                <p>选中目标元素或相同类型的多个单元，如果该类型有属性可修改，键入快捷键 <code>P</code> 或从上下文菜单中单击属性条目，可打开属性编辑对话框。</p>
                <p>如果目标只是单个单元，修改的属性条目会逐一应用：文本框内的空串会导致该条目的属性被移除，其它形式的控件则遵循所显示的意义。</p>
                <p>但如果目标是多个单元，则属性对应的条目控件存在<strong>不确定</strong>态，即 <code>indeterminate</code>。不确定态的条目如果未作修改（控件保持原样），则表示各条目的对应属性也会保持原样。这为多个目标的部分属性执行批量修改提供了可能性。表示不确定态的控件状态约定如下：</p>
                <ul>
                    <li>文本框： 包含 <code>&lt;input:text&gt;</code> 和 <code>&lt;textarea&gt;</code> 两种，无值（空串）时表示不确定态。<code>$.val()</code> 取值为一个空串。</li>
                    <li>单选按钮组： 没有任一按钮被选中时，表示不确定态。<code>$.val()</code> 取值为 <code>null</code>。</li>
                    <li>复选按钮： 浏览器支持其不确定态的特殊外观（通常是小方框内一个短横线），同时该控件的 <code>indeterminate</code> 属性值为 <code>true</code>。取值时应当检查 <code>indeterminate</code> 属性而不是简单地调用 <code>$.val()</code>。</li>
                    <li>条目选单： 即 <code>&lt;select&gt;</code>，类似单选按钮组，没有任一条目被选中时为不确定态。<code>$.val()</code> 取值为 <code>null</code>。</li>
                </ul>
                <p role="tips"><strong>注意</strong>：不确定态区分仅适用于多目标选取时。</p>
            </section>
            <section role="s1">
                <h2>命令行</h2>
                <section role="s2">
                    <h2>搜索（/）</h2>
                    <p>可以对全文或已选取的集合范围执行文本搜索，搜索的结果会被标记为特殊的 `&lt;mark&gt;` 元素。</p>
                    <p>文本的搜索以文本节点为上下文，不支持跨节点文本的搜索。这既是一种简化方便，也可能有它的合理性：既然文本被断开了，就认为横贯断点的文本不应当被匹配。</p>
                    <p>激活搜索的指令符为斜线（`/`）。焦点进入命令行后，遵循如下格式：</p>
                    <ul>
                        <li><code>Hello</code> 检索文本 <code>Hello</code>，回车后执行。如果已经存在选取集，则在选取集范围内执行检索。下同。</li>
                        <li><code>abc/xyz/ok</code> 检索文本 <code>abc/xyz/ok</code>，文本内的斜线只是普通字符。</li>
                    </ul>
                    <ul>
                        <li><code>/[0-9a-f]/i</code> 这是一个正则表达式，由前置的 <code>/</code> 标示出来。</li>
                        <li><code>/[0-9a-f]</code> 正则表达式<strong>格式错误</strong>，缺乏结尾 <code>/</code>。会被视为一个普通的字符串。</li>
                        <li><code>/[0-9a-f]/</code> 合法的正则表达式。</li>
                        <li><code>/[0-9a-f]/ </code> 末尾的空格使得这只是一个普通字符串，这也是搜索正则式串本身的一个小技巧。</li>
                    </ul>
                    <aside>
                        <h3>注记：</h3>
                        <p>不支持直接在表达式中定义替换功能，仅仅只是简单地检索文本内容。</p>
                        <p>检索结果会封装为（<code>&lt;mark&gt;</code>）并选取，因此可以通过其它方式操作目标。比如替换（粘贴+内容提升）、封装（转换）或删除（按 <code>Delete</code>）。</p>
                    </aside>
                </section>
                <section role="s2">
                    <h2>查询（?）</h2>
                    <p>保留问号（<code>?</code>）指令符用于未来的社区交互逻辑。</p>
                </section>
            </section>
            <section role="s1">
                <h2>注记</h2>
                <section role="s2">
                    <h2>单元移动/转换</h2>
                    <ul>
                        <li>同级兄弟元素间可自由移动，但不能跨越固定性单元。</li>
                        <li>跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。</li>
                    </ul>
                </section>
                <section role="s2">
                    <h2>表格的容错编辑</h2>
                    <p>通过特性编辑面板，用户可以修改单元格的 <code>rowspan</code> 和 <code>colspan</code> 特性，因此对于懂得 HTML 结构的专业用户来说，他们可以自由构建不规整的表格结构。因此，编辑器不阻止用户删除/插入独立的单元格。</p>
                    <p>但这种能力是用户自有的，如果克隆表格行（<code>&lt;tr&gt;</code>），编辑器并不检查单元格的这两个特性，而只是简单地参考表格的 <code>$.Table</code> 实例的内在状态值（列头和列数）进行处理。</p>
                </section>
                <section role="s2">
                    <h2>兼容性依赖</h2>
                    <p>修订模式下需要浏览器的 <code>document.execCommand</code> 支持，以实现从外部插入内容时，可以直接使用浏览器的<strong>Undo/Redo</strong>功能，避免编写复杂的撤销和重做代码。</p>
                </section>
            </section>
        </article>
    </main>
</body>
</html>