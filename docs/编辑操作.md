# 编辑操作

与普通的编辑器有所不同，本编辑器有两种操作模式：

1. 键盘友好的 **普通模式**。除了从主面板插入各种内容外，可以通过快捷键执行多种操作：选取、复制、移动、删除等。
2. 执行小量内容修改的**修订模式**。这是通过设置内容元素的 `contenteditable` 特性使得元素可编辑，适用于小量修订（有时也称为 **微编辑模式**）。

兼顾编辑的便捷性，修订模式下支持简单的创建新行的能力。


## 普通模式

编辑器初始即处于普通模式，普通模式下无法对文本进行编辑，但可以对内容进行各种控制操作（类似于 `Vim`），此时的状态也称为 **控制态**。

- **选取**：鼠标单击选取目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。
- **克隆**：将选取集元素克隆并插入到焦点元素前后。
- **移动**：将选取集元素移动到焦点元素前后。如果克隆/移动是在兄弟元素之间发生，则不会发生可能需要的内容转换。
- **删除**：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（如选取的是 `<tbody>` 元素），此时只会删除其 **内容**，完整的单元才会被整体删除。
- **录入**：从编辑器下方的主面板可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。


> ### 附：快捷辅助键使用原则约定
> 普通模式下大量的操作都可以使用快捷键，这极大地提高了编辑的效率。为了便于规范和记忆，快捷键的设定遵循如下原则。
>
> - `Shift`: 当前功能增强。
> - `Ctrl`:  当前功能相关、衍生功能。
> - `Alt`:   提供当前功能的额外能力，多与系统级相关联（系统能力支持），或逻辑差异较大。
>
> 当然，用户也可以根据自己习惯修改系统默认的快捷键配置（详见：*base/shortcuts.js*）。


### 焦点元素

选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。

但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是 **当前正在或需要被操作的目标**，它与浏览器文档节点树上的元素焦点并不相同。焦点之下的元素称为焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。

为了与浏览器节点树上的元素焦点概念区别，有时我们称之为 **选取焦点**（注：下文中提到的焦点皆指此）。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 `hjkl`）移动。移动分为两个维度：

- **兄弟/平级**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间的跨层级移动。

借鉴于DOM的树逻辑，方向键含义如下：

- `↑`： 平级移动，定位到前一个（`prev`）兄弟元素。支持数字指定移动距离，默认值 `1`（即前一个兄弟元素），特殊值 `0` 表示头部首个兄弟元素。
- `↓`： 平级移动，定位到下一个（`next`）兄弟元素。支持数字指定移动距离，默认值 `1`（即下一个兄弟元素），特殊值 `0` 表示末尾最后一个兄弟元素。
- `←`：纵向移动，定位到父元素（**父级方向**）。支持数字指定移动层级，默认值 `1`（即父元素），需提供准确数值，不支持 `0` 特殊值。
- `→`：纵向移动，定位到子元素（**子级方向**），支持数字指定子元素位置下标，默认值 `0`（即首个子元素），负值表示从末尾算起（`-1` 表示最后一个子元素）。

> **注记：**
> 方向键的逻辑设计实际上也符合文章纵向为平级罗列的表现。


#### 附：顶元素

支持一个特殊的键 `t` 将焦点移动到当前焦点元素的 **顶元素** 上。

顶元素是一个特意设计的 **虚拟** 根容器，以方便用户快速定位经常操作的目标。

- 对于内联单元来说，顶元素是其所在行块的内容行元素。如 `<p>`、`<li>`、`<dd>` 和 `<td>` 等（`<th>, <td>` 被视为特殊内容块）。
- 对于行块单元内的中间结构元素，其顶元素即为单元根元素。如 `<tr>` 的顶元素为 `<table>`，列表项 `<li>` 的顶元素为其所在 `<ol>` 或 `<ul>`。
- 对于内联单元内的结构元素，其顶元素即是该内联单元本身。如 `<rt>` 的顶元素为 `<ruby>`，SVG 系子元素的顶元素为 `<svg>`。


### 元素选取

通过鼠标 **单击** 的方式可以定位焦点元素并实现选取或取消选取。

- `单击`:        单选目标元素，之前的选取会被取消。**注**：同时聚焦，下同。
- `Ctrl + 单击`: 选取或取消选取目标元素，之前的选取无影响。即 **多选/切换** 的逻辑。
- `Alt + 单击`:  仅将焦点移动到目标元素上，不作任何选取类动作。这在编辑操作中定位目标时很有用。

在鼠标选取的基础上，通过 **键盘** 操作可以实现更多的选取逻辑。


#### 简单选取

通过鼠标单击或箭头键，我们可以把选取焦点定位到任意一个元素上，然后：

- `Space | Enter`: 执行选取或取消选取。**注**：类似 `Ctrl + 单击`。
- `Ctrl + Shift + [Arrow-Key]`: 移动焦点的同时改选目标元素（类似鼠标单击），单选游走。

> **注：**
> 另外也支持 `Ctrl + Shift + t` 单选游走到焦点元素的 **顶元素**（含义见后）。


#### 选取扩展

在现有选取集的基础上，可以通过简单的键位操作将选取集进行扩展。扩展以当前焦点元素为参考，键位功能定义如下：

下面的扩展与焦点元素状态有关，会执行 **同态** 操作（与焦点元素状态相同---选取或非选取）。

- `a`:               定位全部兄弟元素，使得与焦点元素状态相同。焦点不变。
- `e`:               定位相同标签名的兄弟元素，使之与焦点元素状态相同，焦点不变。
- `Shift + e`:       定位叔伯元素（父元素的兄弟元素）内的相同标签子元素，使之与焦点元素状态相同，焦点不变。**注**：可用于同态所在章节内的标题，或跨行的列头单元格（`<th>`）。
- `Alt + Shift + e`: 定位叔伯元素内相同标签且相同位置的子元素，使之与焦点元素状态相同，焦点不变。**注**：定位表格列单元格时位置为逻辑列（容错跨列）。


下面在移动焦点的同时按 `Shift` 键会同时执行 **同态** 操作。

- `Shift + ↑`: 同级向前（`previous`）状态扩展，支持数字指定距离，焦点移动到最终元素上。
- `Shift + ↓`: 同级向后（`next`）状态扩展，逻辑同上。


下面在移动焦点的同时按 `Shift` 键会同时执行 **选取** 操作。**注**：纵深方向上未设计同态逻辑（选取互斥）。

- `Shift + ←`: 向上移动焦点到父元素上，同时选取父元素。支持数字指定距离。
- `Shift + →`: 向下移动焦点到目标子元素上，同时选取目标子元素。支持数字指定子元素下标。
- `Shift + t`:  移动焦点到当前元素的顶元素（`Top`）上并选取。


下面的操作与焦点元素状态无关，为固定的选取或取消选取逻辑。

- `v`:          同级反选：已选取的取消选取，未选取的则选取。焦点不变。
- `z`:          选取焦点元素内全部内容子元素。焦点不变。
- `Shift + z`:  同上选取逻辑，但新的元素插入到选取集头部。焦点不变。
- `q`:          取消同级已选取元素。焦点不变。
- `ESC`:        取消全部选取（**注**：可撤销）。焦点不变。


#### 路径选取

在编辑器的底部会显示当前焦点元素的 **DOM路径** 序列，将鼠标指向路径中的各个单元，会友好提示单元对应的内容元素（就像鼠标滑过目标元素一样）。

因为路径序列提供了清晰的层次逻辑，因此可作为精细选取的参照：单击路径中任一单元，就可以选取该单元对应的内容元素。或者，也可以只是移动焦点而不选取，此时可以按住 `Alt` 单击即可（就像鼠标在内容区中的操作一样）。


#### 附：虚焦点支持

大部分的选取操作都是基于焦点元素，但焦点元素只有一个。对于需要批量操作的场景，这并不友好，因此这里引入了 **虚焦点** 的设计。

虚焦点是：**把当前选取集内的每一个成员都视为焦点元素**，并据此执行特定的选取操作。支持虚焦点的操作并不多，并且只能是选取的逻辑而非 **同态**（未选取即无法成为虚焦点）。

因为每一个成员都变成了焦点，所以这里有一些限制：

1. 仅适用部分简单的选取，比如 `e` 选取同级同类元素。而对于复杂的叔伯元素选取（`Shift + e`），则不适用。
2. 平级操作时（如 `e`、`Shift + ↓`），选取集内的成员不能互为兄弟元素。即：每个成员只能是在其父元素内唯一选取的元素。纵向操作（如 `z`、`Shift + →`）则不限。

通常，支持虚焦点的操作的快捷键会配置为在原选取操作快捷键上加 `Alt`。

> 可用操作（共计8个）：
> - 平级类：`a`、`e`、`Shift + ↑`、`Shift + ↓`。每个成员在各自父元素内为单选，且仅为选取（**非同态**）。因为选取之后就失去了唯一性前提，所以这是 **一次性** 的。
> - 纵深类：`z`、`Shift + →`、`Shift + ←`、`Shift + t`。向下操作时元素各自独立，向上操作时可能会有共同的父级元素（会自动去重）。

如果操作使用了虚焦点，则原来的实际焦点将不再变化。比如 `Shift + ↓` 本来会将焦点移动到目标元素上，但类似功能启用虚焦点的 `Alt + Shift + ↓` 操作则不会。


### 编辑操作

与选取类操作以焦点元素为中心不同，编辑操作的目标就是整个选取集元素。焦点元素在这里有另外的含义——用于定位与操作关联的目标（详见后）。

借鉴 `Vim` 编辑器的操作便利性，这里大部分的操作都采用单个键位（加辅助键）执行。


#### 普通编辑

- `d`:          智能删除。删除选取集中的元素，但仅限于完整单元和可删除的中间结构元素（如 `<li>`、`<tr>`、`<dd>` 等）。
- `Shift + d`:  增强删除。删除选取集中元素的可编辑内容（即内容根元素内的内容）。
- `Alt + Shift + d`: 强制删除。删除选取集中的任意元素，有破坏性。**注**：提供用户自主的能力，如高级用户编辑异形表格时。
- `u`:          撤消（Undo）。
- `r`:          重做（Redo）。

- `f`:          移动填充。将选取集或其内容移动填充到焦点元素之内（`fill`）。如果目标位置非法，即取内容填充。焦点元素不可选取。
- `Shift + f`:  克隆填充。将选取集或其内容克隆填充到焦点元素之内（`fill`）。规则同上但焦点元素可选取。
- `x`:          向内添加（移动）。正常向内添加的逻辑，有位置合法性约束，不一定添加到内部末尾。
- `Shift + x`:  向内添加（克隆）。同上。

- `i`:          移动插入。将选取集移动插入到焦点元素之前（`before`）。支持数字指定提前移动焦点到指定距离。
- `Shift + i`:  克隆插入。将选取集克隆并插入到焦点元素之前（`before`）。同上。
- `b`:          移动插入。将选取集移动插入到焦点元素之后（`after`）。支持数字指定提前移动焦点到指定距离。
- `Shift + b`:  克隆插入。将选取集克隆并插入到焦点元素之后（`after`）。同上。

- `c`:          原地克隆。对选取集内每一个成员分别克隆并插入原元素之前（`before`）。选取集更新为新插入的元素。
- `Shift + c`:  原地克隆。对选取集内每一个成员分别克隆并插入原元素之后（`after`）。同上。


#### 移动与缩进

移动与缩进是编辑中常见的操作，虽然普通编辑中的移动插入也是移动，但它们是通用的，可以跨层级操作并且会在必要时提取内容创建默认单元。

这里的 **移动** 仅限于平级兄弟元素之间，而 **缩进** 仅支持片区单元（`s1 ~ s5`），用于提升或降低层级。

- `Alt + ↑`:    平级向前移动。选取集成员在各自父元素内移动，支持数字指定距离，超出范围表示到终点的距离。
- `Alt + ↓`:    平级向后移动。支持同上。
- `Alt + ←`:   片区单元左缩进（升级），升级之后排列到当前父片区之前。**注**：这是一种层级递升，不一定必然表现在视觉上。
- `Alt + →`:   片区单元右缩进（降级），会创建一个空的容器片区包含当前已降级的片区。


#### 进入微编辑

可以对元素内容进行简单的修订（`modify`），这通过进入一种被称为 **微编辑** 的状态实现。这种修订仅适用于内容元素，非内容元素无效果（会有错误提示）。

微编辑按选取的元素顺序逐个进入，编辑完成后按快捷键（详见后）确认退出。同一时刻只有一个元素处于微编辑状态。

- `m`:         进入微编辑，光标定位到单击点或可编辑内容元素的末端。
- `Shift + m`: 进入微编辑，光标定位到元素内容的前端。
- `Tab`        进入微编辑（同 `m`）。主要用于多个选取元素的顺序确认并进入下一个。

> **提示：**<br>
> 非内容元素不能直接进入微编辑，此时可以按 `z` 或 `Shift + z` 选取其内容元素然后再继续。


#### 定位移动

有时侯需要内容保持绝对准确的相对位置，这时通常是设置其样式为 `position:absolute`。但这种定位方法需要用户了解 CSS 相关知识（对容器再设置 `position: relative` 样式），因此这里并不鼓励，用户需要自己在特性设置面板里编辑 `style` 特性来实现。

不过如果元素设置了绝对定位，这里提供方便的操作来微调其位置。

- `Ctrl + ←`: 向左移动 **1** 像素。如果加按 `Shift` 则以 **10** 像素为单位。
- `Ctrl + →`: 向右移动 **1** 像素。`Shift` 键同上。
- `Ctrl + ↑`:  向上移动 **1** 像素。`Shift` 键同上。
- `Ctrl + ↓`:  向下移动 **1** 像素。`Shift` 键同上。

> **注：**<br>
> 上面的箭头键为真实的箭头键（非 `hlkj`）。<br>
> 对于没有设置绝对定位的元素，这些组合键操作会被简单忽略。<br>
> 插图单元的讲解在样式文件中有 `position:absolute` 和容器的 `position: relative` 定义。<br>


#### 附：系统级复制与剪切

普通模式下支持选取集元素 **复制** 到剪贴板，但内容仅为纯文本（`textContent`）。以每个选取元素为一个单元提取文本，多个选取的内容用换行分隔。

支持剪贴板纯文本内容 **粘贴** 到选取元素上，此时为填充操作（仅限于内容元素）。如果剪贴板内容为多行文本，则为一一对应填充（不足者忽略），否则单一值适用全部目标元素。


### 杂项功能

- `n`:         显示焦点元素关联的插入面板（并聚焦）。
- `p`:         打开单元属性编辑面板。
- `Shift + p`: 打开文章内容的导出对话框。
- `s`:         手动执行本地暂存（localStorage）。
- `g`:         章节跳转。根据前置章节序列（如：`3.12.5`），将目标章节显示到当前视区。


### 关于格式刷

将选取集内的元素样式应用为 **焦点元素** 的样式。焦点元素可以为选中或非选中状态（实质兼容）。

这与普通编辑器（如 Word）中的格式刷操作逻辑稍有不同。


## 录入面板

与普通编辑器的原地输入不同，一篇文章的内容主要通过录入面板来输入。因为不同的内容单元有相关联的逻辑限制（比如页面主标题 `<h1>` 就不能出现在正文内容中，或者 `<address>` 也只能出现在小结/结语 `<footer>` 内），这种逻辑受限的录入设计是必要的。

录入面板中存在动态的条目区域，该区域内出现的条目与插入参考点相关（逻辑关联）。


### 附：交互友好性

在录入面板内的所有 `<textarea>` 录入框中支持以下快捷键：

- `Alt+F` **切换** 录入框最大化（占满面板）。
- `Ctrl+Enter` 直接 **提交** 插入，同时保持录入框最大化不变。
- `Alt+Enter` 直接 **提交** 插入，同时切换录入框最大化。


## 修订模式

内容元素的 `contenteditable` 特性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内。这种模式应当仅用于简单的文本修改。

在这种模式中，`Enter` 键的功能被严格限制，以回避不同浏览器的兼容性问题。

- `Enter`           确认并退出。元素的选取状态保持。**注**：会提前执行 `normalize`。
- `Shift + Enter`   插入一个换行元素 `<br>`，或者在 `<pre>` 元素内插入一个换行字符 `\n`。
- `Ctrl + Enter`    新建一个同类空行，原行确认，光标在新行内。仅限于段落类 `<p:xx>` 和列表项元素 `<li>, <dt>, <dd>`。
- `Alt + Enter`     新建一个逻辑空行。特定于 `dt > dd`，如果当前行不为 `<dt>`，则与 `Ctrl + Enter` 同。
- `Tab`             完成并切换。功能与 `Enter` 类似，但会取消当前元素的选取并进入下一个已选取元素的微编辑（如果有）。
- `ESC`             取消当前修订并退出微编辑。

> **附：换行兼容性**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 元素微编辑修订后，其中的换行元素 `<br>` 会被强制替换为换行字符 `\n`，以保证内容的一致性。<br>


### 代码元素

对于普通的内容元素，修订时是所见即所得的。但对于代码内容，则是纯文本的（语法标注 `<b>` 会被清除），系统会在确认提交时重新解析语法。

> **注：**
> 后期提供代码编辑时的即时解析高亮能力。


## 命令行

### 搜索（?）

可以对全文或已选取集执行文本搜索，然后实现过滤选取或文本替换。

文本的搜索以文本节点为上下文，不支持跨节点文本的搜索。这既是一种简化方便，也可能有它的合理性：既然文本被断开了，就认为横贯断点的文本不应当被匹配。

激活搜索的指令符为问号（`?`）。焦点进入命令行后，遵循如下格式：

- `Hello`       直接的文本表示搜索词（忽略大小写），回车后执行搜索。选取匹配文本所在的元素。如果已经存在选取集，则在选取集范围里执行新的选取。下同。
- `Hello/`      同上效果。末尾的 `/` 之后没有内容。
- `Hello/Hai`   分隔符 `/` 表示替换操作：将搜索到的 `Hello` 替换为 `Hai`。搜索范围为全文或当前选取集（如果有）。**注**：选取被修改的元素能体现出变化在哪，这是一种友好。
- `Hello/Hai/`  同上效果。
- `Hello//`     将搜索到的内容删除（替换为空）。末尾的 `/` 不可缺少。

- `/[0-9a-f]/i`     搜索词为一个正则表达式，这由前置的 `/` 表现出来。选取逻辑同上。下同。
- `/[0-9a-f]`       同上正则搜索但区分大小写。末尾没有修饰符时无需 `/` 结尾，但这是可选的，即 `/[0-9a-f]/` 与之相同。

- `/\s\s+/ /`       正则搜索并替换：将文本中的连续空白（渲染表现）替换为单个空格。中间分隔和末尾的 `/` 为必需。选取逻辑同前。下同。
- `/[a-f]+/abc/i`   正则搜索并替换。正则修饰符放在末尾的 `/` 之后，虽然它修饰的是前面的搜索词。

**注意**：文本的搜索/替换是全局的，即目标范围内所有匹配的项都会被替换。所以，你可能需要先执行一个选取性搜索，然后再确认替换。



## 注记

### 单元移动/转换

- 同级兄弟元素间可自由移动，但不能跨越固定性单元。固定性单元自身可移动。
- 跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。


### 内容提升

在严格的规范化内容结构里，片区与内容单元是互斥的逻辑。为便于用户操作，编辑器提供写作时的容错，但在文章提交类操作中提供规范化合并选项。

**另**：工具栏的内容提升按钮除了支持内容元素外，片区单元（容器）也是适用的。


### 表格的容错编辑

通过特性编辑面板，用户可以修改单元格的 `rowspan` 和 `colspan` 特性，因此对于懂得 HTML 结构的专业用户来说，他们可以自由构建不规整的表格结构。因此，编辑器不阻止用户删除/插入独立的单元格。

但这种能力是用户自有的，如果克隆表格行（`<tr>`），编辑器并不检查单元格的这两个特性，而只是简单地参考表格的 `$.Table` 实例的内在状态值（列头和列数）进行处理。



### 兼容性依赖

修订模式下需要浏览器的 `document.execCommand` 支持，以实现从外部插入内容时，可以直接使用浏览器的 **Undo/Redo** 能力，否则撤销和重做需要自己编写复杂代码。

另外，对于 `<textarea>` 内容的编辑也可以嵌入比较友好的处理，比如键入 `Tab` 键插入4个空格，而编辑历史会被浏览器自动记录，撤销和重做依然可以简单执行。


### 脚本能力

- 在脚本和命令行环境里提供正文区或选取集的 **文本节点集** 常量，供文本的批量 **搜索/替换** 操作。
- 命令行可以使用脚本录入框里的内容，视为数据集，每行一项。
