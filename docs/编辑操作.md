# 编辑操作

与常见的编辑器不同，本编辑器有**两种**模式：

1. **普通模式**。键盘友好，用户可以通过快捷键（通常就是一个字符键）执行各种操作，如：复制、移动、删除、章节缩进、本地保存、源码导出、撤销或重做等。同时，这也是从下方**主面板区**插入各种内容的模式。
2. **修订模式**。对录入的内容作小量修改时使用，此时回车键被严格限制，以兼容不同浏览器对 `contenteditable` 元素的 `Enter` 行为。该模式有时也称为**微编辑**模式。考虑便捷性，该模式下也支持创建*同类或逻辑新行*的能力。

进入*修订模式*很简单：选中目标元素，键入热键 `M`，或右击鼠标打开上下文菜单，点选*修改*条目进入。



## 全局热键

本编辑器的操作设计借鉴于大名鼎鼎的**Vim**，普通模式下通过**热键**完成大部分操作，内容录入主要从下方主面板上的内容标签页实现。

**注记**：要让一个普通的字符按键起作用，需要编辑器区域拥有*节点焦点*，以便让DOM节点树可以监听*按键事件*。

编辑器有两个*聚焦区域*：

1. **编辑器**。即编辑器自身整个界面（*全局*），单击编辑器任意位置即可。
2. **内容区**。显示文章内容的中间区域。部分与文章内容紧密相关的操作需要此处聚焦。单击内容区任意元素或顶部的工具栏、或者按压全局热键 `F8` 也可以完成。

当全局区域聚焦时（编辑器载入后自动完成），**全局热键**即可使用，当内容区聚焦时，内容区热键即有效。如果内容区的热键没有覆盖全局热键，内容区聚焦也同样就是全局聚焦。

几个基本的全局热键如下：

- `F2`：左侧大纲面板*隐显*切换。
- `F3`：下方功能区主面板*隐显*切换。
- `F4`：右侧帮助面板*隐显*切换。
- `F6`：内容区底部焦点元素DOM路径提示栏*隐显*切换。
- `F7`：打开插件对话框（按 `ESC` 键可取消显示）。
- `F8`：内容区聚焦。
- `F9`：当前在显主面板（大纲、功能区、帮助）状态切换，方便用户充分预览内容区。
- `F10`：当前窗口最大化切换。
- `ESC`：各种取消。支持 `选取集`、`上下文菜单`、`内联创建菜单`、`模态框`、`修订模式`、`前置数字` 设置、`录入框平铺` 等取消。*注意：选取集取消会进入编辑历史栈（可撤销）。*



## 普通模式

编辑器初始的常规状态即为*普通模式*。此时无法对文本进行编辑，但可以对内容进行各种控制。

- **选取**：鼠标单击选中目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些*扩展选取*的快捷方式。被选中的多个目标元素称为**选取集**，它们是接下来各种操作的目标对象。
- **移动**：将选取集元素移动到焦点元素之前、之后或内部。如果源元素不是目标位置合法的类型，会自动转换。平级移动非常简单（`Alt+↑` 或 `Alt+↓`），也不需要转换。
- **克隆**：将选取集元素克隆并插入到焦点元素之前、之后或内部，位置不合法时也会自动转换。原地克隆也很简单，键入热键 `C` 即可，同时也支持*前置数字*指定克隆的份数。
- **删除**：大部分元素可以按 `Delete` 键直接删除，但拥有固定结构（如表格）的内部元素不可以。删除操作会智能判断目标类型，不能直接删除的只会移除其内容（而不是目标本身）。当然，你也可以**强制删除**它。
- **缩进**：仅适用章节片区。对选中的章节单元进行*升级*或*降级*。
- **录入**：从下方主面板的内容标签页里可以录入各种内容单元，这也是编辑器主要的内容导入方式。内容单元有自己的结构逻辑，在什么位置可以插入什么单元，会在左侧的条目选单上体现。
- **转换**：对特定类型的单元可以进行类型转换，比如将多个段落转换为列表、无序列表转为有序列表等。选中一个或多个同类目标，右击弹出*上下文菜单*即可找到转换*子菜单*。
- **创建**：在一个文本行上用鼠标**划选**后，会弹出内联单元创建菜单，单击目标条目或热键即可创建内联单元。

> #### 附：快捷辅助键设计原则
>
> 普通模式下大量的操作都可以使用热键（快捷键）完成，这可以极大地提高效率。为便于记忆，热键设定遵循如下原则。
>
> - `X`: 某单个键位，完成某个功能操作。如 `C` 键复制当前选取集并原地插入（`after`）。
> - `Shift`+`X`: 当前功能增强。如 `Shift+C` 键复制当前选取集，各别插入原元素之后（`after`）。
> - `Ctrl`+`X`: 当前功能相关的衍生功能。如*修订模式*下的 `Ctrl+Enter` 创建一个同类新行。
> - `Alt`+`X`: 提供当前功能的额外能力，关联性更远一些。如 `Alt+←` 提升当前章节层级。
>
> 当然，用户也可以根据自己的喜好修改系统默认的热键配置（详见：*base/shortcuts.js*）。


### 焦点元素

选取集是元素按选中的先后顺序加入集合的，通常最后添加的元素拥有焦点。焦点是为了方便元素选取而设计的一个热点，大部分选取操作就是针对焦点元素而来。拥有焦点的元素即是焦点元素。

**提示**：内容区底部的路径栏显示的即是*焦点元素*的DOM路径信息。

焦点可以在任意元素间移动，通过鼠标单击点选，或者键入方向键来实现。这里的焦点与浏览器DOM元素焦点并不是同一个东西，为了与之相区别，我们可以视之为一种**选取焦点**。但下面为简单起见，统一称之为**焦点**。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，移动分为两个维度：

- **兄弟/平级**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间的跨层级移动。

借鉴Vim中的便捷方向键 `hjkl`（左下上右），以及DOM节点树的逻辑，方向键含义如下：

- `↑/K`： **平级移动**，定位到前一个（`prev`）兄弟元素。支持数字指定移动距离，默认值 `1`（即前一个兄弟元素），特殊值 `0` 表示头部首个兄弟元素。
- `↓/J`： **平级移动**，定位到下一个（`next`）兄弟元素。支持数字指定移动距离，默认值 `1`（即下一个兄弟元素），特殊值 `0` 表示末尾最后一个兄弟元素。
- `←/H`：**纵向移动**，定位到父元素（*父级方向*）。支持数字指定移动层级，默认值 `1`（即父元素）。
- `→/L`：**纵向移动**，定位到子元素（*子级方向*），支持数字指定子元素位置下标，默认值 `0`（即首个子元素），负值表示从末尾算起（`-1` 为最后一个子元素）。

**提示**：在内容区拥有浏览器焦点时，键入数字可设置之后操作的前置计数。左下角状态栏有数字提示，按 `ESC` 取消计数。

`Tab`：普通模式下，在当前选取集成员间按*选取顺序*移动焦点。加按 `Shift` 则逆向移动。


#### 附：顶元素

顶元素是一个**虚拟**的根元素，方便用户快速定位到经常操作的目标。热键 `T` 可以将焦点移动到当前焦点元素的**顶元素**上。

- 对于内联单元来说，顶元素是其所在行块的**内容行**元素。如 `<p>`、`<li>`、`<dd>` 和 `<td>` 等。
- 对于行块单元内的中间结构元素来说，其顶元素为单元自身的**根元素**。如 `<tr>` 的顶元素为 `<table>`，`<li>` 的顶元素为其所在的 `<ol>` 或 `<ul>` 等。
- 对于内联单元内的结构元素来说，其顶元素即是该内联**单元本身**。如 `<rt>` 的顶元素为 `<ruby>`，SVG系子元素的顶元素为其所属根容器 `<svg>`。


### 元素选取

#### 鼠标点选

通过鼠标**单击**的方式可以定位焦点元素并实现选取或取消选取。

- **单选**：`单击`。鼠标单击目标元素即选中目标，但之前的选取会被取消。
- **多选**：`Ctrl` + `单击`。目标元素会被添加到当前选取集内。如果目标已经是被选取的，则会取消选取（**切换**）。
- **聚焦**：`Alt` + `单击`。仅将选取焦点移动到目标元素上，没有选取作用。这在某些需要定位的操作中很有用。

下面的鼠标选取有一定的智能性，与焦点元素有关。

- **跨选**：`Shift` + `单击`。将焦点元素到目标元素的同级兄弟元素全部**选取**或**取消选取**。如果目标元素层级较深，自动取与焦点元素同级的容器元素为目标。焦点同时移动到目标上。与起始的焦点元素保持*相同状态*（选取与否）可被称为**同态**。
- **浮选**：`Ctrl` + `Shift` + `单击`。以焦点元素所在层级为依据，对目标元素的同层级容器元素执行**切换**选取。如果目标不在焦点元素所属父容器内则无效（简单忽略）。

下面的鼠标选取与焦点元素无关。

- **父选**：`Alt` + `Ctrl` + `单击`。选取鼠标单击的目标元素的父元素，将之添加到当前选取集。如果目标的父元素已经选取，则为取消选取（*多选*/*切换选取*逻辑）。这在选取表格行元素（`<tr>`）时很有用。
- **父焦**：`Shift` + `Alt` + `单击`。仅将选取焦点移动到单击目标的父元素上，不影响当前选取集。

> #### 同态：
>
> 焦点元素有选取和非选取两者状态，让目标元素与焦点元素状态相同，可简称为**同态**操作。


#### 按键选取

如果焦点元素已经存在（*鼠标点选*），通过简单的键盘按键，我们可以实现更多的选取操作。

- `Space` 或 `Enter`：**选取切换**。焦点元素选取或取消选取。不影响其它已选取元素，类似 `Ctrl` + `单击` 的效果。
- `Shift` + *箭头键*：**单选游走**。移动焦点的同时改选到目标元素，其它选取被取消，类似鼠标 `单击` 的效果。

**提示**：支持 `Shift` + `T` 单选游走到焦点元素的**顶元素**。顶元素含义见后。


#### 选取扩展

在现有选取集的基础上，通过简单的键位操作可以将选取集进行*扩展*。扩展以当前**焦点元素**为参考，键位定义如下：

下面的*扩展*与焦点元素状态有关，会执行*同态*操作。

- `A`：`All`，定位**全部**兄弟元素，使得它们与焦点元素的状态相同。焦点不变。
- `E`：`Element`，定位**同类**的兄弟元素（相同标签），使之与焦点元素状态相同。焦点不变。
- `Shift` + `E`：定位**叔伯**元素（父元素的兄弟元素）内的*相同标签*子元素，使之与焦点元素状态相同。焦点不变。这在选取同一父章节下的子章节的标题时很有用，或者选取表格中的列头（`<th>`）时有用。
- `Alt` + `Shift` + `E`：定位叔伯元素中**标签相同**且所在**位置也相同**的子元素，使之与焦点元素状态相同。焦点不变。这在选取*表格中的一列*时很有用。或者选取一个列表中*每一行的首个子元素*（如果标签相同）时有用。

**提示**：新添加的元素位于选取集内的后部，这样的顺序可能并不是你想要的。按 `S` 键可以按DOM节点流顺序排序选取集。

下面的热键在移动焦点的同时会执行**同态**操作。

- `Ctrl` + `Shift` + `↑`：同级**向前**（`previous`）扩展，支持前置数字指定扩展距离。焦点会移动到最终的元素上。
- `Ctrl` + `Shift` + `↓`：同级**向后**（`next`）扩展，支持同上。

**注记**：`Shift` 在这里表示选取增强，`Ctrl` 则表示*多选/切换选取*的逻辑，与鼠标多选逻辑相同。

下面的热键在移动焦点的同时会执行**选取**操作。*注：纵深方向上没有同态逻辑，因为选取成员不能相互包含。*

- `Ctrl` + `Shift` + `←`：**向上**移动焦点到*父元素*上，同时选取父元素。支持*数字*指定距离。
- `Ctrl` + `Shift` + `→`：**向下**移动焦点到*子元素*上，同时选取子元素。支持*数字*指定目标子元素的下表（`0` 为首个）。
- `Ctrl` + `Shift` + `T`：移动焦点到当前焦点元素的顶元素（`Top`）上并选取。

下面的操作与焦点元素状态无关，为固定的*选取*和*取消选取*逻辑。

- `V`：同级**反选**。针对焦点元素所在层级，已选取的元素*取消选取*，未选取的元素*选取*。焦点不变。
- `W`：**宽选**内容子。向下检索焦点元素内全部**内容根**元素，将之添加到选取集。焦点移动到首个成员（*以体现视觉变化*）。
- `Shift` + `W`：同上**宽选**逻辑，但新的内容子元素插入到选取集头部而非末尾。焦点移动到首个成员。
- `Q`：**排他选取**。取消焦点元素之外的同级已选取，保留焦点元素的选取（*若未选取则自动选取*）。
- `Shift` + `Q`：全局**排他选取**。取消焦点元素之外全部已选取，保留焦点元素的选取或自动选取。
- `ESC`：**取消**全部选取和焦点元素的选取焦点（**注**：可撤销）。


#### 虚焦点支持

大部分的选取操作都是基于*焦点元素*，但焦点元素只有一个。对于需要批量操作的场景，这并不友好，因此这里引入了**虚焦点**的设计。

虚焦点是把选取集内的**每一个成员都视为焦点元素**，然后执行特定的操作。支持虚焦点的操作并不多，并且只有**选取**而没有*同态*的逻辑。因为每一个成员都变成了焦点，所以这里有一些限制：

1. 仅适用部分简单的选取，比如 `E` 选取同级同类元素，复杂的叔伯元素选取（`Shift+E`）则不适用。
2. 平级操作时（如 `E`）选取集内的成员不能互为兄弟元素，每个成员只能是其父元素内的唯一选取。纵向操作（`W`）则无此约束。

通常，支持虚焦点的操作会辅以 `Alt` 键。可用操作共**8**个：

- **平级类**：`A`、`E`、`Ctrl+Shift+↑`、`Ctrl+Shift+↓`，其中的 `Ctrl` 改为 `Alt`。每个成员在其父元素内为单选，因为操作之后即失去了唯一性，所以这是*一次性*的。
- **纵深类**：`W`、`Ctrl+Shift+→`、`Ctrl+Shift+←`、`Ctrl+Shift+T`，其中的 `Ctrl` 改为 `Alt`。向下选取时元素各自独立，向上改选时共同的父级元素会被自动去重。

如果操作使用了虚焦点，*平级类*会保留原来的实际焦点不变，但*纵深类*则会将焦点移到整个选取集的**首个**成员上。


#### 路径辅助选取

在编辑器内容区的底部会显示当前焦点元素的**DOM树路径**，用鼠标单击其中任何一段，即可**选取**相应的元素。路径提供了清晰的节点树层次，可用于精确选取。

从路径上添加选取也可以是切换方式，按住 `Ctrl` 键单击即为切换，无辅助键则为简单多选。如果只需要从路径上**聚焦**目标元素，可按住 `Alt` 单击。注意此时只是改变焦点，路径序列并不会重构。

**提示**：将鼠标滑过路径上的不同部分，会有其对应元素的背景阴影提示。


#### 选取集排序

元素的选取方式非常多也很灵活，但选取集内部成员的顺序有时是很重要的，比如*合并*、*移动插入*或者系统级的*复制*/*粘贴*等。除了通过仔细的按顺序选取外，如果要让选取集成员按DOM节点流排序，可以用如下热键完成。

- **正序**：`S`。选取集按DOM节点流排序，焦点定位到排序后的首个成员。
- **逆序**：`Shift+S`。选取集按DOM节点树逆序排序，焦点定位规则同上（DOM上看为*最后一个*元素）。


### 编辑操作

与选取类操作以焦点元素为中心不同，编辑操作的目标就是整个选取集成员。但*焦点元素*在这里有另外的用途——*定位*操作关联的目标。借鉴于**Vim**的操作便捷性，这里大部分的操作也都采用单个键位（或加辅助键）完成。


#### 普通编辑

- **删除**：`Delete`。删除选取集内的元素，有一定智能性，部分不可单独删除的不会删除（如：`<td>`、`<rb>` 等）。
- **内容删除**：`Shift+Delete`。删除选取集元素内的可编辑内容（即内容元素里的内容），不含元素自身。
- **强制删除**：`Alt+Shift+Delete`。删除选取集内的任意元素，包括结构中不应被删除的子元素。有一定破坏性。

- **撤消**：`U`。Undo，撤销当前操作的选取或编辑。
- **重做**：`R`。Redo，重做被撤销的操作。
- **逆序**：`X`。将选取集内的同级兄弟元素逆序重排（移动），未选取的同级元素会保持原位置。
- **合并**：`Z`。将选取集内的元素的内容按选取顺序合并为一，**首个**选取的元素为容器，仅适用于内容元素。
- **规范合并**：`Alt+Z`。对整个内容区规范化（`normalize` 合并相邻的文本节点）。通常不需要。这是一种DOM优化，在执行搜索命令时有用，因为搜索会以文本节点为边界，相邻的文字如果属于不同节点，则不能成词。

- **分组克隆**：`C`。以选取集内**相邻的元素**为分组，整体克隆并插入原组之后（`after`）。选取集更新为新插入的元素。**特例**：如果选取集只有一个成员，支持数字指定克隆数量。
- **各别克隆**：`Shift+C`。对选取集内的每一个成员独自克隆并插入其后（`after`）。选取集更新为新插入的元素。

- **转为大写**：`Ctrl+U`。将选取集元素的文本全部转换为大写，如果加按 `Alt` 键，仅首段文本内的首个匹配转换。
- **转为小写**：`Ctrl+L`。将选取集元素的文本全部转换为小写。

以下操作与*焦点元素*有关。

- **向内填充**：`F`。将选取集成员**移动**填充到焦点元素之内（`fill`）。焦点元素**不应当**被选取。若源为非法子元素（结构限制），会自动提取其内容创建目标位置的默认子元素。
- **克隆填充**：`Shift+F`。将选取集成员**克隆**填充到焦点元素之内（`fill`）。焦点元素可以作为数据源。非法子元素规转换则同上。
- **向内添加**：`D`。将选取集成员**移动**添加到焦点元素内末尾（`append`）。焦点元素**不应当**被选取。非法子元素转换规则同上。
- **克隆添加**：`Shift+D`。将选取集成员**克隆**添加到焦点元素内末尾（`append`）。焦点元素可以作为数据源。非法子元素转换规则同上。

- **移动前插入**：`I`。将选取集成员**移动**并插入到焦点元素之前（`before`）。不可被删除的元素会移除其**内容**，焦点元素不可选取，非法元素转换规则同前。
- **克隆前插入**：`Shift+I`。将选取集成员**克隆**并插入到焦点元素之前（`before`）。焦点元素可以作为数据源，非法元素转换规则同前。
- **移动后插入**：`B`。将选取集成员**移动**并插入到焦点元素之后（`after`）。不可删除规则同上，焦点元素不可选取，非法元素转换规则同前。
- **克隆后插入**：`Shift+B`。将选取集成员**克隆**并插入到焦点元素之后（`after`）。焦点元素可以作为数据源，非法元素转换规则同前。

> #### 注意：
>
> 插入的顺序是按照选取的顺序逐个提取。这样的设计可以提高灵活性，如果需要有序，可以按 `S` 键排序。
>
> 上面的移动是**跨层级**的，适用任意目标位置。如果位置非法，内容会被*自动转换*。但这种移动并不那么直观，需要*焦点元素*来定位。下面有专注于简单移动的操作，比如兄弟元素之间的*平级移动*。


#### 移动与缩进

移动与缩进是编辑中常见的操作，这里的移动是元素自身的移动，但受限于内容单元固有的*HTML结构*，这里的移动仅限于兄弟元素之间的**平级**移动。

**缩进**的操作只适用于章节，针对*章节*（`s1-s5`）或*片区*（`section`）单元。包含**升级**和**降级**两种操作。

- **向前移动：**`Alt+↑`。选取集成员在各自父元素内平级移动，支持数字指定距离，超出范围会导致部分或全部逆序插入。`0` 值表示端部，有汇聚插入的效果。
- **向后移动：**`Alt+↓`。数字支持同上，移动行为类似（方向不同）。
- **章节升级**：`Alt+←`。章节或片区左缩进，升级之后会排列到当前父片区之后（`after`）。**注**：这种层级递升不一定必然表现出视觉差异。
- **章节降级**：`Alt+→`。章节或片区右缩进，会在原地创建一个空的片区容器来包含被降级的片区。

> #### 注：
>
> 同级兄弟元素间可自由移动，但不能跨越固定性单元，如标题（`<h4>`）元素。
>
> 顶层章节的升级会被简单忽略，末层章节（`<section role="s5">`）再降级会变成没有 `role` 定义的普通**深片区。**


#### 进入微编辑

可以对元素内容进行简单的修订（`Modify`），这通过进入一种**微编辑**的状态实现。这种修订仅适用于*内容元素*。有多个选取元素时，微编辑可按选取元素的顺序逐个进入。

编辑完成后按 `Enter` 或 `Tab` 键确认并退出。如果是 `Tab` 且选取集内还有元素，则切换到下一个成员。

- `M`：进入微编辑，光标定位到单击点。如果单击点不在元素内，进入后为全选状态。
- `Shift+M`：进入微编辑，光标定位到元素内容的末端。
- `Enter`：确认当前修订（退出微编辑）。
- `Tab`：确认当前修订。如果有多个选取，按选取顺序进入到下一个元素的修订。

**提示**：非内容元素不能直接进入微编辑，此时可以按 `W` 或 `Shift+W` 选取其内容元素然后再继续。


#### 定位移动

有时侯需要内容处于准确的平面位置，通常是设置其绝对样式（`position:absolute` 以及 `left` 或 `top` 值）。这种定位方法需要用户了解一些CSS知识，如对容器设置 `position:relative` 样式。

如果容器已经设置了 `position:relative`，元素自身设置了 `position:absolute`，通过下面的操作就可以简单调整位置。

- `Ctrl+←`：向左移动**1**像素。加按 `Shift` 则以**10**像素为单位。
- `Ctrl+→`：向右移动**1**像素。加按 `Shift` 键同上。
- `Ctrl+↑`：向上移动**1**像素。加按 `Shift` 键同上。
- `Ctrl+↓`：向下移动**1**像素。加按 `Shift` 键同上。

> #### 注意：
>
> 对于没有设置绝对定位的元素，这些组合键操作会被简单忽略。*插图*单元在内容样式文件中通常有其*图片讲解*的 `position: absolute` 和容器的 `position：relative` 定义，因此无需手动设置。


#### 复制和粘贴事件

普通模式下支持系统级（浏览器）的**复制**、**剪切**和**粘贴**操作，操作目标为当前**选取集**元素。

- **复制**：提取选取集元素的文本内容（`textContent`）到剪贴板，若有多个选取，内容以换行符分隔。
- **剪切**：规则同复制，但同时会删除元素本身，如果元素可以被删除的话。
- **粘贴**：以换行符切分剪贴板里的**文本**内容，分别添加到选取集元素或其*根内容元素*内。如果选取集只有一个成员，内容不会切分。粘贴默认为*填充覆盖*方式，加按 `Shift` 键为*末尾追加*（`append`）方式。

> #### 注意：
>
> 粘贴里的插入**分组**仅与**选取**有关，比如选取了一个 `<tr>` 元素，因为它不是内容元素，所以会宽选其内部的单元格为目标，但此时并不会分组，相同的内容会插入到其内所有单元格中。如果需要与单元格一一对应，应当选取单元格本身。
>
> 提取或插入的分组是按*选取顺序*对应的，可能你需要先按 `S` 键来排哈序。


### 杂项功能

- `P`：打开目标单元的**属性**编辑框。*注：从右击鼠标弹出的上下文菜单中也可以。*
- `Alt+P`：**导出**选取单元或全文内容*源码*，会自动打开导出对话框。
- `Alt+Shift+P`：**导出**全文内容*源码*，同时会在适当的位置插入文章**目录**（大纲）。与选取元素无关。
- `Ctrl+S`：内容源码**本地暂存**（`localStorage`）。*注：刷新页面会自动导入之前保存的内容。*
- `G`：**章节跳转**。根据键入的章节序列（如：`3.12.5`），将目标章节滚动到当前视口。*注：需内容区聚焦。*


### 格式刷

样式标签栏有一个**格式刷**按钮，可以对选取集内的元素应用**焦点元素**的样式。这种操作并不像普通编辑器（如Word）里那样，用刷子去同步样式，而是反过来先选取元素，再定位同步的样式源（选取焦点）。

虽然**内联的样式**很方便设置，但文档编写者应当**注意**，这些内联的样式是一种**硬编码**，并不方便应用*外部共享*的样式。

**提示**：这里编辑的文档有着规范化的HTML结构，样式共享很容易。你的读者可能希望使用他喜欢的样式来阅读。



## 录入面板

与普通编辑器的原地输入不同，本设计的内容录入主要通过内容面板来实现。

因为文章的内容单元有*结构性*限制，内容只能出现在*合法的位置*（比如 `<caption>` 只能在表格内），所以录入面板的创建方式更合理，这样可以很方便地限定在什么位置创建什么内容。

目标位置用**选取集**元素来标识，新的内容可以插入到该位置*之前*、*之后*或*内部*。如果选取了多个元素，可插入项目是各个目标可插入项目的交集，而内容也会同时插入到各个目标位置处。


### 快捷键

#### 文本框<textarea>

- `Alt+F`：录入框最大化**切换**（相对于面板）。*注：也可以按ESC键取消最大化。*
- `Ctrl+Enter`：直接**提交**插入，效果同单击 `插入` 按钮。焦点会保持在录入框内。
- `Alt+Ctrl+Enter`：同上直接**提交**。但如果录入框已最大化，会恢复到普通状态。


#### 表格单元<th|td>

- `Enter`：切换到当前列的**下一个**单元格。
- `Shift+↓`：同上当前列*向下*切换。
- `Shift+↑`：切换到当前列的**上一个**单元格。
- `Shift+Enter`：插入**换行符**（浏览器自身功能保留）。

- `Ctrl+V`：浏览器*粘贴*功能，但内容以换行符分段，从当前单元格开始向后*连续覆盖*。
- `Shift+Ctrl+V` 保留浏览器普通方式粘贴（纯文本）。

**提示**：智能切分粘贴只支持*当前行*单元格。如果需要一次性对*多行粘贴*，可在内容区的普通模式下进行。


#### 代码框<pre._code>

录入代码的文本框支持一些简单的**友好编辑**行为：比如回车*自动缩进*，初始粘贴自动*去除多余缩进*，`Tab` 键自动插入多个空格（一个缩进），而退格键 `Backspace` 则自动删除一个缩进等。

因为代码框拦截了 `Enter` 键的行为，所以前面普通文本框里的*快捷提交*功能就没有了。你需要明确点按 `插入` 按钮来完成提交。



## 修订模式

内容元素的 `contenteditable` 特性被设置为 `true` 时即进入了修订模式。因为浏览器处理 `contenteditable` 元素的差异较大，所以这里进行了严格约束，编辑范围也被严格限制。这种模式应当仅用于简单的文本修改和新行创建。

约束主要体现在对 `Enter` 键的限制上：

- `Enter`：确认当前修订并退出。
- `Shift+Enter`：插入一个换行 `<br>` 元素，在 `<pre>` 元素内会插入一个换行字符 `\n`。*注：浏览器自身功能。*
- `Ctrl+Enter`：新建一个*同类*空行，原行自动确认。适用于段落类和列表项元素 `<li>`, `<dt>,``<dd>`。
- `Alt+Enter`：新建一个*逻辑*空行，原行自动确认。适用诸如 `<dt>` 之后的 `<dd>`，或者 `<summary>` 之后的 `<p>` 等。
- `Tab`：完成当前修订并切换到下一个选取的元素。如果没有其它已选取的元素，则同 `Enter`。
- `ESC`：取消当前修订并退出微编辑。

> #### 换行兼容性：
>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。
>
> `<pre>` 元素在微编辑修订后，其中的换行元素 `<br>` 会被强制替换为换行字符 `\n`，以保证内容的一致性。

对于**代码元素** `<code>`，如果元素上有语言定义（`data-lang`），完成后自动解析语法高亮。



## 属性框

如果选中的元素有属性可修改，键入热键 `P` 可以打开属性编辑框。也可以从上下文菜单中点选属性条目打开。如果选中多个同类元素，打开的属性修改将应用到多个目标上。

操作单个目标时，修改的属性会逐一应用：文本框内的*空串*会使该属性被*移除*。

操作多个目标时，如果各个目标的某属性的值不一样，则出现**不确定**（`indeterminate`）态。如果不确定态的条目未作改变，则对应属性则保持原样。*不确定*态的控件表现约定如下：

- **文本框**：包含 `<input:text>` 和 `<textarea>` 两种，无值时表示不确定态。
- **单选按钮**：同一组单选按钮没有任一按钮被选中时，表示不确定态。
- **复选按钮**：浏览器支持其*不确定*态的特殊外观（可能是小方框内一个短横线）。
- **条目选单**：即 `<select>` 元素，类似单选按钮组，没有任一条目被选中时为不确定态。

**提示**：如果选取的多个目标类型不同，热键 `P` 不会有反应，展开上下文菜单时会发现*属性*条目为*禁用*状态。



## 命令行

编辑器底部状态栏上的文本输入条即是**命令行**，在这里可以执行一些高级操作。命令行支持简单的*历史搜索*：键入 `Tab` 键会显示上一次执行的命令，*在此基础上*键入**上下箭头**键可以在历史栈中游历。

命令行支持**5**种指令类型，分别由5个特殊字符标识：

- `>`： **选取**。命令行内容为 `CSS` 选择器，可在当前选取集或全局范围（内容区）内检索选取目标元素。
- `|`： **过滤**。命令行内容为过滤条件，可对当前选取集执行过滤。
- `/`： **搜索**。命令行内容为搜索的*目标文本*，在选取集或全局搜索范围搜索目标文本并*标记*。
- `:`： **命令**。命令行内容为编辑器支持的*命令*，主要是一些基本的工具函数。
- `=`： **计算**。将命令行内容视为 `JS` 表达式，执行简单的计算并返回到命令行*回显*。

命令行有全局的热键可以直达：键入代表指令类型的**特殊字符**即可，这会自动*切换*命令行指令类型，并将输入焦点定位到命令行中。当然用鼠标单击命令行前的*特殊字符框*也可以实现切换。


### 选取（`>`）

在当前选取集范围内检索目标选择器匹配的元素。支持二阶检索选择器：斜线分隔向上和向下选择器，焦点元素为起点。如果没有已选取的元素，则在全局范围（内容区）内检索。

> #### 二阶检索
>
> 这是一种*最近路径*检索法：首先向上查找与目标元素最近的**共同祖先**容器，然后向下检索目标元素。这可以压缩范围以提高效率，同时还可以回避标识名全局唯一性的约束（小范围内唯一即可）。
>
> 二阶检索需要存在**起点元素**，即从一个起点元素查找另一个元素，类似于相对路径的逻辑。通常应用在一个元素的事件处理器中（以当前元素为起点）。
>
> 二阶检索通过*二阶选择器*来实现，格式：`Up-selector/Down-selector`
>
> 1. `Up-selector`：从起点元素向上检索共同祖先的 `CSS` 选择器。也可以是数字，表示上升的DOM层级。
> 2. `Down-selector`：当向上抵达共同祖先节点后，向下检索目标的 `CSS` 选择器。
>
> 示例：
>
> - `/`：单独的斜线分隔符表示起点元素自身。同：`0/`。
> - `2/`：祖父元素自身（父元素的父元素）。
> - `form/input`：当前表单内的首个<input>元素。
> - `.abc`：整个文档（`document`）内类名为 `abc` 的元素。没有斜线分隔视为普通的 `CSS` 选择器。
> - `/#xyz`：起点元素内id为 `xyz` 的元素。即便其它地方存在同名的id，也会正常检索到目标。


### 过滤（`|`）

以当前选取集为总集，过滤出目标元素集。支持*选择器*、*数组定位*以及*过滤函数*的筛选形式。

- `String`：普通CSS选择器。
- `[n:m]`：冒号分隔的数组下标范围（空格可选），如：`[5:10]`、`[5:]` 等。
- `[x,y,z]`：数组下标定位选取，如：`[0,3,4]`。
- `{function}`：花括号包围的过滤函数。通常应当使用箭头函数。


### 搜索（`/`）

对已选取的集合执行文本搜索，并把结果标记为特殊的 `<mark>` 元素。如果当前无选取，则以内容区为范围。

文本搜索以*文本节点*为上下文，因此跨节点的文本无法组词。如果必要，你可以执行一次节点合并操作（`Alt+Z`），以避免无意中断开了连续的文本。这种简化有它的合理性：既然文本被断开了，它们就不应当成为一个*词组*。

搜索词默认为字符串，容错引号包围。同时也支持正则表达。

- `Hello`：普通文本，回车后执行检索。键入 `'Hello'` 也效果相同。
- `abc/xyz/ok`：普通文本，文本内的斜线只是普通字符。
- `"/[a-z]/i"`：字符串包围的普通文本。这也是搜索正则表达式本身的方式。

- `/[0-9a-f]/i`：正则表达式，由前置的 `/` 标示出来。
- `/[0-9a-f]+`：缺少结尾的 `/`，视为一个普通的字符串。
- `/[\w.$-]+/`：合法的正则表达式。
- `/[0-9a-f]/ `：搜索词中的空格不会被自动清除，因此这不是一个合法的正则表达式。

**提示**：并不能在搜索表达式中直接使用替换，如果需要，可以在命令模式下执行 `replace` 指令来实现。


### 命令（`:`）

支持几个基本的工具命令：

- `plug-ins`：插件安装。
- `plug-del`：插件移除。
- `help`：开启帮助窗口并定位到指定的关键字条目。
- `config`：显示&设置系统配置。
- `replace`：替换选取集文本，仅适用内容元素。两个实参时用法参考 `String.replace()`。


### 计算（`=`）

用户的输入会直接在顶层（**window**）执行，用户需要注意代码的*安全性*，*不应当*在表达式中修改DOM树结构！



## 其它

### 表格的容错编辑

通过特性编辑面板，用户可以修改表格单元格的 `rowspan` 和 `colspan` 特性，因此对于了解HTML的用户来说，他们可以自由构建不规整的表格结构。编辑器不阻止用户*删除*或*插入*独立的单元格。

这种能力是用户自己的，如果克隆表格行（`<tr>`），编辑器并不会检查单元格的这两个特性值。


### 兼容性依赖

修订模式下需要浏览器的 `document.execCommand` 支持，以实现从外部插入内容时，可以直接沿用浏览器自身的**Undo**和**Redo**功能。这简化了编码复杂性。