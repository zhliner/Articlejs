# 操作规则

行块编辑和行内内容编辑分成两种不同的逻辑。


## 行块编辑

仅限于操作模式之下，文本内容不可编辑（非 `contenteditable`）。

### 数据源

- **内容元素**：可直接包含文本的元素，有**行块**和**内联**两种类型。如果需要转换，通常前者取内容，后者取元素本身。
- **结构元素**：不能直接包含文本，有固定子元素结构的容器元素。这里的子元素结构包括本设计中的内容结构（如 `section/h2...` 等）。


#### 内容元素

- 数据源为内联元素时：如果目标是行块内容元素，数据取元素自身（`outerHTML`），如果目标也是内联元素时，取文本内容（`textContent`）合并。
- 数据源为行块元素时：如果目标是行块内容元素，数据取元素源码（`innerHTML`），如果目标是内联元素时，取文本内容（`textContent`）合并。


### 编辑操作

- **复制**：源可以是内容单元或普通的内容元素，也可以是结构单元。前者执行内容匹配，后者执行相等匹配。开启键：`C` 或 `Ctrl + C`。
- **剪切**：规则同复制。如果是同级间剪切/粘贴，可以用移动操作，支持数字距离定位。开启键：`X` 或 `Ctrl + X`。
- **粘贴**：目标参考可以任意内容类型，容器类参考插入**容器内末尾**，非容器类参考插入**之前**（`Enter`）或**之后**（`Shift + Enter`）。
- **删除**：操作默认会清除内容块的内容而不是内容块本身，**强删除**才会删除内容块自身（如 `Shift + Del` 键）。
- **移动**：限于相同父容器内的兄弟元素之间。按 `Ctrl + ↑` 向前（`prev`）移动，按 `Ctrl + ↑` 向后（`next`）移动。支持数字指定移动距离。
- **升级**：片区单元（`S2` ~ `S5`）可以从低阶向高阶升级。通过按 `Ctrl + ←` 组合键提升一级，提升后插入之前父级单元之前。此操作只能逐级提升。
- **降级**：片区单元（`S1` ~ `S4`）可以从高阶向低阶降级。通过按 `Ctrl + →` 组合键降低一级，降低后插入到原后续单元之内前端，如果并无后续单元，则不能降级（无接收单元）。
- **转级**：片区单元的层级可以任意转换（多级升降），但只能通过粘贴的方式转换到目标处的层级。目标位置不能是自身的子级，但可以是父级（抽取提升到父级之前）。

> **注：**<br>
> 源数据在选取时，如果是多个成员，应友好提示成员是否同类（警告色）。<br>
> 用鼠标寻找粘贴位置时，鼠标移动时即提供反馈：如有效则显示框线（3边绿，插入边红+粗）。定位目标后需按 `Enter` 确认（因此之前还可以移动选取）。<br>
> 辅助键 `Shift` 用于当前功能增强（如扩展选取），`Ctrl` 用于实现有所关联但更有区别的功能（如上面的移动）。<br>


### 内容匹配

源数据为内容单元（`CONITEM`）或内容元素（`TEXTBOX`）。参考目标可以为任意内容类型（容器类和非容器类）。


#### 源：内容单元

- 目标：非容器类型：如果类型相同，简单插入即可，否则执行简单转换（克隆一个空目标，提取源最终内容填充）。
- 目标：容器类型：测试内容单元是否为容器的合法子类型，是则简单插入（末尾），否则新建一个子单元，提取源最终内容填充。

> **最终内容：**<br>
> 指元素所包含的全部子孙级内容元素（`INLBOX`）的源码集（**注**：首先到达行块级内容元素，取 `innerHTML` 即可）。

**特例**：级联表的单独处理

- 目标为 `<ol>`：源为 `<ol>` 或 `<ul>` 时，类型相同（`CONITEM`），但不是简单插入，而是列表项合并。
- 目标为 `<li>`：非容器类型，克隆一个目标空元素。源为列表时创建 `<ol>` 列表插入，否则插入多个 `<li>` 元素。


#### 源：内容元素

- 目标：非容器类型：克隆一个目标空元素，提取源内容元素的源码填充。
- 目标：容器类型：创建容器的一个合法子单元，提取源内容元素的源码填充（取值规则同上）。


### 相等匹配

源数据为结构性元素，但不是包含完整内部结构的**内容单元**（如 `<tbody>`, `<tr>`）。目标位置的元素必须与源数据类型完全相同。

**注**：不检查目标位置是否可以容纳多个该单元（如 `<thead>`），这交由用户自己处理（删除多余）。


#### 特例：tr => tr

- 以目标行的列数为基准，超出时合并到末端单元格，不足时添加空单元格。
- 实现为目标行的克隆，然后填充覆盖单元格内容，因此源单元格的标签可以忽略（`<th>|<td>` 兼容）。

> **注：**<br>
> 因为是插入到参考行前端，所以插入内容行时不会选择到标题行（`<tr><th>`），除非是明确需要两个标题行。这种操作友好。



## 行内编辑

内容元素的 `contenteditable` 属性被设置为 `true`，此时进入行内编辑模式。编辑范围严格受限于容器元素之内，浏览器自带文本编辑功能（如 `Undo` 和 `Redo` 等）。

因为范围狭小，视觉集中，这被规划为一种**微编辑**，用于简单的小型修订，因此操作行为也被简单化设计：不允许 `Enter` 回车创建新行（`Enter` 被用于确认并退出编辑，`Shift+Enter` 可创建行内 `<br>`）。

> **注：**<br>
> 鼠标双击可进入单击点所在内容元素的微编辑。因为鼠标的每次点击都会被记录位置，所以光标可以定位到单击点位置。<br>
> 快捷键 `Ctrl+Enter` 也可以从普通模式进入到微编辑模式，如果鼠标最后点选的位置在元素内，定位光标到该位置，否则光标置于末尾。<br>
> 另外还有 `I` 键（`Insert`）也可进入微编辑，光标定位与 `Ctrl+Enter` 类似，但鼠标位置无效时光标在行首（而不是末尾）。<br>


## 内容添加

不同的单元显示不同的录入控件，携带相应的结构逻辑。控件的布局和显示应当友好顺手，不干扰版面。


## 选取操作

普通的控制模式下除了鼠标的移动点选，还支持键盘对选取的移动操作。除了直接使用方向键，默认也支持Vim的传统方向键。

移动分为两个维度：

- **纵向**：DOM树的深度方向，即父子层级方向。
- **横向**：DOM树的同级方向，即兄弟元素方向。

- `H: ←` 纵向移动，向父级提升。
- `J: ↓`  横向移动，选取后一（`next`）兄弟元素。
- `K: ↑`  横向移动，选取前一（`prev`）兄弟元素。
- `L: →` 纵向移动，选取首个子元素。


### 扩展选取

选取可以扩展到多个元素。扩展的起点为当前焦点元素，根据配置的功能键或方向键进行不同类型/方向的选取扩展。

键盘快捷键的选取扩展仅限于当前焦点元素的**同级**兄弟元素之间。

- `E`: 相同标签类型扩展。焦点不变。
- `A`: 全部兄弟元素选取。焦点不变。
- `R`: 同级反选（针对当前层级的已选取集）。焦点不变。
- `Shift+↓`: 向后（`next`）扩展，支持数字指定扩展数量。焦点移动到最后一个选取元素。
- `Shift+↑`: 向前（`prev`）扩展，支持数字指定扩展数量。焦点移动同上。
- `Q`: 取消选取（全部，同ESC）。
- `T`: 选取当前焦点元素所属的单元根，焦点元素转为单元根。这实际上是一种选取压缩，单元内单独的选取都会被移除（去除冗余）。
