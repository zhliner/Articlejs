# 操作规则

与普通的编辑器有所不同，此编辑器有两种操作模式：

1. 键盘友好的 **普通模式**。除了从主面板插入各种内容外，可以通过快捷键执行各种操作：选取、复制、移动等。
2. 执行小量内容修改的**修订模式**。这是通过设置内容元素的 `contenteditable` 特性使得元素可编辑，适用于微量修改（有时也称为 **微编辑模式**）。

兼顾编辑的便捷性，修订模式下支持简单的创建新行的能力。


## 普通模式

编辑器初始即处于普通模式，普通模式下无法对文本进行编辑，但可以对内容进行各种控制类操作，此时的状态也称为 **控制态**。某些操作会导致编辑器转入其它状态，比如复制/移动开启之后的 **临时态**。

- **选取**：鼠标单击选取目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。
- **复制**：将选取集元素克隆并插入到目标位置。目标位置由一个目标元素表达，指该元素之前或之后。复制会开启临时态，启动键通常为 `c`（可定制）。
- **移动**：将选取集移动到目标位置。同样会开启临时态，启动键默认为 `m`。另外，如果复制/移动是在兄弟元素之间，有更直接的操作方式，无需进入临时态。
- **删除**：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（比如选取的是 `<tbody>` 元素）。完整的单元才会被整体删除。
- **录入**：从编辑器下方的主面板可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。


### 焦点元素

选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。

但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是 **当前正在或需要被操作的目标**，它与浏览器文档节点树上的元素焦点无关。焦点之下的元素即是焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。

为了与浏览器节点树上的元素焦点概念相区别，这里我们称之为 **选取焦点**。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 `hjkl`）移动。移动分为两个维度：

- **平级/横向**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间跨层移动。

方向键含义：（注：参考HTML源码的呈现逻辑）

- `↓`：  横向移动，定位到下一个（`next`）兄弟元素。也可用 `j` 键。
- `↑`：  横向移动，定位到前一个（`prev`）兄弟元素。也可用 `k` 键。
- `←`： 纵向移动，定位到父元素（**父级方向**）。也可用 `h` 键。
- `→`： 纵向移动，定位到首个子元素（**子级方向**）。也可用 `l` 键。

> **注：数字距离支持**<br>
> 焦点移动支持数字指定移动距离。如在移动之前键入数字 `2` 然后按上/下方向键，焦点会移动到该方向的第2个元素（间隔一个元素）。
> `0` 是一个特殊值，指该方向上的末端元素。值 `1` 没有意义，因为这是默认的移动距离。
> 沿节点树的纵向方向也支持数字距离，表示跨越的层级数，子级方向取首个子元素递进。`0` 值的含义相同，超出实际层级数的值与 `0` 值效果相同。


### 元素选取

鼠标单击目标元素即可选取，此时为单选方式（会取消之前的已选取）。如果在单击的时候按住 `Ctrl` 键，则可以实现多选，同时这也是切换选取的逻辑。

在鼠标选取元素的基础上，我们可以通过键盘实现更多的选取逻辑。**注**：下面的键位定义只是默认值，用户可以修改配置。


#### 键盘选取

通过箭头键，我们可以把选取焦点定位到任意一个元素上，此时有如下键位功能定义：

- `Space | Enter` 执行选取或取消选取（类似 `Ctrl + 单击`）。
- `Ctrl + 箭头键` 移动焦点的同时单选目标元素（类似简单单击）。


#### 选取扩展

选取扩展是一种快捷的多选行为。以当前焦点元素为参考，使用简单的键位即可扩展选取。

- `a`: 选取全部兄弟元素。
- `e`: 选取相同标签类型的兄弟元素（含自身）。
- `Shift + e`: 选取所属行块父容器下的相同标签类型元素（即范围扩展到所属行块的全部兄弟行块）。
- `v`: 同级反选。对焦点元素所在层级的已选取集反选（已选取的取消选取，未选取的选取）。
- `ESC` 取消全部选取元素。
- `q`: 取消焦点元素所在层级全部已选取元素。
- `Shift+↓`: 向后（`next`）扩展并移动焦点：选取或取消选取下一个兄弟元素（与焦点元素状态相同），支持数字指定扩展距离。
- `Shift+↑`: 向前（`prev`）扩展并移动焦点。选取或取消选取前一个兄弟元素，支持数字指定扩展距离。

另外有一个特殊的纵向选取扩展：

- `t`: 选取焦点元素的上层根（`Top`）：如果是内联元素，选取所属内容行，如果焦点已是行块元素，选取其结构根（即内容单元）。焦点会转移到该根元素，同时其内部原有的任何选取会被取消（清除冗余）。


### 便捷操作

用单个键位即可执行各种控制，默认的键位定义如下：


#### 普通控制

- `d`: 删除已选取集。删除行为有行块单元和内联元素的区分（见前述）。
- `D`: 删除已选取集元素本身，不区分是否行块或内联元素（**注**：编辑器的逻辑里用户应当有这样的权利）。
- `u`: 撤消（`Undo`）。
- `r`: 重做（`Redo`）。
- `m`: 合并已选取集。以首个选取单元为目标，移动其它选取单元的内容追加。内容被提取的元素可能被清空（结构性元素）或被移除（内容元素）。
- `n`: 插入新内容。显示关联面板的录入版（如果已隐藏）并聚焦。
- `s`: 本地（浏览器）暂存。
- `o`: 打开外部输入框（如导入 markdown 格式文档）。
- `p`: 打开单元属性定义框（部分元素修改 `role` 属性可转换内容类型）。
- `P`: 打开输出/导出对话框（导出/下载）。
- `z`: 显示关联帮助（状态栏右侧）。
- `g`: 章节跳转（仅限 `s1`）。位置由之前的数字键入指定。
- `G`: 章节跳转（完整）。显示输入框获取定位路径，区分子片区（章.节.区.段.末）。


#### 进入临时态

- `c`: 已选取集：复制准备。
- `x`: 已选取集：剪切/移动准备。如果为鼠标点选目标位置则为剪切，若为键盘定位目标则为分别移动。
- `X`: 同级已选取集：移动准备。仅支持键盘定位目标位置，同级已选取集作为一个整体，分别移动。


#### 进入微编辑

每次仅执行**单个**内容元素的微编辑，如果当前焦点元素不是内容元素，则向内递进到首个内容元素。通过按 `Tab` 键，可以在选取集内的内容元素间逐个**退出/进入**微编辑。

- `i/I`: 进入微编辑，光标定位到前端或末端。
- `Alt + 单击`: 进入微编辑，光标定位到单击点位置（如果有效）。
- `双击`: 同上。
- `Tab`: 确认并退出上一个选取的内容元素的微编辑，进入当前内容元素的微编辑。


#### 关联面板

新建单元内容时显示的录入面板与当前焦点元素相关联，不同的参考元素类型能够插入的内容是有区别的。

关联面板有2个位置选项：**平级** 和 **向内**，其中 **向内** 包含了3种方式：`prepend|append|fill`。因为结构性单元有固定的元素位置规则，所以不同位置选项卡中显示的可插入内容也会稍有不同。这是系统自动判断的，这也是维护内容单元结构合法的措施之一。

出于编辑器必要灵活性的考虑，固定位置单元可以被移动，但插入新的唯一性固定单元并不自由，这通常需要原来的固定单元被移除之后才行。


### 附：剪贴板与数据源

#### 剪贴板

- **复制**：普通模式下支持选取集元素的剪贴板复制，复制内容为纯文本，多个成员的值用换行符分隔。这样，复制值就可以简单地用于多目标操作了。
- **粘贴**：支持剪贴板内容的粘贴，对选取目标执行填充操作，如果目标是多个且剪贴板内容由换行符分隔有多个条目，则为一一对应填充（不足者忽略）。**注**：仅取纯文本。


#### 数据源

任何元素都可以成为复制/剪切的数据源，当它们被粘贴到目标位置时，并不是简单地将元素本身复制或移动过去，因为目标位置的内容有它自己的结构。

如果数据源元素在目标位置可以成为合法结构的一部分，它们会被简单地克隆或移动，否则就会执行转换。基本的转换规则是：行块级源元素会提取其最深层**内容行**的内容节点（文本或内联元素），而内联元素会直接取元素本身。


### 临时态

由普通模式下键入特定的键位开启，实现对已选取集进行粘贴插入操作。

目标位置的选取可用鼠标单击，或箭头移动焦点的方式获得。当然鼠标单击之后也可以再用键盘移动焦点。**注**：`Ctrl + 箭头键` 会直接移动/复制到目标位置。

- `i/I`: 粘贴插入。插入目标参考元素之前/内部前端。同时退出临时态。
- `v/V`: 同上。
- `p/P`: 粘贴添加。插入目标参考元素之后/内部末尾。同时退出临时态。
- `r/R`: 粘贴替换/填充。替换与插入后删除效果相同，填充对于结构化单元较为智能。同时退出临时态。
- `q/ESC`: 取消并退出临时态。

> **友好：**<br>
> 如果参考目标为单标签元素（如 `<img>`），`I/P/R` 不可用。<br>
> 插入参考元素内部时会根据元素类型执行必要的转换（内部非仅指直接子元素）。<br>

样式面板中单击**格式刷**也会进入临时态。


## 录入面板

可从内容面板中录入内容，不同的单元显示各自的录入控件，拥有自身特有的结构。
这是一种就近关联的交互设计，简化界面而又需求直达。

**友好性**：在 `<textarea>` 中输入内容时，可以：

- 按 `Alt+F` 切换录入框最大化（占满面板）。
- 按 `Ctrl+Enter` 直接提交（保持最大化不变）。
- 按 `Alt+Enter` 提交并切换录入框最大化（退出/占满）。


## 修订模式

内容元素的 `contenteditable` 属性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内，仅用于简单的文本修订。

此模式中 `Enter` 键被严格限定，以避免不同浏览器的不同行为。

- `Enter` 确认并退出微编辑。
- `Shift+Enter` 插入一个换行元素 `<br>` 或换行字符 `\n`（在`<pre>` 中时）。
- `Ctrl+Enter` 创建一个同类新行，光标在新行开头。
- `Ctrl+Shift+Enter` 创建一个克隆新行，光标在新行相同下标位置处。
- `Alt+Enter` 创建一个逻辑新行，如：`dt > dd` 或 `<tr>/<td|th>`。
- `Alt+Shift+Enter` 创建一个克隆逻辑新行，内容相同但元素可能不同，光标位于相同下标位置。
- `Tab` 功能同 `Enter`，但同时进入下一个选取元素的微编辑（如果有）。
- `ESC` 取消当前修订并退出微编辑。

> **注记：**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 内的微编辑提交后，由浏览器插入的换行元素 `<br>` 应被替换为换行字符 `\n`。<br>
> 无论新行是克隆或新建，原行应当确认并退出微编辑（小修订逻辑并鼓励用面板录入）。<br>


### 代码元素

对于普通的内容元素，进入微编辑后内容会原样保持（如内联的 `<strong>` 等）。但对于代码，会清除语法标注单元 `<b>`（即仅取 `textContent`），确认提交时会重新解析语法并标注。


### 光标行移动

在进入微编辑的多个单元行中，可以通过上下箭头键切换相邻的行（已按DOM排序），且光标保持相同下标（如果可能）。

1. 光标已经抵达元素内顶行/底行时，再按上/下箭头键即切换。
2. `Ctrl+箭头` 键可直接切换到目标行，保持光标的合理位置。


## 其它

### 路径导航

内容区的底部会实时展示当前选取集末尾元素的DOM路径，它主要由元素的标签名构成（前置层级序号）。

鼠标单击某一目标会移动焦点到该位置的元素，之后若按 `Space` 会选中，路径信息会被重构。

> **专业版：**<br>
> `Ctrl+单击` 会移动焦点的同时展开目标位置元素兄弟元素的信息。这些信息是有序的，目标元素位置高亮置空。<br>
> 这仅是便于用户了解内容的HTML结构，方便相对ID的定位构造（`OBT` 需求）。<br>



## 注记

### 单元移动/转换

- 同级兄弟元素间可自由移动，但不能跨越固定性单元。固定性单元自身可移动。
- 跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。


### 内容提升

片区与内容区为互斥逻辑，但编辑器提供容错以便于用户操作。

因此，工具栏的内容提升（去标签）按钮除了支持内联单元外，还需要特别支持片区单元。


### 表格的容错编辑

用户可以自由修改单元格的 `rowspan` 和 `colspan` 属性值，因此也不阻止用户删除/插入独立的单元格。这为用户构造非规整的表格提供灵活性。

但如果用户对表格行（`<tr>`）进行操作，系统并不检查单元格是否存在合并，只是简单参考表格的 `$.Table` 实例的列头和列数进行处理。因此如果用户需要构造非行列规整的表格，需要自行理解和处理 `rowspan/colspan` 两个属性。
