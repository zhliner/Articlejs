# 操作规则

行块编辑和行内内容编辑分成两种不同的逻辑。


## 行块编辑

仅限于操作模式之下，文本内容不可编辑（非 `contenteditable`）。

### 数据源

- **内容元素**：可直接包含文本的元素，有**行块**和**内联**两种类型。如果需要转换，通常前者取内容，后者取元素本身。
- **结构元素**：不能直接包含文本，有固定子元素结构的容器元素。这里的子元素结构包括本设计中的内容结构（如 `section/h2...` 等）。


#### 内容元素

- 数据源为内联元素时：如果目标是行块内容元素，数据取元素自身（`outerHTML`），如果目标也是内联元素时，取文本内容（`textContent`）合并。
- 数据源为行块元素时：如果目标是行块内容元素，数据取元素源码（`innerHTML`），如果目标是内联元素时，取文本内容（`textContent`）合并。


### 编辑操作

- **复制**：源可以是内容单元或普通的内容元素，也可以是结构单元。前者执行内容匹配，后者执行相等匹配。开启键：`C` 或 `Ctrl + C`。
- **剪切**：规则同复制。如果是同级间剪切/粘贴，可以用移动操作，支持数字距离定位。开启键：`X` 或 `Ctrl + X`。
- **粘贴**：目标参考可以任意内容类型，容器类参考插入**容器内末尾**，非容器类参考插入**之前**（`Enter`）或**之后**（`Shift + Enter`）。
- **删除**：操作默认会清除内容块的内容而不是内容块本身，**强删除**才会删除内容块自身（如 `Shift + Del` 键）。
- **移动**：限于相同父容器内的兄弟元素之间。按 `Ctrl + ↑` 向前（`prev`）移动，按 `Ctrl + ↑` 向后（`next`）移动。支持数字指定移动距离。
- **升级**：片区单元（`S2` ~ `S5`）可以从低阶向高阶升级。通过按 `Ctrl + ←` 组合键提升一级，提升后插入之前父级单元之前。此操作只能逐级提升。
- **降级**：片区单元（`S1` ~ `S4`）可以从高阶向低阶降级。通过按 `Ctrl + →` 组合键降低一级，降低后插入到原后续单元之内前端，如果并无后续单元，则不能降级（无接收单元）。
- **转级**：片区单元的层级可以任意转换（多级升降），但只能通过粘贴的方式转换到目标处的层级。目标位置不能是自身的子级，但可以是父级（抽取提升到父级之前）。

> **注：**<br>
> 源数据在选取时，如果是多个成员，应友好提示成员是否同类（警告色）。<br>
> 用鼠标寻找粘贴位置时，鼠标移动时即提供反馈：如有效则显示框线（3边绿，插入边红+粗）。定位目标后需按 `Enter` 确认（因此之前还可以移动选取）。<br>
> 辅助键 `Shift` 用于当前功能增强（如扩展选取），`Ctrl` 用于实现有所关联但更有区别的功能（如上面的移动）。<br>


### 内容匹配

源数据为内容单元（`CONITEM`）或内容元素（`TEXTBOX`）。参考目标可以为任意内容类型（容器类和非容器类）。


#### 源：内容单元

- 目标：非容器类型：如果类型相同，简单插入即可，否则执行简单转换（克隆一个空目标，提取源最终内容填充）。
- 目标：容器类型：测试内容单元是否为容器的合法子类型，是则简单插入（末尾），否则新建一个子单元，提取源最终内容填充。

> **最终内容：**<br>
> 指元素所包含的全部子孙级内容元素（`INLBOX`）的源码集（**注**：首先到达行块级内容元素，取 `innerHTML` 即可）。

**特例**：级联表的单独处理

- 目标为 `<ol>`：源为 `<ol>` 或 `<ul>` 时，类型相同（`CONITEM`），但不是简单插入，而是列表项合并。
- 目标为 `<li>`：非容器类型，克隆一个目标空元素。源为列表时创建 `<ol>` 列表插入，否则插入多个 `<li>` 元素。


#### 源：内容元素

- 目标：非容器类型：克隆一个目标空元素，提取源内容元素的源码填充。
- 目标：容器类型：创建容器的一个合法子单元，提取源内容元素的源码填充（取值规则同上）。


### 相等匹配

源数据为结构性元素，但不是包含完整内部结构的**内容单元**（如 `<tbody>`, `<tr>`）。目标位置的元素必须与源数据类型完全相同。

**注**：不检查目标位置是否可以容纳多个该单元（如 `<thead>`），这交由用户自己处理（删除多余）。


#### 特例：tr => tr

- 以目标行的列数为基准，超出时合并到末端单元格，不足时添加空单元格。
- 实现为目标行的克隆，然后填充覆盖单元格内容，因此源单元格的标签可以忽略（`<th>|<td>` 兼容）。

> **注：**<br>
> 因为是插入到参考行前端，所以插入内容行时不会选择到标题行（`<tr><th>`），除非是明确需要两个标题行。这种操作友好。



## 行内编辑

内容元素的 `contenteditable` 属性被设置为 `true`，此时进入行内编辑模式。编辑范围严格受限于容器元素之内，浏览器自带文本编辑功能（如 `Undo` 和 `Redo` 等）。

因为范围狭小，视觉集中，这被规划为一种**微编辑**，用于简单的小型修订，因此操作行为也被简单化设计：不允许 `Enter` 回车创建新行（`Enter` 被用于确认并退出编辑，`Shift+Enter` 可创建行内 `<br>`）。

> **注：**<br>
> 鼠标双击可进入单击点所在内容元素的微编辑。因为鼠标的每次点击都会被记录位置，所以光标可以定位到单击点位置。<br>
> 快捷键 `Ctrl+Enter` 也可以从普通模式进入到微编辑模式，如果鼠标最后点选的位置在元素内，定位光标到该位置，否则光标置于末尾。<br>
> 另外还有 `I` 键（`Insert`）也可进入微编辑，光标定位与 `Ctrl+Enter` 类似，但鼠标位置无效时光标在行首（而不是末尾）。<br>


## 内容添加

不同的单元显示不同的录入控件，携带相应的结构逻辑。控件的布局和显示应当友好顺手，不干扰版面。


## 操作模式

类似于Vim编辑器的状态模式设计，这里的文档编辑也有三种状态：**控制态**（普通模式）、**临时态**（编辑模式），以及源于元素 `contenteditable` 属性自带的**微编辑态**下的修订模式。

> **注：**
> 各个不同的模式下键盘快捷键的定义是独立的（互不影响）。


### 焦点与移动

鼠标单击目标元素即可选中，被选中的元素拥有焦点，这种焦点称为**选取焦点**。选取焦点与元素自身的焦点并不完全相同，实际上这是两个不同的概念。

选取焦点可以通过键盘的功能键位移动，功能键可配置，默认是箭头键、以及实施箭头功能的其它键位（如 Vim 中使用的 `hjkl` 键）。

焦点移动分为两个维度：

- **纵向**：DOM树的深度方向，即父子层级方向。
- **横向**：DOM树的同级方向，即兄弟元素方向。

默认的箭头移动行为（支持数字指定距离）：

- `h: ←` 纵向移动（向父级提升）。定位到父元素。移动前键入数字可指定移动距离，默认值 `1`，即父元素。最高可抵达文档根元素（`<html>`）。
- `j: ↓`  横向移动，定位到后一个（`next`）兄弟元素。同上支持数字指定距离，`1` 为下一个兄弟元素。
- `k: ↑`  横向移动，定位到前一个（`prev`）兄弟元素。同上支持数字距离，`1` 为前一个兄弟元素。
- `l: →` 纵向移动（向子级收缩）。定位到首个子元素。同上支持数字距离，按首个子元素递进，超出的层级数被忽略。


### 普通模式（控制态）

此为控制状态，因为与编辑态分离，所以键盘并不用于文本输入，而是可以执行各种功能。


#### 简单选取

- 鼠标单击目标元素即可选取，但此为排他性选取，其它已选取元素会被全部取消。`Ctrl + 单击` 为增加选取，不会取消其它已选取。
- 拥有选取焦点的元素不一定是已选取状态，`Enter` 键用于确认和切换选取：按一次选取，再按一次则取消选取。


#### 选取移动

从拥有选取焦点的元素开始，通过箭头键可以移动焦点，如果在移动焦点的同时按住 `Ctrl` 键，则可以同时选取（即自动 `Enter`）。
选取移动后，原来的选取会取消（近似于也执行了一次 `Enter`，但仅取消）。


#### 选取扩展

以当前焦点元素为起点，用特定的键位进行选取扩展可选取更多或更少的元素。扩展操作仅限于焦点元素所在**同级**兄弟元素的范围。

- `a`: 选取全部兄弟元素。焦点不变。
- `e`: 相同标签类型扩展。与焦点元素标签相同的兄弟元素，选取或取消选取，与焦点元素状态相同。焦点不变。
- `v`: 同级反选。针对当前层级的已选取集反选，与焦点元素状态无关。焦点不变。
- `t`: 选取焦点元素所在内容根（最近的，兄弟节点不能是文本的元素）或结构根元素（完整的内容单元）。焦点转到根元素。
- `Shift+↓`: 向后（`next`）扩展。设置下一个兄弟元素与焦点元素状态相同（选取或取消选取），支持数字指定扩展距离。焦点移动到最后扩展的元素。
- `Shift+↑`: 向前（`prev`）扩展。行为与上面类似，但方向相反。
- `q`: 取消当前同级选取。**注**：`ESC` 为取消全部选取。


#### 功能控制

用单个键位即可执行多种控制功能。默认的键位定义如下：


**进入编辑模式**

- `c/y`: 复制已选取集。同时进入临时态的编辑模式。
- `x/m`: 剪切/移动已选取集。同时进入临时态的编辑模式。


**普通控制**

- `d`: 删除已选取集。根/行会删除元素自身，结构性单元仅删除内容实体（文本和内联单元）。
- `D`: 强制删除已选取的目标元素（包括中间结构单元）！
- `u`: 撤消（`Undo`）
- `r`: 重做（`Redo`）。
- `n`: 插入新内容。显示关联面板。
- `N`: 隐藏插入内容面板（焦点在主页区或面板本身时）。**注**：`F4` 同此。
- `s`: 本地（浏览器）暂存。
- `o`: 打开外部输入框（如导入 markdown 格式文档）。
- `p`: 打开单元属性定义框，修改 `role` 属性可转换内容类型）。
- `P`: 打开输出/导出对话框，可导出/下载完整格式文档。
- `z`: 显示关联帮助（底栏右/框）。
- `g`: 章节跳转（视图）。会显示定位路径输入框。
- `[n]`: 1-9单数字定位跳转，支持快速多数字定义章节路径（纵向）。


**进入修订模式**

- i/I: 进入微编辑态，光标定位到单击点位置或前端/强制前端。
- Ctrl + Enter: 进入微编辑态，光标定位到点击点位置或末尾（如果点击点位置无效）。


### 编辑模式（临时态）

对已选取集进行粘贴插入操作，目标位置的选取可用鼠标单击或键位（箭头键）移动焦点的方式进行。

- `i/I`: 粘贴。插入目标参考因素之前/内部前端。同时退出临时态。
- `v/V`: 同上。
- `p/P`: 粘贴。插入目标参考元素之后/内部末尾。同时退出临时态。
- `r`:   粘贴。替换目标元素，如果目标不可替换则为转换填充。同时退出临时态。
- `q/ESC`: 取消并退出临时态。

> **友好：**<br>
> 如果目标为单标签元素（如 `<img>`），粘贴时 `I/P` 和 `r` 的行为相同。


### 修订模式（微编辑）

即打开了元素的可编辑属性（`contenteditable`），用户可以简单修订元素的内容。此时的编辑为传统的文本编辑逻辑，键盘输入为文本表达。

该模式下仅有两个功能键位：

- `Enter`: 确认修订并退出微编辑态。
- `ESC`: 取消当前修订，退出微编辑态。
