# 操作规则

与普通的编辑器有所不同，此编辑器有两种操作模式：

1. 键盘友好的 **普通模式**。除了从主面板插入各种内容外，可以通过快捷键执行各种操作：选取、复制、移动等。
2. 执行小量内容修改的**修订模式**。这是通过设置内容元素的 `contenteditable` 特性使得元素可编辑，适用于微量修改（有时也称为 **微编辑模式**）。

兼顾编辑的便捷性，修订模式下支持简单的创建新行的能力。


## 普通模式

编辑器初始即处于普通模式，普通模式下无法对文本进行编辑，但可以对内容进行各种控制类操作，此时的状态也称为 **控制态**。某些操作会导致编辑器转入其它状态，比如克隆/移动开启之后的 **临时态**。

- **选取**：鼠标单击选取目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。
- **克隆**：将选取集元素克隆并插入到目标位置。目标位置由一个目标元素表达，指该元素之前或之后。克隆会开启临时态，启动键通常为 `c`（可定制）。
- **移动**：将选取集移动到目标位置。同样会开启临时态，启动键默认为 `m`。**另外**：如果克隆/移动是在兄弟元素之间，有更直接的操作方式，无需进入临时态。
- **删除**：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（比如选取的是 `<tbody>` 元素）。完整的单元才会被整体删除。
- **录入**：从编辑器下方的主面板可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。


### 焦点元素

选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。

但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是 **当前正在或需要被操作的目标**，它与浏览器文档节点树上的元素焦点无关。焦点之下的元素即是焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。

为了与浏览器节点树上的元素焦点概念相区别，这里我们称之为 **选取焦点**。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 `hjkl`）移动。移动分为两个维度：

- **平级/横向**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间跨层移动。

方向键含义：（注：参考HTML源码的呈现逻辑）

- `↓`：  横向移动，定位到下一个（`next`）兄弟元素。也可用 `j` 键。
- `↑`：  横向移动，定位到前一个（`prev`）兄弟元素。也可用 `k` 键。
- `←`： 纵向移动，定位到父元素（**父级方向**）。也可用 `h` 键。
- `→`： 纵向移动，定位到首个子元素（**子级方向**）。也可用 `l` 键。

> **注：数字距离支持**<br>
> 焦点移动支持数字指定移动距离。如在移动之前键入数字 `2` 然后按上/下方向键，焦点会移动到该方向的第2个元素（间隔一个元素）。
> `0` 是一个特殊值，指该方向上的末端元素。值 `1` 没有意义，因为这是默认的移动距离。
> 沿节点树的纵向方向也支持数字距离，表示跨越的层级数，子级方向取首个子元素递进。`0` 值的含义相同，超出实际层级数的值与 `0` 值效果相同。


### 元素选取

鼠标单击目标元素即可选取，此时为单选方式（会取消之前的已选取）。如果在单击的时候按住 `Ctrl` 键，则可以实现多选，同时这也是切换选取的逻辑。

在鼠标选取元素的基础上，我们可以通过键盘实现更多的选取逻辑。**注**：下面的键位定义只是默认值，用户可以修改配置。


#### 键盘选取

通过箭头键，我们可以把选取焦点定位到任意一个元素上，此时有如下键位功能定义：

- `Space | Enter` 执行选取或取消选取（类似 `Ctrl + 单击`）。
- `Ctrl + 箭头键` 移动焦点的同时单选目标元素（类似简单单击）。


#### 选取扩展

在已经选取的元素的基础上，可以通过简单的键位操作将选取集进行扩展。扩展以当前焦点元素为参考，键位功能定义如下：

- `a`: 选取全部兄弟元素。
- `e`: 选取相同标签名的兄弟元素。
- `Shift + e`: 选取叔伯元素内的相同标签子元素（即兄弟逻辑适用到父元素）。**注**：主要用于选取同层章节内的标题。
- `v`: 同级反选。已选取的取消选取，未选取的则选取。
- `Shift+↓`: 同级向后（`next`）状态扩展，焦点移动到新元素上。状态指选取或取消选取，保持与焦点元素相同。
- `Shift+↑`: 同级向前（`prev`）状态扩展，逻辑同上。
- `t`: 选取单元的**顶**元素（`Top`）：内联单元的顶为其所在内容行元素（**特例**：单元格内的内联单元其顶为单元格，单元格自身的顶为 `<tr>` 元素）。行块结构内的子元素的顶为该行块根本身。
- `q`: 取消同级已选取元素。
- `ESC` 取消整个选取集的选取。


### 功能操作

类似于 `Vim` 编辑器的操作友好性，这里采用单个键位即可执行简单的编辑功能：

- `d`: 删除已选取集。删除行为不破坏结构单元的结构本身。
- `u`: 撤消（Undo）。
- `r`: 重做（Redo）。
- `m`: 合并已选取集。以首个选取单元为目标，移动其余选取单元的 **内容** 追加。
- `n`: 焦点元素关联插入面板的显示快捷键（并聚焦）。
- `s`: 本地暂存（localStorage）。
- `p`: 打开单元属性编辑面板。
- `g`: 章节跳转。如果当前存在数字指示，则仅限于顶层章节，否则显示输入框获取定位路径（句点分隔，如：`3.12.5`）。

另外支持文章内容的导出，由 `Shift + p` 键打开导出对话框。


#### 需要临时态的操作

- `c`: 克隆准备。进入临时态，等待确定克隆到的目标位置。目标位置指目标元素的前后或内部前端或末尾，详细请见后 **临时态** 章节。
- `x`: 移动准备。进入临时态，目标位置逻辑同上。


#### 进入微编辑

对选取集内的元素，按选取的顺序逐个进入每个内容元素进行文本修订。一个结构性单元可能包含多个内容元素，此时即按元素在文档中的自然顺序。

- `i`: 进入微编辑，光标定位到可编辑内容元素的前端。
- `Shift + i`: 进入微编辑，光标定位到可编辑内容元素的末尾。
- `Alt + 单击`: 进入微编辑，光标定位到单击点位置附近（如果位置有效）。
- `双击`: 效果同上。
- `Tab`: 确认当前微编辑，定位到下一个内容元素并进入其微编辑。


#### 系统级复制与剪切

普通模式下支持选取集元素 **复制** 到剪贴板，但内容仅为纯文本，多个内容行元素的内容用换行分隔。**注**：单元格按内容行处理。

支持剪贴板内容 **粘贴** 到选取集元素上，此时执行的是填充操作。如果选取集元素不止一个，且剪贴板内容为多行文本，则为一一对应填充（不足者忽略），纯文本格式。


### 临时态

普通模式下的部分操作会让编辑器处于一种临时状态，以等待进一步的用户行为。这种状态下的键盘操作是独立的（即可与其它状态下的快捷键定义重叠而互不影响）。

通过快捷键启动克隆/移动操作会开启临时态（如前提及），进一步的行为是确定克隆或移动到的目标位置。


#### 单击定位

可通过简单地鼠标单击定位目标元素，然后键入位置选择键完成插入。**注**：位置合法才有效。可参考右下角状态栏信息获得准确目标。

- `i`: 插入目标元素之前。
- `a`: 插入目标元素之后。
- `Shift + i`: 插入目标元素之内的头部。
- `Shift + a`: 插入目标元素之内的末尾。
- `r`: 选取集成员会替换目标元素自身。

完成插入之后，临时态会退出，回到普通模式下的正常状态。


#### 键盘定位

除了用鼠标单击定位外，还可以通过箭头键移动焦点来定位目标元素。因为焦点移动支持数字指定距离，因此这种操作也十分便捷。


#### 格式刷

用户单击样式面板中的 **格式刷** 按钮时也会进入临时态。

因为选取集操作方式的习惯，这里的格式刷逻辑与普通编辑器（如 Word）中的格式刷稍有不同：这里需要先确定（选取）接受格式的目标，然后点击格式刷按钮进入临时态，最后才确定（单击）应用样式的源元素。

> **注：**
> 因为选取元素的方式很灵活，这种操作逻辑更友好和强大。


## 录入面板
?
可从内容面板中录入内容，不同的单元显示各自的录入控件，拥有自身特有的结构。
这是一种就近关联的交互设计，简化界面而又需求直达。

**友好性**：在 `<textarea>` 中输入内容时，可以：

- 按 `Alt+F` 切换录入框最大化（占满面板）。
- 按 `Ctrl+Enter` 直接提交（保持最大化不变）。
- 按 `Alt+Enter` 提交并切换录入框最大化（退出/占满）。


### 内容单元的关联性

新建单元内容时显示的录入面板与当前焦点元素相关联，不同的参考元素类型能够插入的内容是有区别的。

关联面板有2个位置选项：**平级** 和 **向内**，其中 **向内** 包含了3种方式：`prepend|append|fill`。因为结构性单元有固定的元素位置规则，所以不同位置选项卡中显示的可插入内容也会稍有不同。这是系统自动判断的，这也是维护内容单元结构合法的措施之一。

出于编辑器必要灵活性的考虑，固定位置单元可以被移动，但插入新的唯一性固定单元并不自由，这通常需要原来的固定单元被移除之后才行。


## 修订模式

内容元素的 `contenteditable` 属性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内，仅用于简单的文本修订。

此模式中 `Enter` 键被严格限定，以避免不同浏览器的不同行为。

- `Enter` 确认并退出微编辑。
- `Shift+Enter` 插入一个换行元素 `<br>` 或换行字符 `\n`（在`<pre>` 中时）。
- `Ctrl+Enter` 创建一个同类新行，光标在新行开头。
- `Ctrl+Shift+Enter` 创建一个克隆新行，光标在新行相同下标位置处。
- `Alt+Enter` 创建一个逻辑新行，如：`dt > dd` 或 `<tr>/<td|th>`。
- `Alt+Shift+Enter` 创建一个克隆逻辑新行，内容相同但元素可能不同，光标位于相同下标位置。
- `Tab` 功能同 `Enter`，但同时进入下一个选取元素的微编辑（如果有）。
- `ESC` 取消当前修订并退出微编辑。

> **注记：**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 内的微编辑提交后，由浏览器插入的换行元素 `<br>` 应被替换为换行字符 `\n`。<br>
> 无论新行是克隆或新建，原行应当确认并退出微编辑（小修订逻辑并鼓励用面板录入）。<br>


### 代码元素

对于普通的内容元素，进入微编辑后内容会原样保持（如内联的 `<strong>` 等）。但对于代码，会清除语法标注单元 `<b>`（即仅取 `textContent`），确认提交时会重新解析语法并标注。


### 光标行移动

在进入微编辑的多个单元行中，可以通过上下箭头键切换相邻的行（已按DOM排序），且光标保持相同下标（如果可能）。

1. 光标已经抵达元素内顶行/底行时，再按上/下箭头键即切换。
2. `Ctrl+箭头` 键可直接切换到目标行，保持光标的合理位置。


## 其它

### 路径导航

内容区的底部会实时展示当前选取集末尾元素的DOM路径，它主要由元素的标签名构成（前置层级序号）。

鼠标单击某一目标会移动焦点到该位置的元素，之后若按 `Space` 会选中，路径信息会被重构。

> **专业版：**<br>
> `Ctrl+单击` 会移动焦点的同时展开目标位置元素兄弟元素的信息。这些信息是有序的，目标元素位置高亮置空。<br>
> 这仅是便于用户了解内容的HTML结构，方便相对ID的定位构造（`OBT` 需求）。<br>



## 注记

### 单元移动/转换

- 同级兄弟元素间可自由移动，但不能跨越固定性单元。固定性单元自身可移动。
- 跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。


### 内容提升

片区与内容区为互斥逻辑，但编辑器提供容错以便于用户操作。

因此，工具栏的内容提升（去标签）按钮除了支持内联单元外，还需要特别支持片区单元。


### 表格的容错编辑

用户可以自由修改单元格的 `rowspan` 和 `colspan` 属性值，因此也不阻止用户删除/插入独立的单元格。这为用户构造非规整的表格提供灵活性。

但如果用户对表格行（`<tr>`）进行操作，系统并不检查单元格是否存在合并，只是简单参考表格的 `$.Table` 实例的列头和列数进行处理。因此如果用户需要构造非行列规整的表格，需要自行理解和处理 `rowspan/colspan` 两个属性。
