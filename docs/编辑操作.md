# 操作规则

与普通的编辑器不同，本编辑器拥有编辑模式的设计（类似于Vim）。编辑模式主要分为两种，行块编辑的普通模式和文本输入的录入模式。

普通模式仅限于对已有元素进行复制、移动、粘贴等，由很多方便的键位执行各种操作。录入模式则会开启新建面板，插入各种新的内容。

另外还有一种修订模式，它是通过设置元素的 `contenteditable` 属性后，由浏览器自身支持的文本编辑。这种模式因为不易控制源码的生成，所以它仅用于对已有文字的简单修订，通常称为**微编辑**。


## 普通模式

- **复制**：数据源可以是任意元素，粘贴时会根据目标位置的合法元素类型智能取值。默认开启键：`C`。
- **剪切**：规则同复制。如果是同级元素间的剪切操作，实际上和移动效果相同。默认开启键：`X`。
- **粘贴**：用鼠标或键盘定位目标位置（焦点元素），按 `i/I`、`v/V`、`p/P` 等实现不同的粘贴效果（见后）。
- **删除**：内联元素会作为内容实体被删除，行块级单元则只会删除其内容元素里的内容实体（不改变元素结构）。
- **移动**：相同父容器里的同级元素之间可以移动，开启键：`M`。进入移动状态之后：按 `↑` 向前移动（`prev`），`↓` 向后移动（`next`），同时按 `Shift` 可移动到该方向的末端。

> **注：**<br>
> 辅助键 `Shift` 用于当前功能增强，`Ctrl` 用于实现有所关联但更有区别的功能。


### 数据源

任何元素都可以成为复制/剪切的数据源，当它们被粘贴到目标位置时，并不是简单地将元素本身复制或移动过去，因为目标位置的内容有它自己的结构。

如果数据源元素在目标位置可以成为合法结构的一部分，它们会被简单地克隆或移动，否则就会执行转换。基本的转换规则是：行块级源元素会提取其最深层**内容行**的内容节点（文本或内联元素），而内联元素会直接取元素本身。


### 控制态

编辑器初始即处于普通模式，普通模式下可以对文章进行各种控制，这就是**控制态**。当执行某些操作之后，编辑器可能会转换到其它状态，如复制/移动开启之后的**临时态**，以及设置元素 `contenteditable` 之后进入的微编辑态。

> **注：**<br>
> 录入模式并不会让编辑器脱离控制态，相反，它还只能在控制态之下使用（详见后）。


#### 焦点与移动

鼠标单击目标元素即可选中，被选中的元素拥有焦点，这种焦点称为**选取焦点**（下面简称**焦点**）。注意，这种选取焦点并不是DOM中元素的焦点（`tabIndex`）。

选取焦点可以通过键盘的功能键移动，默认是箭头键、以及实施箭头功能的其它友好键位（如Vim中使用的 `hjkl`）。出于操作常用性的考虑，焦点移动的同时，选取也会同时发生。如果你需要单独移动焦点，默认可以通过加按 `Ctrl` 键实现。

焦点的移动分为两个维度：

- **横向**：DOM树的同级方向，即兄弟元素方向。
- **纵向**：DOM树的深度方向，即父子层级方向。

> **注：**<br>
> 焦点移动支持数字指定移动距离。比如在移动之前键入数字 `6`，然后按方向键，焦点将移动到该方向的第 `6` 个元素。

方向键功能：

- `↓`：  横向移动，定位到后一个（`next`）兄弟元素。数字距离 `1` 指下一个兄弟元素，`0` 值特殊，指最后一个兄弟元素（末尾）。
- `↑`：  横向移动，定位到前一个（`prev`）兄弟元素。数字距离 `1` 指前一个兄弟元素，`0` 值指首个兄弟元素（头部）。
- `←`： 纵向移动（向父级提升），定位到父元素。数字距离 `1` 指父元素，最高可抵达文档根（`<html>`）。
- `→`： 纵向移动（向子级收缩），定位到首个子元素。数字距离 `1` 指首个子元素。更大的数值按首个子元素逐层递进直到末端，超出的层级数忽略。


#### 简单选取

- 鼠标单击目标元素即可选取，但此为排他性选取（其它已选取全部取消）。`Ctrl + 单击` 为多选，但再次单击会取消该选取。
- 拥有焦点的元素不一定是已选取，按 `Space` 或 `Enter` 键可以选取，但它们实际上是切换键，再按则会取消选取（与鼠标加按 `Ctrl` 类似）。
- 按箭头功能键可以移动选取（焦点移动和选取同时发生），但就像鼠标单击一样，这是排他性的。如果需要用键盘多选，可以先移动焦点（`Ctrl+箭头键`）到目标元素，然后按 `Space` 或 `Enter` 选取。


#### 选取扩展

选取扩展是一种快捷的多选行为。以当前焦点元素为起点，使用简单的键位即可扩展选取，但仅限于**同级**兄弟元素的范围。

- `a`: 选取全部兄弟元素。焦点不变。
- `e`: 针对相同标签类型的元素，选取或取消选取，状态与焦点元素相同。焦点不变。
- `v`: 同级反选。对焦点元素所在层级的已选取集反选（已选取的取消选取，未选取的选取）。与焦点元素状态无关，焦点不变。
- `q`: 取消焦点元素所在层级全部选取。**注**：`ESC` 为取消全部选取。
- `Shift+↓`: 向后（`next`）扩展。设置下一个兄弟元素与焦点元素状态相同（选取或取消选取），支持数字指定扩展距离。焦点移动到最后扩展的元素。
- `Shift+↑`: 向前（`prev`）扩展。行为逻辑同上，但方向相反（前一个兄弟元素）。

另外有一个特殊的纵向选取扩展：

- `t`: 选取焦点元素的上层根（`Top`）：如果是内联元素，选取所属内容行，如果焦点已是行块元素，选取其结构根（即内容单元）。焦点会转移到该根元素，同时其内部原有的任何选取会被取消（清除冗余）。


#### 功能行为

用单个键位即可执行各种控制，默认的键位定义如下：

**进入临时态**

- `c`: 已选取集：复制准备。
- `x`: 已选取集：剪切/移动准备。如果为鼠标点选目标位置则为剪切，若为键盘定位目标则为分别移动。
- `X`: 同级已选取集：移动准备。仅支持键盘定位目标位置，同级已选取集作为一个整体，分别移动。


**普通控制**

- `d`: 删除已选取集。删除行为有行块单元和内联元素的区分（见前述）。
- `D`: 删除已选取集元素本身，不区分是否行块或内联元素（**注**：编辑器的逻辑里用户应当有这样的权利）。
- `u`: 撤消（`Undo`）。
- `r`: 重做（`Redo`）。
- `m`: 合并已选取集。以首个选取单元为目标，移动其它选取单元的内容追加。内容被提取的元素可能被清空（结构性元素）或被移除（内容元素）。
- `n`: 插入新内容。显示关联面板的录入版（如果已隐藏）并聚焦。
- `s`: 本地（浏览器）暂存。
- `o`: 打开外部输入框（如导入 markdown 格式文档）。
- `p`: 打开单元属性定义框（部分元素修改 `role` 属性可转换内容类型）。
- `P`: 打开输出/导出对话框（导出/下载）。
- `z`: 显示关联帮助（状态栏右侧）。
- `g`: 章节跳转（仅限 `s1`）。位置由之前的数字键入指定。
- `G`: 章节跳转（完整）。显示输入框获取定位路径，区分子片区（章.节.区.段.末）。


**进入微编辑**

每次仅执行**单个**内容元素的微编辑，如果当前焦点元素不是内容元素，则向内递进到首个内容元素。通过按 `Tab` 键，可以在选取集内的内容元素间逐个**退出/进入**微编辑。

- `i/I`: 进入微编辑，光标定位到前端或末端。
- `Alt + 单击`: 进入微编辑，光标定位到单击点位置（如果有效）。
- `双击`: 同上。
- `Tab`: 确认并退出上一个选取的内容元素的微编辑，进入当前内容元素的微编辑。


#### 关联面板

新建单元内容时显示的录入面板与当前焦点元素相关联，不同的参考元素类型能够插入的内容是有区别的。

关联面板有2个位置选项：**平级** 和 **向内**，其中 **向内** 包含了3种方式：`prepend|append|fill`。因为结构性单元有固定的元素位置规则，所以不同位置选项卡中显示的可插入内容也会稍有不同。这是系统自动判断的，这也是维护内容单元结构合法的措施之一。

出于编辑器必要灵活性的考虑，固定位置单元可以被移动，但插入新的唯一性固定单元并不自由，这通常需要原来的固定单元被移除之后才行。


### 临时态

由普通模式下键入特定的键位开启，实现对已选取集进行粘贴插入操作。

目标位置的选取可用鼠标单击，或箭头移动焦点的方式获得。当然鼠标单击之后也可以再用键盘移动焦点。**注**：`Ctrl + 箭头键` 会直接移动/复制到目标位置。

- `i/I`: 粘贴插入。插入目标参考元素之前/内部前端。同时退出临时态。
- `v/V`: 同上。
- `p/P`: 粘贴添加。插入目标参考元素之后/内部末尾。同时退出临时态。
- `r/R`: 粘贴替换/填充。替换与插入后删除效果相同，填充对于结构化单元较为智能。同时退出临时态。
- `q/ESC`: 取消并退出临时态。

> **友好：**<br>
> 如果参考目标为单标签元素（如 `<img>`），`I/P/R` 不可用。<br>
> 插入参考元素内部时会根据元素类型执行必要的转换（内部非仅指直接子元素）。<br>

样式面板中单击**格式刷**也会进入临时态。



## 插入内容

### 录入面板

可从内容面板中录入内容，不同的单元显示各自的录入控件，拥有自身特有的结构。
这是一种就近关联的交互设计，简化界面而又需求直达。

**友好性**：在 `<textarea>` 中输入内容时，可以：

- 按 `Alt+F` 切换录入框最大化（占满面板）。
- 按 `Ctrl+Enter` 直接提交（保持最大化不变）。
- 按 `Alt+Enter` 提交并切换录入框最大化（退出/占满）。


### 微编辑

内容元素的 `contenteditable` 属性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内，仅用于简单的文本修订。

此模式中 `Enter` 键被严格限定，以避免不同浏览器的不同行为。

- `Enter` 确认并退出微编辑。
- `Shift+Enter` 插入一个换行元素 `<br>` 或换行字符 `\n`（在`<pre>` 中时）。
- `Ctrl+Enter` 创建一个同类新行，光标在新行开头。
- `Ctrl+Shift+Enter` 创建一个克隆新行，光标在新行相同下标位置处。适用较广。
- `Alt+Enter` 创建一个逻辑新行，如：`dt > dd` 或 `<tr>/<td|th>`。
- `Alt+Shift+Enter` 创建一个克隆逻辑新行，内容相同但元素可能不同，光标位于相同下标位置。
- `Tab` 功能同 `Enter`，但同时进入下一个选取元素的微编辑（如果有）。
- `ESC` 取消当前修订并退出微编辑。

同类新行创建仅适用 `<p>`、`<li>`、`<dd>`。

> **注记：**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 内的微编辑提交后，由浏览器插入的换行元素 `<br>` 应被替换为换行字符 `\n`。<br>
> 无论新行是克隆或新建，原行应当确认并退出微编辑（小修订逻辑并鼓励用面板录入）。<br>


#### 代码元素

对于普通的内容元素，进入微编辑后内容会原样保持（如内联的 `<strong>` 等）。但对于代码，会清除语法标注单元 `<b>`（即仅取 `textContent`），确认提交时会重新解析语法并标注。


#### 光标行移动

在进入微编辑的多个单元行中，可以通过上下箭头键切换相邻的行（已按DOM排序），且光标保持相同下标（如果可能）。

1. 光标已经抵达元素内顶行/底行时，再按上/下箭头键即切换。
2. `Ctrl+箭头` 键可直接切换到目标行，保持光标的合理位置。


## 其它

### 路径导航

内容区的底部会实时展示当前选取集末尾元素的DOM路径，它主要由元素的标签名构成（前置层级序号）。

鼠标单击某一目标会移动焦点到该位置的元素，之后若按 `Space` 会选中，路径信息会被重构。

> **专业版：**<br>
> `Ctrl+单击` 会移动焦点的同时展开目标位置元素兄弟元素的信息。这些信息是有序的，目标元素位置高亮置空。<br>
> 这仅是便于用户了解内容的HTML结构，方便相对ID的定位构造（`OBT` 需求）。<br>
