# 编辑操作

与普通的编辑器有所不同，本编辑器有两种操作模式：

1. 键盘友好的 **普通模式**。除了从主面板插入各种内容外，可以通过快捷键执行多种操作：选取、复制、移动、删除等。
2. 执行小量内容修改的**修订模式**。这是通过设置内容元素的 `contenteditable` 特性使得元素可编辑，适用于小量修订（有时也称为 **微编辑模式**）。

兼顾编辑的便捷性，修订模式下支持简单的创建新行的能力。


## 普通模式

编辑器初始即处于普通模式，普通模式下无法对文本进行编辑，但可以对内容进行各种控制操作（类似于 `Vim`），此时的状态也称为 **控制态**。

- **选取**：鼠标单击选取目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。
- **克隆**：将选取集元素克隆并插入到焦点元素前后。
- **移动**：将选取集元素移动到焦点元素前后。如果克隆/移动是在兄弟元素之间发生，则不会发生可能需要的内容转换。
- **删除**：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（如选取的是 `<tbody>` 元素），此时只会删除其 **内容**，完整的单元才会被整体删除。
- **录入**：从编辑器下方的主面板可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。


### 焦点元素

选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。

但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是 **当前正在或需要被操作的目标**，它与浏览器文档节点树上的元素焦点并不相同。焦点之下的元素称为焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。

为了与浏览器节点树上的元素焦点概念区别，有时我们称之为 **选取焦点**（注：下文中提到的焦点皆指此）。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 `hjkl`）移动。移动分为两个维度：

- **平级/横向**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间的跨层级移动。

方向键含义如下：

- `←`：横向移动，定位到前一个（`prev`）兄弟元素。支持数字指定移动距离，默认值 `1`（即前一个兄弟元素），特殊值 `0` 表示头部首个兄弟元素。
- `→`：横向移动，定位到下一个（`next`）兄弟元素。支持数字指定移动距离，默认值 `1`（即下一个兄弟元素），特殊值 `0` 表示末尾最后一个兄弟元素。
- `↑`： 纵向移动，定位到父元素（**父级方向**）。支持数字指定移动层级，默认值 `1`（即父元素），需提供准确数值，不支持 `0` 特殊值。
- `↓`： 纵向移动，定位到子元素（**子级方向**），支持数字指定子元素位置下标，默认值 `0`（即首个子元素），负值表示从末尾算起（`-1` 表示最后一个子元素）。


### 元素选取

鼠标单击目标元素即可选取，此时为单选方式（会取消之前的已选取）。如果在单击的时候按住 `Ctrl` 键，则可以实现多选，同时这也是切换选取的逻辑。

在鼠标选取元素的基础上，我们可以通过键盘实现更多的选取逻辑。**注**：下面的键位定义只是默认配置或一种表意，编辑器最终的实际配置可以由用户修改。


#### 键盘选取

通过箭头键，我们可以把选取焦点定位到任意一个元素上，此时更多的键位定义如下：

- `Space | Enter` 执行选取或取消选取（类似 `Ctrl + 单击`）。
- `Ctrl + 箭头键` 移动焦点的同时单选目标元素（类似简单单击）。


#### 选取扩展

在已经选取的元素的基础上，可以通过简单的键位操作将选取集进行扩展。扩展以当前焦点元素为参考，键位功能定义如下：

- `a`: 选取全部兄弟元素，焦点不变。
- `e`: 选取相同标签名的兄弟元素，焦点不变。
- `Shift + e`: 选取叔伯元素内的相同标签子元素（即兄弟逻辑适用到父元素），焦点不变。**注**：主要用于选取同层章节内的标题。
- `v`: 同级反选：已选取的取消选取，未选取的则选取。焦点不变。
- `Shift + ←`: 同级向前（`prev`）状态扩展，焦点移动到新元素上。状态指选取或取消选取，保持与焦点元素相同。
- `Shift + →`: 同级向后（`next`）状态扩展，逻辑同上。
- `Shift + ↑`:  向上选取父级元素，焦点移动到目标元素上。
- `Shift + ↓`:  向下选取目标位置子元素，焦点移动到目标元素上。
- `t`: 选取单元的**顶**元素（`Top`）：内联单元的顶为所在内容行元素（单元格内容的顶为单元格），行块结构内的子元素的顶为该行块根本身。焦点移动到顶元素。
- `q`: 取消同级已选取元素。
- `ESC`: 取消全部选取（**注**：有历史记录）。

- `z`:         选取焦点元素内全部内容子元素。
- `Shift + z`: 新的内容子元素插入到选取集头部。


### 功能操作

类似于 `Vim` 编辑器的操作友好性，这里采用单个键位即可执行简单的编辑功能：

- `d`: 删除已选取集。中间结构单元时删除其内容节点，完整单元时才删除单元本身。
- `u`: 撤消（Undo）。
- `r`: 重做（Redo）。
- `m`: 合并选取集。以焦点元素为目标，按选取顺序移动各单元的 **内容** 追加合并。
- `n`: 焦点元素关联插入面板的显示快捷键（并聚焦）。
- `s`: 本地暂存（localStorage）。
- `p`: 打开单元属性编辑面板。
- `g`: 章节跳转。由用户键入的前置数字表达，句点分隔各层级（如：`3.12.5`）。

- `c`:         克隆插入。将选取集克隆并插入到焦点元素之后（`after`）。
- `Shift + c`: 克隆插入。将选取集克隆并插入到焦点元素之前（`before`）。
- `x`:         移动插入。将选取集移动插入到焦点元素之后（`after`）。
- `Shift + x`: 移动插入。将选取集移动插入到焦点元素之前（`before`）。

- `f`:         移动填充。将选取集移动并填充到焦点元素之内（`fill`）。
- `Shift + f`: 克隆填充。将选取集克隆并填充到焦点元素之内（`fill`）。

另外支持文章内容的导出，由 `Shift + p` 键打开导出对话框。


#### 进入微编辑

对选取集内的元素，按选取的顺序逐个进入每个内容元素进行文本修订。一个结构性单元可能包含多个内容元素，此时即按元素在文档中的自然顺序。

- `i`: 进入微编辑，光标定位到可编辑内容元素的前端。
- `Shift + i`: 进入微编辑，光标定位到可编辑内容元素的末尾。
- `Alt + 单击`: 进入微编辑，光标定位到单击点位置附近（如果位置有效）。
- `双击`: 效果同上。
- `Tab`: 确认当前微编辑，定位到下一个内容元素并进入微编辑。如果当前没有微编辑元素，则进入首个元素的微编辑。


#### 附：系统级复制与剪切

普通模式下支持选取集元素 **复制** 到剪贴板，但内容仅为纯文本，多个内容行元素的内容用换行分隔。**注**：单元格按内容行处理。

支持剪贴板内容 **粘贴** 到选取集元素上，此时执行的是填充操作。如果选取集元素不止一个，且剪贴板内容为多行文本，则为一一对应填充（不足者忽略），纯文本格式。


### 格式刷

将选取集内的元素样式应用为 **焦点元素** 的样式。焦点元素可以为选中或非选中状态（实质兼容）。

这与普通编辑器（如 Word）中的格式刷逻辑稍有不同。


## 录入面板

与普通编辑器的原地输入不同，一篇文章的内容主要通过录入面板来输入。因为不同的内容单元有相关联的逻辑限制（比如页面主标题 `<h1>` 就不能出现在正文内容中，或者 `<address>` 也只能出现在小结/结语 `<footer>` 内），这种逻辑受限的录入设计是必要的。

录入面板中存在动态的条目区域，该区域内出现的条目与插入参考点相关（逻辑关联）。


### 附：交互友好性

在录入面板内的所有 `<textarea>` 录入框中支持以下快捷键：

- `Alt+F` **切换** 录入框最大化（占满面板）。
- `Ctrl+Enter` 直接 **提交** 插入，同时保持录入框最大化不变。
- `Alt+Enter` 直接 **提交** 插入，同时切换录入框最大化。


## 修订模式

内容元素的 `contenteditable` 特性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内。这种模式应当仅用于简单的文本修改。

在这种模式中，`Enter` 键的功能被严格限制，因为它会带来不同浏览器的兼容性问题。

- `Enter` 确认并退出微编辑。
- `Shift+Enter` 插入一个换行元素 `<br>`，或者在 `<pre>` 元素内插入一个换行字符 `\n`。
- `Ctrl+Enter` 创建一个空的同类新行，光标在新行内。
- `Ctrl+Shift+Enter` 创建一个克隆新行，光标在新行内相同的下标位置。
- `Alt+Enter` 创建一个逻辑新行，如：`dt > dd`。光标位于单元格内时，创建新的 `<tr>` 也适用于此（**注**：可独立配置）。
- `Alt+Shift+Enter` 创建一个内容克隆的逻辑新行，光标位于相同下标的位置。
- `Tab` 功能与 `Enter` 相同，但会进入下一个候选内容元素的微编辑（如果有）。
- `ESC` 取消当前修订并退出微编辑。**注**：当前仅存在一个微编辑元素。

> **附：换行兼容性**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 元素微编辑修订后，其中的换行元素 `<br>` 会被强制替换为换行字符 `\n`，以保证内容的一致性。<br>


### 代码元素

对于普通的内容元素，修订时是所见即所得的。但对于代码内容，则是纯文本的（语法标注 `<b>` 会被清除），系统会在确认提交时重新解析语法。



## 注记

### 单元移动/转换

- 同级兄弟元素间可自由移动，但不能跨越固定性单元。固定性单元自身可移动。
- 跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。


### 内容提升

在严格的规范化内容结构里，片区与内容单元是互斥的逻辑。为便于用户操作，编辑器提供写作时的容错，但在文章提交类操作中提供规范化合并选项。

**另**：工具栏的内容提升按钮除了支持内容元素外，片区单元（容器）也是适用的。


### 表格的容错编辑

通过特性编辑面板，用户可以修改单元格的 `rowspan` 和 `colspan` 特性，因此对于懂得 HTML 结构的专业用户来说，他们可以自由构建不规整的表格结构。因此，编辑器不阻止用户删除/插入独立的单元格。

但这种能力是用户自有的，如果克隆表格行（`<tr>`），编辑器并不检查单元格的这两个特性，而只是简单地参考表格的 `$.Table` 实例的内在状态值（列头和列数）进行处理。



### 兼容性依赖

修订模式下需要浏览器的 `document.execCommand` 支持，以实现从外部插入内容时，可以直接使用浏览器的 **Undo/Redo** 能力，否则撤销和重做需要自己编写复杂代码。

另外，对于 `<textarea>` 内容的编辑也可以嵌入比较友好的处理，比如键入 `Tab` 键插入4个空格，而编辑历史会被浏览器自动记录，撤销和重做依然可以简单执行。
