# 操作规则

行块编辑和行内内容编辑分成两种不同的逻辑。


## 行块编辑

仅限于操作模式之下，文本内容不可编辑（非 `contenteditable`）。

### 数据源

- **内容元素**：可直接包含文本内容的元素，有**行块**类型和**内联**类型两种。前者会取其内容（`innerHTML`），后者会取元素本身（`outerHTML`）。
- **结构元素**：不能直接包含文本，有固定子元素结构的容器元素。这里的子元素结构包括本设计中的内容结构（如 `section/h2...` 等）。


### 编辑操作

- **复制**：源可以是内容元素也可以是结构元素，前者执行内容匹配规则，后者执行严格相等匹配规则（`<tr>` 特别处理）。
- **剪切**：规则同复制，但在粘贴执行之后，剪切的源消失。
- **粘贴**：的目标参考块可以为内容块，也可以是内容块的直接父容器。内容块参考可插入**之前**（`Enter`）或**之后**（`Shift+Enter`），父容器参考插入**内部末尾**（`Enter`）。
- **删除**：操作默认会清除内容块的内容而不是内容块本身，**强删除**才会删除内容块自身（如 `Shift + Del` 键）。
- **移动**：仅限于相同父容器内的兄弟元素之间，包括结构性单元。

> **友好：**<br>
> 用鼠标定位目标时，鼠标移动时即提供合法性反馈（如红/绿边框）。点选目标后可不立即执行插入，键盘可移动选取，按下 `Enter` 后确认操作。<br>
> 用键盘快捷执行的**复制/剪切/移动**等操作无需 `Enter` 确认，且支持数字距离设定。<br>


### 相等匹配

适用于结构性单元，目标位置的元素必须与源数据类型完全相同，且目标位置可以容纳多个该单元（如 `<table>` 中的 `<thead>` 就只能有一个，不符合）。


### 内容匹配

源数据粘贴到目标位置时，如果类型相同，简单插入即可。如果类型不同，会作最简单的转换。

> **内容类型：**
> 按照设计中的内容结构，凡是可以存在于同一父级元素之下的子元素，都属于同一类型。如：`<dt>` 和 `<dd>` 就是内容类型相同的元素。


#### 简单转换

- 参考为内容块时：克隆参考目标，行级源数据取内容填充（覆盖）到新元素内，内联源数据取源数据自身（`outerHTML`）填充到新元素内。
- 参考为父容器时：新建合法子元素，从源数据取值填充到新元素内，取值规则同上。


#### 特例：tr => tr

- 以目标行的列数为基准，超出时合并到末端单元格，不足时添加空单元格。
- 实现为目标行的克隆，然后填充覆盖单元格内容，因此源单元格的标签可以忽略（`<th>|<td>` 兼容）。

> **注：**<br>
> 因为是插入到参考行前端，所以插入内容行时不会选择到标题行（`<tr><th>`），除非是明确需要两个标题行。这种操作友好。



## 行内编辑

内容元素的 `contenteditable` 属性被设置为 `true`。这是一种微编辑模式，编辑范围限于内容容器之内，浏览器自带文本编辑功能。因为编辑范围严格受限，所以操作行为也限定为简单的几种，仅用于简单的小修改，避免复杂化。

`Enter` 键用于确认并退出微编辑，因此不支持创建独立的新行，但可以用 `Shift+Enter` 创建行内换行（`<br>`）。

> **注：**<br>
> 普通模式下用 `Ctrl+Enter` 组合键进入当前内容元素的微编辑模式，光标在末尾。<br>
> 也可以用鼠标双击进入单击点所在内容元素的微编辑，光标在单击点位置。<br>


## 内容添加

不同的单元显示不同的录入控件，携带相应的结构逻辑。控件的布局和显示应当友好顺手，不干扰版面。


## 选取操作

普通的控制模式下除了鼠标的移动点选，还支持键盘对选取的移动操作。除了直接使用方向键，默认也支持Vim的传统方向键。

移动分为两个维度：

- **纵向**：DOM树的深度方向，即父子层级方向。
- **横向**：DOM树的同级方向，即兄弟元素方向。

- `H: ←` 纵向移动，向父级提升。
- `J: ↓`  横向移动，选取后一（`next`）兄弟元素。
- `K: ↑`  横向移动，选取前一（`prev`）兄弟元素。
- `L: →` 纵向移动，选取首个子元素。


### 扩展选取

选取可以扩展到多个元素。扩展的起点为当前焦点元素，根据配置的功能键或方向键进行不同类型/方向的选取扩展。

键盘快捷键的选取扩展仅限于当前焦点元素的**同级**兄弟元素之间。

- `E`: 相同标签类型扩展。焦点不变。
- `A`: 全部兄弟元素选取。焦点不变。
- `R`: 同级反选（针对当前层级的已选取集）。焦点不变。
- `Shift+↓`: 向后（`next`）扩展，支持数字指定扩展数量。焦点移动到最后一个选取元素。
- `Shift+↑`: 向前（`prev`）扩展，支持数字指定扩展数量。焦点移动同上。
- `Q`: 取消选取（全部，同ESC）。
- `T`: 选取当前焦点元素所属的单元根，焦点元素转为单元根。这实际上是一种选取压缩，单元内单独的选取都会被移除（去除冗余）。
