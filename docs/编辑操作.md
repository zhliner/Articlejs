# 编辑操作

与普通的编辑器有所不同，本编辑器有两种操作模式：

1. 键盘友好的 **普通模式**。除了从功能区插入各种内容外，可以通过快捷键执行多种操作：选取、复制、移动、删除等。
2. 执行小量内容修改的**修订模式**。这是通过设置内容元素的 `contenteditable` 特性使得元素可编辑，适用于小量修订（有时也称为 **微编辑模式**）。

兼顾编辑的便捷性，修订模式下支持简单的创建新行的能力。


## 普通模式

编辑器初始即处于普通模式，普通模式下无法对文本进行编辑，但可以对内容进行各种控制操作（类似于 `Vim`），此时的状态也称为 **控制态**。

- **选取**：鼠标单击选取目标元素，按 `Ctrl` 键单击可多选或切换选取。另外还有一些扩展选取的快捷方式。选取的多个目标元素称为选取集，它们是接下来操作的目标对象。
- **克隆**：将选取集元素克隆并插入到焦点元素前后。
- **移动**：将选取集元素移动到焦点元素前后。如果克隆/移动是在兄弟元素之间发生，则不会发生可能需要的内容转换。
- **删除**：部分内容单元拥有固定的结构（如表格），删除操作不会破坏这样的结构（如选取的是 `<tbody>` 元素），此时只会删除其 **内容**，完整的单元才会被整体删除。
- **录入**：从编辑器主面板下方的功能区可录入各种类型的内容单元，这也是本编辑器主要的输入内容的地方。各个内容单元有自己的结构逻辑，以及应当处于文章内什么位置的约束。文章结构的规范化就是通过这单独的录入逻辑实现的。


> ### 附：快捷辅助键使用原则约定
> 普通模式下大量的操作都可以使用快捷键，这极大地提高了编辑的效率。为了便于规范和记忆，快捷键的设定遵循如下原则。
>
> - `Shift`: 当前功能增强。
> - `Ctrl`:  当前功能相关、衍生功能。
> - `Alt`:   提供当前功能的额外能力，多与系统级相关联（系统能力支持），或逻辑差异较大。
>
> 当然，用户也可以根据自己习惯修改系统默认的快捷键配置（详见：*base/shortcuts.js*）。


### 焦点元素

选取集是按元素选取的先后顺序排列的一个集合，其中最新添加的元素就是当前选取的，因为是当前选取，被视为拥有焦点，所以也称它为焦点元素。

但焦点元素并不完全就是最新添加的那个元素，实际上焦点可以在任意元素间移动的。这里的焦点的准确含义是 **当前正在或需要被操作的目标**，它与浏览器文档节点树上的元素焦点并不相同。焦点之下的元素称为焦点元素，它可能被添加到选取集，也可能是需要从选取集中移除。

为了与浏览器节点树上的元素焦点概念区别，有时我们称之为 **选取焦点**（注：下文中提到的焦点皆指此）。


#### 焦点移动

选取焦点可通过键盘上的几个方向键移动，或者通过实施箭头功能的其它友好键位（如 Vim 中的 `hjkl`）移动。移动分为两个维度：

- **兄弟/平级**：在DOM树的同级元素方向上，即兄弟元素间移动。
- **父子/纵向**：在DOM树的纵深方向上，即父子元素间的跨层级移动。

借鉴于DOM的树逻辑，方向键含义如下：

- `↑`： 平级移动，定位到前一个（`prev`）兄弟元素。支持数字指定移动距离，默认值 `1`（即前一个兄弟元素），特殊值 `0` 表示头部首个兄弟元素。
- `↓`： 平级移动，定位到下一个（`next`）兄弟元素。支持数字指定移动距离，默认值 `1`（即下一个兄弟元素），特殊值 `0` 表示末尾最后一个兄弟元素。
- `←`：纵向移动，定位到父元素（**父级方向**）。支持数字指定移动层级，默认值 `1`（即父元素），需提供准确数值，不支持 `0` 特殊值。
- `→`：纵向移动，定位到子元素（**子级方向**），支持数字指定子元素位置下标，默认值 `0`（即首个子元素），负值表示从末尾算起（`-1` 表示最后一个子元素）。

> **注记：**
> 方向键的逻辑设计实际上也符合文章纵向为平级罗列的表现。


#### 附：顶元素

支持一个特殊的键 `t` 将焦点移动到当前焦点元素的 **顶元素** 上。

顶元素是一个特意设计的 **虚拟** 根容器，以方便用户快速定位经常操作的目标。

- 对于内联单元来说，顶元素是其所在行块的内容行元素。如 `<p>`、`<li>`、`<dd>` 和 `<td>` 等（`<th>, <td>` 被视为特殊内容块）。
- 对于行块单元内的中间结构元素，其顶元素即为单元根元素。如 `<tr>` 的顶元素为 `<table>`，列表项 `<li>` 的顶元素为其所在 `<ol>` 或 `<ul>`。
- 对于内联单元内的结构元素，其顶元素即是该内联单元本身。如 `<rt>` 的顶元素为 `<ruby>`，SVG 系子元素的顶元素为 `<svg>`。


### 元素选取

#### 鼠标点选

通过鼠标 **单击** 的方式可以定位焦点元素并实现选取或取消选取。

- `单选：单击`:         简单单击选取目标元素，之前的选取会被取消。
- `多选：Ctrl + 单击`:  增加选取目标元素，之前的选取无影响。如果单击的是已经选取的元素，则为取消选取（切换逻辑）。
- `聚焦：Alt + 单击`:   仅将焦点移动到目标元素上，不作任何选取类动作。这在编辑操作中定位目标时有用。

下面的选取有一定的智能性，单击的目标不一定是最终目标（与焦点元素有关）。

- `跨选：Shift + 单击`:         同态焦点元素至目标元素的同级兄弟元素，如果目标元素层级较深，自动取与焦点元素同级的父级元素为目标。焦点移动到目标元素。
- `浮选：Ctrl + Shift + 单击`:  以焦点元素所在层级为依据，获取目标的同层级父级元素 **切换** 选取。如果目标与焦点元素不在同一父容器内则无效。

任意目标的父级元素选取（与焦点元素无关）。

- `父选（多选）：Alt + Ctrl + 单击`:  选取鼠标单击目标的父元素，不影响已有选取。比如直接选取表格行（`<tr>`）元素。
- `父焦（聚焦）：Shift + Alt + 单击`: 聚焦鼠标单击目标的父元素，不影响已有选取。

> **同态：**
> 焦点元素有选取和非选取两者状态，使得目标与焦点元素状态相同，称之为 **同态** 操作。


#### 按键选取

在鼠标选取的基础上，通过键盘按键操作，我们可以实现更多的选取逻辑。

- `Space | Enter`: 选取切换。焦点元素选取或取消选取，不影响其它已选取元素（类似 `Ctrl + 单击`）。
- `Ctrl + Shift + 箭头键`: 单选游走。移动焦点的同时改选目标元素（类似鼠标单击）。

> **注：**
> 另外也支持 `Ctrl + Shift + t` 单选游走到焦点元素的 **顶元素**（含义见后）。


#### 选取扩展

在现有选取集的基础上，可以通过简单的键位操作将选取集进行扩展。扩展以当前焦点元素为参考，键位功能定义如下：

下面的扩展与焦点元素状态有关，会执行 **同态** 操作。

- `a`:               定位全部兄弟元素，使得与焦点元素状态相同。焦点不变。
- `e`:               定位相同标签名的兄弟元素，使之与焦点元素状态相同，焦点不变。
- `Shift + e`:       定位叔伯元素（父元素的兄弟元素）内的相同标签子元素，使之与焦点元素状态相同，焦点不变。**注**：可用于同态所在章节内的标题，或跨行的列头单元格（`<th>`）。
- `Alt + Shift + e`: 定位叔伯元素内相同标签且相同位置的子元素，使之与焦点元素状态相同，焦点不变。**注**：定位表格列单元格时位置为逻辑列（容错跨列）。


下面在移动焦点的同时按 `Shift` 键会同时执行 **同态** 操作。

- `Shift + ↑`: 同级向前（`previous`）状态扩展，支持数字指定距离，焦点移动到最终元素上。
- `Shift + ↓`: 同级向后（`next`）状态扩展，逻辑同上。


下面在移动焦点的同时按 `Shift` 键会同时执行 **选取** 操作。**注**：纵深方向上未设计同态逻辑（选取互斥）。

- `Shift + ←`: 向上移动焦点到父元素上，同时选取父元素。支持数字指定距离。
- `Shift + →`: 向下移动焦点到目标子元素上，同时选取目标子元素。支持数字指定子元素下标。
- `Shift + t`:  移动焦点到当前元素的顶元素（`Top`）上并选取。


下面的操作与焦点元素状态无关，为固定的选取或取消选取逻辑。

- `v`:          同级反选：已选取的取消选取，未选取的则选取。焦点不变。
- `w`:          选取焦点元素内全部内容根元素。焦点移动到首个内容根元素（**注记**：体现出视觉变化，如 `<tr>` 到 `<td>`）。
- `Shift + w`:  同上选取逻辑，但新的元素插入到选取集头部。焦点移动同上。
- `q`:          取消焦点元素之外的同级已选取，保留焦点元素选取或自动选取（若未选取）。
- `Shift + q`:  取消焦点元素之外全部已选取，焦点逻辑同上。
- `ESC`:        取消全部选取（**注**：可撤销），同时焦点也会被取消。


#### 虚焦点支持

大部分的选取操作都是基于焦点元素，但焦点元素只有一个。对于需要批量操作的场景，这并不友好，因此这里引入了 **虚焦点** 的设计。

虚焦点是：**把当前选取集内的每一个成员都视为焦点元素**，并据此执行特定的选取操作。支持虚焦点的操作并不多，并且只能是选取的逻辑而非 **同态**（未选取即无法成为虚焦点）。

因为每一个成员都变成了焦点，所以这里有一些限制：

1. 仅适用部分简单的选取，比如 `e` 选取同级同类元素。而对于复杂的叔伯元素选取（`Shift + e`），则不适用。
2. 平级操作时（如 `e`、`Shift + ↓`），选取集内的成员不能互为兄弟元素。即：每个成员只能是在其父元素内唯一选取的元素。纵向操作（如 `w`、`Shift + →`）则不限。

通常，支持虚焦点的操作的快捷键会配置为在原选取操作快捷键上加 `Alt`。

> 可用操作（共计8个）：
> - 平级类：`a`、`e`、`Shift + ↑`、`Shift + ↓`。每个成员在各自父元素内为单选，且仅为选取（**非同态**）。因为选取之后就失去了唯一性前提，所以这是 **一次性** 的。
> - 纵深类：`w`、`Shift + →`、`Shift + ←`、`Shift + t`。向下操作时元素各自独立，向上操作时可能会有共同的父级元素（会自动去重）。

如果操作使用了虚焦点，平级类操作会保留原来的实际焦点不变，但纵深类操作则会将焦点移到整个选取集的首个成员上。


#### 路径辅助选取

在编辑器内容区的底部会显示当前焦点元素的 **DOM树路径**，用鼠标单击其中任何一段，即可 **选取** 相应的元素。路径提供了清晰的节点树层次，可用于精确选取。

路径选取也有切换选取的逻辑，此时按住 `Ctrl` 键即可（否则为确定多选）。如果仅仅只是需要从路径上 **聚焦** 目标元素，则可以在单击的时候按住聚焦辅助键（`Alt`），此时只是改变焦点，而路径序列也不会重构。

> **提示：**
> 将鼠标滑过路径上的不同部分，会有其相应元素的背景阴影提示，便于用户识别其指代的目标。


#### 选取集排序

元素选取的方式非常多也十分地灵活，有时候需要让选取的元素保有看上去（DOM树方向）的顺序，以便于进一步的操作（比如后面的系统级复制/粘贴）。

因此这里设计了两个快捷排序操作。

- `s`:         选取集按DOM节点树排序，焦点定位到排序后的首个成员。
- `Shift + s`: 选取集按DOM节点树逆序，焦点定位同上（从DOM上看就是最后一个元素）。


### 编辑操作

与选取类操作以焦点元素为中心不同，编辑操作的目标就是整个选取集元素。焦点元素在这里有另外的含义——用于定位与操作关联的目标（详见后）。

借鉴 `Vim` 编辑器的操作便利性，这里大部分的操作都采用单个键位（加辅助键）执行。


#### 普通编辑

- `del`:               智能删除。删除选取集中的元素，但仅限于完整单元和可删除的中间结构元素（如 `<li>`、`<tr>`、`<dd>` 等）。
- `Shift + del`:       增强删除。删除选取集中元素的可编辑内容（即内容根元素内的内容）。
- `Alt + Shift + del`: 强制删除。删除选取集中的任意元素，有破坏性。**注**：提供用户自主的能力，如高级用户编辑异形表格时。

- `u`:  撤消（Undo）。
- `r`:  重做（Redo）。
- `x`:  逆序。将选取集内的同级兄弟元素逆序重排，不相邻的元素会保持其位置。
- `z`:  合并。将选取集内元素的内容合并为一，合并顺序按选取时的顺序，首个选取元素为容器。仅限于内容元素。

- `c`:          分组克隆。以选取集内 **相邻成员** 为分组，整体克隆并插入原组之后（`after`）。选取集更新为新插入的元素。**特例**：如果选取集只有一个成员，支持数字指定克隆数量。
- `Shift + c`:  各别克隆。选取集内每一个成员分别克隆并插入自身之后（`after`）。选取集更新为新插入的元素。特例支持同上。

以下操作与焦点元素相关。

- `f`:          填充。将选取集克隆填充到焦点元素之内（`fill`），焦点元素可以作为数据源。**注**：若源为非法子元素，会取内容创建默认子单元。
- `Shift + f`:  移动填充。将选取集移动填充到焦点元素之内（`fill`），焦点元素不应当被选取。规则同上。
- `d`:          内添加。将选取集克隆添加（`append`）到焦点元素内，焦点元素可以作为数据源。规则同上。
- `Shift + d`:  移动内添加。规则同上，焦点元素不应当被选取。

- `i`:          前插入。将选取集克隆插入到焦点元素之前（`before`）。焦点元素可以作为数据源。
- `Shift + i`:  移动前插入。将选取集移动并插入到焦点元素之前（`before`）。不可删除元素会移除其内容，焦点元素不可选取。
- `b`:          后插入。将选取集克隆插入到焦点元素之后（`after`）。焦点元素可以作为数据源。
- `Shift + b`:  移动后插入。将选取集移动并插入到焦点元素之后（`after`）。不可删除同上，焦点元素不可选取。

> **注意：**<br>
> 插入的顺序是按照选取的顺序逐个提取，这样的设计可以有较大的灵活性。如果需要有序，可以先按 `s` 排序。<br>
> 上面的移动逻辑并不专注于移动，它们只是一种便捷增强，实际上只是内容提取时被从DOM树中 **移走** 了而已，有时只是取走了其内容（位置不匹配）。<br>


#### 移动与缩进

移动与缩进是编辑中常见的操作，这里的移动是真正的移动：专注于选取集元素自身的行为。

**移动** 只能在平级兄弟元素之间进行，**缩进** 则仅适用于章节（`s1-s5`）或片区单元（`section`），包含在父子之间的升级或降级。

- `Alt + ↑`:    平级向前移动。选取集成员在各自父元素内移动，支持数字指定距离，超出范围会导致部分或全部逆序插入。`0` 值表示端部，有汇聚插入效果。
- `Alt + ↓`:    平级向后移动。支持同上。
- `Alt + ←`:   片区单元（`section`）左缩进（升级），升级之后排列到当前父片区之前（`before`）。**注**：这是一种层级递升，不一定必然表现在视觉上。
- `Alt + →`:   片区单元（`section`）右缩进（降级），会创建一个空的容器片区包含当前已降级的片区。

> **注：**<br>
> 末层章节（`s5`）再降级会变成没有 `role` 定义的 **深片区**，深片区可以无限递进缩进。<br>
> 顶层章节的升级会被简单忽略而不是解包（`unwrap`），因为这会带来结构上的混乱，且视觉上不易区分（易让用户迷惑或混淆）。<br>


#### 进入微编辑

可以对元素内容进行简单的修订（`modify`），这通过进入一种被称为 **微编辑** 的状态实现。这种修订仅适用于内容元素，非内容元素无效果（会有错误提示）。

微编辑按选取的元素顺序逐个进入，编辑完成后按快捷键（详见后）确认退出。同一时刻只有一个元素处于微编辑状态。

- `m`:         进入微编辑，光标定位到单击点或可编辑内容元素的末端。
- `Shift + m`: 进入微编辑，光标定位到元素内容的前端。
- `Tab`        进入微编辑（同 `m`）。主要用于多个选取元素的顺序确认并进入下一个。

> **提示：**<br>
> 非内容元素不能直接进入微编辑，此时可以按 `w` 或 `Shift + w` 选取其内容元素然后再继续。


#### 定位移动

有时侯需要内容保持绝对准确的相对位置，这时通常是设置其样式为 `position:absolute`。但这种定位方法需要用户了解 CSS 相关知识（对容器再设置 `position: relative` 样式），因此这里并不鼓励，用户需要自己在特性设置面板里编辑 `style` 特性来实现。

不过如果元素设置了绝对定位，这里提供方便的操作来微调其位置。

- `Ctrl + ←`: 向左移动 **1** 像素。如果加按 `Shift` 则以 **10** 像素为单位。
- `Ctrl + →`: 向右移动 **1** 像素。`Shift` 键同上。
- `Ctrl + ↑`:  向上移动 **1** 像素。`Shift` 键同上。
- `Ctrl + ↓`:  向下移动 **1** 像素。`Shift` 键同上。

> **注：**<br>
> 上面的箭头键为真实的箭头键（非 `hlkj`），否则与单选游走冲突。<br>
> 对于没有设置绝对定位的元素，这些组合键操作会被简单忽略。<br>
> 插图单元的讲解在样式文件中有 `position:absolute` 和容器的 `position: relative` 定义。<br>


#### 系统级复制/剪切与粘贴

普通模式下支持选取集元素的 **复制、剪切和粘贴**，这些操作由系统的复制、剪切和粘贴操作触发。普通模式下元素并不是可编辑的，因此这里的操作规则如下。

- **复制**：提取被选取元素的文本内容（`textContent`）到剪贴板，多个选取元素的内容以换行符分隔。
- **剪切**：规则同复制，但同时会删除元素本身，如果元素可以被删除的话。
- **粘贴**：以换行符切分剪贴板里的文本内容，分别对应添加到选取集元素（或根内容）内。如果只选取了一个元素，则内容不切分。默认为末尾添加（`append`）方式，加按 `Shift` 键为覆盖（`fill`）方式。

> **注意：**
> 粘贴里的分组插入仅与 **选取** 有关。比如选取一个 `<tr>`，会将相同的内容插入到内部所有的单元格中，如果需要与单元格一一对应，则应当选取单元格。
> 提取或插入的分组是以选取顺序为一一对应的（更灵活），但可能有点混乱的感觉。如果需要DOM的顺序，按 `s` 键先排序即可。


### 杂项功能

- `n`:         显示焦点元素关联的插入面板（并聚焦）。
- `p`:         打开单元属性编辑面板。
- `Shift + p`: 打开文章内容的导出对话框。
- `Ctrl + s`:  手动执行本地暂存（localStorage）。
- `g`:         章节跳转。根据前置章节序列（如：`3.12.5`），将目标章节显示到当前视区。


### 关于格式刷

将选取集内的元素样式应用为 **焦点元素** 的样式。焦点元素可以为选中或非选中状态（实质兼容）。

这与普通编辑器（如 Word）中的格式刷操作逻辑稍有不同。


## 录入面板

与普通编辑器的原地输入不同，本设计中的内容录入主要通过内容面板来实现。

因为文章的内容单元有结构性限制，即该内容只能出现在什么位置（比如 `<address>` 应当只存在于 `<footer>` 内），所以录入面板的创建方式更合理，因为这样可以很方便的限定可以在目标位置创建什么内容。

目标位置用选取元素来标识，新的内容可以插入到该位置之前、之后或内部。如果选取了多个元素，可插入项目是各目标可插入项目的交集，且内容会同时插入到多个目标位置处。


### 快捷键

#### 录入文本框 <textarea>

- `Alt+F` **切换** 录入框最大化（充满面板）。
- `Ctrl+Enter` 直接 **提交** 插入，效果同单击插入按钮。**注**：焦点会保持在录入框内。
- `Alt+Ctrl+Enter` 同上直接提交。但如果录入框已铺满，恢复为普通状态。


#### 表格单元录入 <table:th|td>

- `Enter` 纵向向下切换单元格（并选取）。
- `Shift + ↓` 同上效果。
- `Shift + ↑` 纵向向上切换单元格并选取。
- `Shift + Enter` 插入换行符（浏览器自身功能）。

- `粘贴` 内容以换行符切分，从焦点单元格开始，同行后续单元格连续粘贴（内容覆盖式）。
- `Shift + 粘贴` 普通方式粘贴，可能为纯文本（浏览器能力）。

> **注：**
> 智能切分粘贴只支持单行单元格序列。如果需要一次性对多行粘贴，可以插入后在内容区操作。


## 修订模式

内容元素的 `contenteditable` 特性被设置为 `true`，此时即进入修订模式，编辑范围严格受限于容器元素之内。这种模式应当仅用于简单的文本修改。

在这种模式中，`Enter` 键的功能被严格限制，以回避不同浏览器的兼容性问题。

- `Enter`           确认并退出。**注**：会提前执行 `normalize`。
- `Shift + Enter`   插入一个换行元素 `<br>`，或者在 `<pre>` 元素内插入一个换行字符 `\n`。**注**：浏览器默认行为。
- `Ctrl + Enter`    新建一个同类空行，原行确认，光标在新行内。仅限于段落类 `<p:xx>` 和列表项元素 `<li>, <dt>, <dd>`。
- `Alt + Enter`     新建一个逻辑空行。特定于 `dt > dd` 和 `td|th ~ tr` 两种情况。
- `Tab`             完成并切换。功能与 `Enter` 类似，但会取消当前元素的选取并进入下一个已选取元素的微编辑（如果有）。
- `ESC`             取消当前修订并退出微编辑。元素选取保持。

> **附：换行兼容性**<br>
> `Enter` 的行为在不同浏览器之间差异较大，`Shift+Enter` 则较为一致。<br>
> `<pre>` 元素微编辑修订后，其中的换行元素 `<br>` 会被强制替换为换行字符 `\n`，以保证内容的一致性。<br>


### 代码元素

对于普通的内容元素，修订时是所见即所得的。但对于代码内容，则是纯文本的（语法标注 `<b>` 会被清除），系统会在确认提交时重新解析语法。

> **注：**
> 后期提供代码编辑时的即时解析高亮能力。


## 命令行

### 搜索（/）

可以对全文或已选取集执行文本搜索，然后实现过滤 **选取** 或文本 **替换**。

文本的搜索以文本节点为上下文，不支持跨节点文本的搜索。这既是一种简化方便，也可能有它的合理性：既然文本被断开了，就认为横贯断点的文本不应当被匹配。

激活搜索的指令符为问号（`?`）。焦点进入命令行后，遵循如下格式：

- `Hello`       直接的文本表示搜索词（忽略大小写），回车后执行搜索。选取匹配文本所在的元素。如果已经存在选取集，则在选取集范围里执行新的选取。下同。
- `Hello/`      同上效果。末尾的 `/` 之后没有内容。
- `Hello/Hai`   分隔符 `/` 表示替换操作：将搜索到的 `Hello` 替换为 `Hai`。搜索范围为全文或当前选取集（如果有）。**注**：选取被修改的元素能体现出变化在哪，这是一种友好。
- `Hello/Hai/`  同上效果。
- `Hello//`     将搜索到的内容删除（替换为空）。末尾的 `/` 不可缺少。

- `/[0-9a-f]/i`     搜索词为一个正则表达式，这由前置的 `/` 表现出来。选取逻辑同上。下同。
- `/[0-9a-f]`       同上正则搜索但区分大小写。末尾没有修饰符时无需 `/` 结尾，但这是可选的，即 `/[0-9a-f]/` 与之相同。

- `/\s\s+/ /`       正则搜索并替换：将文本中的连续空白（渲染表现）替换为单个空格。中间分隔和末尾的 `/` 为必需。选取逻辑同前。下同。
- `/[a-f]+/abc/i`   正则搜索并替换。正则修饰符放在末尾的 `/` 之后，虽然它修饰的是前面的搜索词。

**注意**：文本的搜索替换是全局的，即目标范围内所有匹配的项都会被替换。所以，你可能需要先执行一个选取性搜索，然后再确认替换。


### 查询（?）

保留问号（`?`）指令符用于未来的社区交互逻辑。



## 注记

### 单元移动/转换

- 同级兄弟元素间可自由移动，但不能跨越固定性单元。
- 跨容器单元的移动涉及转换，如果目标位置合法则简单移动，否则转换构造为默认的合法单元插入。


### 内容提升

在严格的规范化内容结构里，片区与内容单元是互斥的逻辑。为便于用户操作，编辑器提供写作时的容错，但在文章提交类操作中提供规范化合并选项。

**另**：工具栏的内容提升按钮除了支持内容元素外，片区单元（容器）也是适用的。


### 表格的容错编辑

通过特性编辑面板，用户可以修改单元格的 `rowspan` 和 `colspan` 特性，因此对于懂得 HTML 结构的专业用户来说，他们可以自由构建不规整的表格结构。因此，编辑器不阻止用户删除/插入独立的单元格。

但这种能力是用户自有的，如果克隆表格行（`<tr>`），编辑器并不检查单元格的这两个特性，而只是简单地参考表格的 `$.Table` 实例的内在状态值（列头和列数）进行处理。



### 兼容性依赖

修订模式下需要浏览器的 `document.execCommand` 支持，以实现从外部插入内容时，可以直接使用浏览器的 **Undo/Redo** 能力，否则撤销和重做需要自己编写复杂代码。

另外，对于 `<textarea>` 内容的编辑也可以嵌入比较友好的处理，比如键入 `Tab` 键插入4个空格，而编辑历史会被浏览器自动记录，撤销和重做依然可以简单执行。


### 脚本能力

执行结果中可设置：`type: text|html` 和 `where: append|prepend|before|after|replace|fill` 指示标志，系统自动插入结果。值数组与选取成员一一对应。
如果没有该标志设置，运行后自动弹出执行结果框，用户可查验结果后选择 `type` 和 `where` 操作。

> **注记：**
> `html` 方式插入将通过新建逻辑流程，会自动检查节点的合法性（或仅提取其内容）。

另外也支持 `regex` 标记，用于文本内容的简单替换，值为正则表达式。值数组一一对应逻辑同上。**注记**：撤销设计参考微编辑。


### 关于双击

鼠标双击会导致文本单词被选取，这很难在 `mousedown` 事件中取消这一默认行为而又不影响普通的 `mousedown/mouseup` 处理（时间线局限：浏览器最后触发 `dblclick`），所以鼠标双击事件不作为微编辑进入事件。

鼠标的 `mouseup` 事件（有文本选取时）被用于划选文本创建内联单元，双击的单词默认选取正好也可以融入这一处理。**注**：在某些语言中，自动选取单词后弹出内联单元创建框会是一种便捷。
