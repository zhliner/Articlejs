<!--主面板区
----------------------------------------------------------------------------->

<!--录入：
    insert 插入已创建的元素/集（detail），通用。
    instop 插入顶层固定单元。
    insfix 插入区块内固定性单元，如：标题、表头、导言等。
    instbd 插入表体<tbody>元素（特例）。
    update 跟随更新，来源：内容区选取变化、标签页切换。
-->
<form class="Input" tpl-name="slave:input"
    on="submit|avoid;
        update|v.sels;
        insert|ev('detail') checked('before') value('level');
        instop|ev('detail') value('level');
        insfix|ev('detail') value('level');
        instbd|ev('detail') checked('merge') value('level');
        insrbpt|ev('detail') checked('before') value('level')"
    by="-;-;
        Kit.inserts(_2);
        Kit.topinsert(_1);
        Kit.fixinsert(_1);
        Kit.instbody(_2);
        Kit.insrbpt(_2)"
    to="/._body|trigger('create');
        /#con-level|trigger('renew');
        #g-scroll|trigger('focus');
        #g-scroll|trigger('focus');
        #g-scroll|trigger('focus');
        #g-scroll|trigger('focus');
        #g-scroll|trigger('focus')">
    <div class="_roll">
        <!--插入位置：
            ev:detail 已选取元素的集合。
            renew 选单更新。fire非延迟避免闪烁。
            section 片区单元内容混杂检查（标记_mixed类名）。
            click focus 快捷操作友好。 -->
        <div id="con-level" class="_minibar"
            on="renew|ev('detail') $('/input') val('level') v.inslist(_1);
                section|('_mixed') $('/input') val('level') v.ismixed;
                click(input)|$('1/select') focus v.sels"
            to="1/select|fill|fire(10, 'change', 0) goto('section');
                1/select|toggleClass(_1);
                |trigger('renew')">
            <label title="平级插入">
                <input type="radio" name="level" value="siblings" checked /><i id="l-siblings"></i>
            </label>
            <label title="向内插入">
                <input type="radio" name="level" value="children"><i id="l-children"></i>
            </label>
        </div>
        <!--动态选单
            input.select 快捷键选取。从data-k特性取值触发（仅部分）。
            change 空选单时采用empty模板，str 用前缀构造最终模板名。
            备忘：
            scroll 聚焦便于快捷键定位。取消本设计：内容区切换选取后选单重构会激发此事件，使内容区失焦（不友好）。 -->
        <select id="input-items" name="items" size="5" class="_list"
            on="change|evo(3) val or('empty') str('input:') pop tpl;
                input.select|ev('detail') slr('/','-k', _1) $(_1) dup pass prop('value')"
            to="form/._body|replace;
                |val|goto('change')">
            <!-- 动态更新：与目标关联的合法单元。 -->
        </select>
    </div>
    <div class="_body _Empty" tpl-name="input:empty">
        <p on="^obted|(KM.slaveResize)" to="/code:first-child|text">
            <code>[Alt]</code> + 拖动改变面板高度<br>
            <code>[ Alt+F ]</code> 录入框最大化<br>
            <code>[ Ctrl+Enter ]</code> 录入框内直接提交<br>
            <code>[ Ctrl+Shift+Enter ]</code> 录入框内直接提交并取消最大化<br>
        </p>
    </div>
</form>


<!-- 微编辑 -->
<form class="Input Minied" onsubmit="return false" tpl-name="slave:minied">
    <div class="_roll">
        <div class="_minibar"
            on="click(input)|evo(2) val pop tpl;
                click(input)|evo(2) attr('-val') pop tpl"
            to="1/select|replace|focus fire(11, 'change');
                2/._body|replace">
            <label title="内联元素">
                <input type="radio" name="ctype" value="item:inlines" data-val="minied:inlines" checked /><i id="l-element"></i>
            </label>
            <label title="文本字符">
                <input type="radio" name="ctype" value="item:ctypes" data-val="minied:chars" /><i id="l-schar"></i>
            </label>
        </div>
        <!--固定选单
            input.select 快捷键选取。从data-k特性取值触发。
            change str 用前缀（inlines:）构造模板名。 -->
        <select name="inlines" size="5" class="_list _inlines" tpl-name="item:inlines"
            on="change|evo(3) val dup pass str('inlines:') pop tpl;
                input.select|ev('detail') slr('/','-k', _1) $(_1) dup pass prop('value')"
            to="2/._main|fill;
                |val|goto('change')">
            <option tpl-node="
                option:audio,
                option:video,
                option:picture,
                option:svg,
                option:ruby,
                option:meter,
                option:space,
                option:img,
                option:br,
                option:wbr,
                option:a,
                option:q,
                option:abbr,
                option:del,
                option:ins,
                option:dfn,
                option:bdo,
                option:times,
                option:code,
                option:strong,
                option:em,
                option:cite,
                option:small,
                option:sub,
                option:sup,
                option:mark,
                option:orz,
                option:samp,
                option:kbd,
                option:s,
                option:u,
                option:var"></option>
        </select>
    </div>
    <div tpl-source="minied:inlines"> [主栏：单元属性] </div>
</form>


<!--样式：
    style 接收各子区发来的信息（[name,value]），设置内容区元素样式。
    erase 接收名称序列，擦除部分内联样式。应当激发主面板状态更新。
    submit 如果子区有提交逻辑，提交转发为子区修改（modify）事件，各子区因应而为。
    update 跟随更新：来源：内容区选取变化、标签页切换、样式按钮切换、清除/格式刷操作。 -->
<form class="Style" tpl-name="slave:style"
    on="style|v.sels ev('detail');
        erase|v.sels ev('detail');
        submit|avoid;
        update|stop v.sels"
    by="Ed.setStyle(_);
        Ed.eraseStyle(_1)"
    to="#g-scroll|trigger('focus');
        #g-scroll|trigger('focus')|fire(3, 'update');
        /._body|trigger('modify');
        /._body|trigger('follow')">
    <!--click(b)：
        - 切换模板。
        - 表达按下，跟随更新。-->
    <div class="_icons"
        on="click(b)|evo(2) attr('-tpl') node(_1);
            click(b)|$$('/b')"
        to="1/._body|replace;
            =|only('_press')|fire('form/', 'update')">
        <!-- 直接执行：click stop 避免触发上层行为。-->
        <b title="擦除"
            on="click|stop v.sels"
            by="Ed.clearStyle"
            to="#g-scroll|trigger('focus')|fire('form/', 'update')">
            <i id="b-erase"></i>
        </b>
        <b data-tpl="style:align" title="对齐"><i id="b-align"></i></b>
        <b data-tpl="style:fontview" title="字形" class="_press"><i id="b-fontview"></i></b>
        <b data-tpl="style:width" title="宽/高度"><i id="b-width"></i></b>
        <b data-tpl="style:fontsize" title="字号"><i id="b-fontsize"></i></b>
        <b data-tpl="style:margin" title="内/外边距"><i id="b-margin"></i></b>
        <b data-tpl="style:color" title="颜色"><i id="b-colors"></i></b>
        <!-- 直接执行 -->
        <b title="样式刷"
            on="click|stop v.focus dup pass"
            by="Ed.brushStyle"
            to="#g-scroll|trigger('focus')|fire('form/', 'update')">
            <i id="b-brush"></i>
        </b>
    </div>
    <div class="_body" tpl-source="style:fontview"> [字形] </div>
</form>


<!-- 特性 -->
<form class="Attr" onsubmit="return false" tpl-name="slave:attr">
    <div class="_roll">
        <div class="_name">
            <input type="text" name="attr" value="" />
            <!-- ✚✛ -->
            <input type="button" value="✛" class="_add" />
        </div>
        <!--特性清单：
            - 支持多个选取的元素。
            - 全部元素都拥有的特性条目设置_all类名，部分元素拥有的特性条目设置_part类名。
            - 单击目标特性条目，值区域显示首个拥有该特性元素的该特性值。 -->
        <select name="attrs" size="5" class="_list" tpb-for>
            <option _class="$.type" _="$.name"></option>
        </select>
    </div>
    <div class="_body">
        <div class="_main">
            <!-- OBT: 分组对应提示 -->
            <header class="_tips" data-pbo="lost">
                <label data-pbo="">
                    <b>on</b><input type="text" spellcheck="false" class="_code" disabled />
                </label>
                <label data-pbo="">
                    <b>by</b><input type="text" spellcheck="false" class="_code" disabled />
                </label>
                <label data-pbo="lost">
                    <b>to</b><input type="text" spellcheck="false" class="_code" disabled />
                </label>
            </header>
            <textarea name="content" spellcheck="false" class="_code"></textarea>
        </div>
        <aside>
            <div class="_option">
                <label>换行符
                    <input type="text" name="nlchar" class="_char _code" value=";" />
                </label>
            </div>
            <hr tpl-node="common:submit" />
        </aside>
    </div>
</form>


<!--源码：
    仅支持内容区单个元素的源码显示。
    内容区多元素选取时，源码录入框失效。 -->
<form class="Source" tpl-name="slave:source"
    on="submit|avoid $('/textarea') val;
        update|v.sels dup len eq(1) $if('valid', 'invalid')"
    by="Kit.htmlupdate"
    to="#g-scroll|trigger('focus');
        /textarea|trigger(_1)">
    <div class="_body _main">
        <!--状态切换
            失效：设置disabled，清空内容。
            生效：移除disalbed，填充发送来的源码。
            注记：源码编辑并不常见，因此暂不提供友好性（如自动缩进）。 -->
        <textarea name="html" spellcheck="false" class="_code"
            on="invalid|(true, null);
                valid|ev('detail') item(0) v.cleanHTML (false)"
            to="|val $disabled;
                |$disabled val"></textarea>
    </div>
    <aside>
        <div class="_option"
            on="click(button)|v.sels item(0) $('form/textarea') val trim dup pass"
            by="Kit.checkhtml(_1) dup $if('err', 'ok')"
            to="/pre|trigger(_1)">
            <button on="click|avoid">结构检查</button>
            <!--反馈信息：
                ok  结构正常。设置_ok类名、文本并取消聚焦能力。
                    3秒后隐藏文本，便于再次检查时反馈更清晰（不变的提示缺乏表达力）。
                err 结构错误。设置提示文本、移除_ok类名、赋予聚焦能力。
                错误时：
                focus 获取焦点后即平铺最大化。
                blur  失焦时取消平铺最大化。
                keydown 平铺时按 ESC 键聚焦源码框（失焦--取消平铺），stop避免全局ESC执行。
                注记：
                信息封装在<i>内便于样式控制。 -->
            <pre class="_info"
                on="ok|('_ok', '<i>Good!</i>', null);
                    err|(0, '_ok') ev('detail') wrap('<i>') prop('outerHTML') join('\n');
                    focus|evo(3) full;
                    blur|evo(3) full(false);
                    keydown|evo(3) fulled pass ev('key') pass('Escape') stop $('form/textarea') focus"
                to="|@tabindex @html addClass|delay(3000) $('/i') hide;
                    |@html removeClass @tabindex">...</pre>
        </div>
        <hr tpl-node="common:submit" />
    </aside>
</form>


<!-- 脚本 -->
<form class="Script" onsubmit="return false" tpl-name="slave:script">
    <div class="_env"
        on="click(input)|evo(2) attr('-v') bool $('/fieldset') pop hide(_1)">
        <label>
            <input type="radio" name="runbox" data-v="true" value="sandbox" checked />沙盒内执行
        </label>
        <label class="_warn">
            <input type="radio" name="runbox" value="editor" />编辑器内运行
        </label>
        <fieldset class="_tips" data-pbo="hidden">
            <legend>警告：</legend>
            <p>操作 DOM 可能会带来破坏性，导致编辑器不可用或内容丢失！</p>
        </fieldset>
    </div>
    <div class="_body">
        <div class="_main" on="^nodeok|(null)" to="/pre|@-tip">
            <hr tpl-node="prop:codes" />
        </div>
        <aside>
            <!--脚本记录：
                - 执行之后计入脚本历史。
                - 提供历史条目的置顶和删除能力（简单复用和清理）。
                - 普通段包含前缀 yyyy-mm-dd[n]: 便于浏览，置顶段可自定义标签。
                功能：
                - 非管理模式下，单击某一条记录，自动插入脚本框内光标处。 -->
            <div class="_cmds"
                on="click(b)|node('script:history')"
                to="#g-modal|trigger('open')">
                <b title="脚本历史"><i id="l-history"></i></b>
                <input type="hidden" name="tabs" value="4" />
            </div>
            <div class="_submit">
                <button type="submit">执行</button>
            </div>
        </aside>
    </div>
</form>



<!--转换条目（子菜单）
    data-val 待转换目标单元名。
    <kbd>    单字符快捷键直达。
    注：仅包含完整的单元（不含中间结构）。
----------------------------------------------------------------------------->

<!-- 内联单元 -->
<menu role="submenu" class="_cells" tpl-name="menu:inlines">
    <li data-k="a" data-val="a" title="<a>"><b><a>链接</a></b><kbd>a</kbd></li>
    <li data-k="c" data-val="code" title="<code>"><b><code>代码</code></b><kbd>c</kbd></li>
    <li data-k="s" data-val="strong" title="<strong>"><b><strong>重点</strong></b><kbd>s</kbd></li>
    <li data-k="e" data-val="em" title="<em>"><b><em>强调</em></b><kbd>e</kbd></li>
    <li data-val="sup" title="上标<sup>"><b>O<sup>2</sup></b><kbd></kbd></li>
    <li data-val="sub" title="下标<sub>"><b>O<sub>2</sub></b><kbd></kbd></li>
    <li data-k="q" data-val="q" title="<q>"><b><q>引用</q></b><kbd>q</kbd></li>
    <li data-k="t" data-val="time" title="<time>"><b><time>时间</time></b><kbd>t</kbd></li>
    <li data-k="i" data-val="ins" title="<ins>"><b><ins>插入</ins></b><kbd>i</kbd></li>
    <li data-k="d" data-val="del" title="<del>"><b><del>删除</del></b><kbd>d</kbd></li>
    <li data-val="abbr" title="<abbr>"><b><abbr>缩写</abbr></b><kbd></kbd></li>
    <li data-val="small" title="<small>"><b><small>注脚</small></b><kbd></kbd></li>
    <li data-val="cite" title="<cite>"><b><cite>来源</cite></b><kbd></kbd></li>
    <li data-k="m" data-val="mark" title="<mark>"><b><mark>标记</mark></b><kbd>m</kbd></li>
    <li data-k="r" data-val="ruby" title="<ruby>">
        <b><ruby>
                <rb>注音</rb>
                <rp>(</rp><rt>zhù yīn</rt><rp>)</rp>
            </ruby></b>
        <kbd>r</kbd>
    </li>
    <li data-k="o" data-val="orz" title="表情<code:orz>"><b><code role="orz">(^_^)</code></b><kbd>o</kbd></li>
    <li data-val="dfn" title="<dfn>"><b><dfn>定义条目</dfn></b><kbd></kbd></li>
    <li data-val="samp" title="<samp>"><b><samp>样本</samp></b><kbd></kbd></li>
    <li data-k="k" data-val="kbd" title="<kbd>"><b><kbd>键盘字</kbd></b><kbd>k</kbd></li>
    <li data-val="s" title="<s>"><b><s>失效</s></b><kbd></kbd></li>
    <li data-k="u" data-val="u" title="<u>"><b><u>注记</u></b><kbd>u</kbd></li>
    <li data-k="v" data-val="var" title="<var>"><b><var>变量</var></b><kbd>v</kbd></li>
    <li data-k="b" data-val="bdo" title="<bdo dir=rtl>"><b><bdo dir="rtl">有向文本</bdo></b><kbd>b</kbd></li>
    <li data-pbo="disabled">&nbsp;</li>
    <!-- 注：不支持，只可划选创建 -->
    <!-- <li data-val="b" title="<b>"><b>特用&lt;b&gt;</b><kbd></kbd></li> -->
    <!-- <li data-val="i" title="<i>"><b>特用&lt;i&gt;</b><kbd></kbd></li> -->
</menu>


<!-- 行块单元（仅部分） -->
<menu role="submenu" tpl-name="menu:blocks">
    <li data-val="p" title="<p>"><b>段落</b><kbd>p</kbd></li>
    <li data-k="n" data-val="note" title="<p:note>"><b>注解</b><kbd>n</kbd></li>
    <li data-k="t" data-val="tips" title="<p:tips>"><b>提示</b><kbd>t</kbd></li>
    <li data-val="pre" title="<pre>"><b>预排版</b><kbd></kbd></li>
    <li data-val="address" title="<address>"><b>地址</b><kbd></kbd></li>
    <li data-k="u" data-val="ul" title="<ul>"><b>无序列表</b><kbd>u</kbd></li>
    <li data-k="o" data-val="ol" title="<ol>"><b>有序列表</b><kbd>o</kbd></li>
    <li data-val="ulx" title="<ul:ulx>"><b>无序级联表</b><kbd></kbd></li>
    <li data-val="olx" title="<ol:olx>"><b>有序级联表</b><kbd></kbd></li>
    <li data-k="c" data-val="cascade" title="<ol:cascade>"><b>级联编号表</b><kbd>c</kbd></li>
    <li data-k="b" data-val="blockquote" title="<blockquote>"><b>块引用</b><kbd>b</kbd></li>
    <li data-k="a" data-val="aside" title="<aside>"><b>批注</b><kbd>a</kbd></li>
    <li data-val="details" title="<details>"><b>详细内容</b><kbd></kbd></li>
    <!-- 注：不可为转换目标，因为无<dt>源（逻辑上）。 -->
    <!-- <li data-k="d" data-val="dl" title="<dl>"><b>描述列表</b><kbd>d</kbd></li> -->
</menu>

<!-- 空占位菜单（replace） -->
<menu role="submenu" tpl-name="menu:empty" data-pbo="hidden">
</menu>



<!--模态框区
----------------------------------------------------------------------------->
<!-- 确定/重置 -->
<div class="_btn2" tpl-name="modal:okreset">
    <button type="submit">确定</button>
    <button type="reset">重置</button>
</div>


<!-- 确定/取消 -->
<div class="_btn2" tpl-name="modal:okcancel">
    <button type="submit">确定</button>
    <button type="button">取消</button>
</div>

<!-- 确定 -->
<div class="_submit" tpl-name="modal:ok">
    <button type="submit">确定</button>
</div>


<!--模态页（通用）
    注：可供插件开发调用。 -->
<form class="_page" tpl-name="modal:page"
    on="submit|avoid">
    <header>
        <h4>[标题]</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <div class="_list">
        <!-- [node] -->
    </div>
    <hr tpl-node="modal:okreset" />
    <!-- 条目标记 -->
    <input type="hidden" name="item" value="" />
</form>


<!-- 模态框：属性 -->
<form class="_usual" tpl-name="modal:prop"
    on="init|ev('detail') pop tpl;
        label|$('/._prop') attr('-label');
        submit|avoid"
    to="/>._list|fill|goto('label');
        /h4|text">
    <header>
        <h4>[标题]</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <p class="_note" data-pbo="lost">
        [可选的说明/提示]
    </p>
    <div class="_list" data-pbo="">
        <!-- <ul> -->
    </div>
    <hr tpl-node="modal:okreset" />
</form>

<!-- 模态框：单行 -->
<form class="_small" tpl-name="modal:small"
    on="submit|avoid">
    <header>
        <h4>[标题]</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <p><input type="text" name="txtline" /></p>
    <hr tpl-node="modal:okreset" />
</form>


<!-- 模态框：消息 -->
<form class="_message" tpl-name="modal:message"
    on="submit|avoid">
    <header>
        <h4>[标题]</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <p class="_note">
        [消息内容]
    </p>
    <hr tpl-node="modal:ok" />
</form>


<!-- 插件页 -->
<form class="_page _plugins" tpl-name="modal:plugins"
    on="submit|avoid">
    <header>
        <h4>插件</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <p class="_list">
        <!-- 点击执行：<b>... -->
    </p>
</form>


<!-- 脚本：历史记录 -->
<form class="_page _script" tpl-name="script:history"
    on="submit|avoid">
    <header>
        <h4>脚本历史</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <main class="_history">
        <div class="_top">
            <div class="_bar">
                <label>置顶区</label>
                <!--撤销：成功后会激活Redo。-->
                <b id="_undo" title="撤消" data-pbo=""
                    on="state|evo(1) ev('detail') disable(_1);
                        click|evo(3) disabled end (Kit) call('shUndo');
                        enable|evo(1) disable(0)"
                    to="1/#_redo|trigger('enable')">↶</b>
                <!--重做：成功后会激活Undo。-->
                <b id="_redo" title="重做" data-pbo="disabled"
                    on="state|evo(1) ev('detail') disable(_1);
                        click|evo(3) disabled end (Kit) call('shRedo');
                        enable|evo(1) disable(0)"
                    to="1/#_undo|trigger('enable');
                        |trigger('state')">↷</b>
                <button>管理</button>
            </div>
            <!--置顶区代码清单
                click(b) 从本地记录中移除目标历史条目。
                click(label) 编辑标签并存储到本地记录。
                click(code)  捡取目标代码插入脚本输入框（同时退出模态）。
            -->
            <ul id="sh-top" class="_list" tpb-for>
                <li _data-time="$.datetime" _data-id="$.shid">
                    <label _="$.name">标签：单击编辑</label>
                    <code _="$.code">代码：单击提取并导入脚本录入框。</code>
                    <time _="$.datetime">时间戳</time>
                </li>
                <li _data-time="$.datetime" _data-id="$.shid">
                    <label _="$.name">标签：单击编辑</label>
                    <code _="$.code">代码：单击提取并导入脚本录入框。</code>
                    <b>删除</b>
                </li>
            </ul>
        </div>
        <hr> <!-- 拖动调整上区高度 -->
        <div class="_search">
            <input type="text" name="word" placeholder="空格：AND； 逗号：OR" />
            <button type="submit"></button>
        </div>
        <!--搜索结果清单
            clean 跟随置顶删除动作，移除结果清单中的相同条目（如果有）。 -->
        <ol id="sh-list" reversed class="_list" tpb-for
            on="clean|ev('detail') slr('/li', '-id', _1) $(_1) dup pass remove">
            <li _data-id="$.shid">
                <label _="$.SIZE - $.INDEX">[逆序号]</label>
                <code _="$.code">[代码]</code>
                <time _="$.datetime">[时间戳]</time>
                <b title="置顶"><i></i></b>
            </li>
            <li>
                <label _="$.SIZE - $.INDEX">[逆序号]</label>
                <code _="$.code">[代码]</code>
                <time _="$.datetime">[时间戳]</time>
                <b title="置顶"><i></i></b>
            </li>
            <li>
                <label _="$.SIZE - $.INDEX">[逆序号]</label>
                <code _="$.code">[代码]</code>
                <time _="$.datetime">[时间戳]</time>
                <b title="置顶"><i></i></b>
            </li>
        </ol>
    </main>
</form>


<!-- 脚本：执行结果 -->
<form class="_page _script" tpl-name="script:result">
    <header>
        <h4>脚本执行结果</h4>
        <b class="_close" title="关闭">✕</b>
    </header>
    <!--单击可编辑：
        - 方便即时微调后使用。
        - 如果只是简单需要结果文本，便于全选。-->
    <main class="_result"
        on="click(~pre)|evo(2) hasClass('_err') end (true);
            blur(~pre)|(false)"
        to="=|$contentEditable|fire(10, 'focus');
            =|$contentEditable">
        <pre class="_err" _="$.data">
<label>错误：</label>this is a error massage. </pre>
        <fieldset>
            <legend>插入选项</legend>
            <span class="_type">
                <i>类型：</i>
                <label title="text"><input type="radio" name="type" value="text" checked />文本</label>
                <label title="html"><input type="radio" name="type" value="html" />节点</label>
            </span>
            <span class="_where">
                <i>位置：</i>
                <select name="where">
                    <option title="内部填充">fill</option>
                    <option title="替换目标">replace</option>
                    <option title="内部末尾">append</option>
                    <option title="内部前端">prepend</option>
                    <option title="目标之前">before</option>
                    <option title="目标之后">after</option>
                </select>
            </span>
        </fieldset>
    </main>
    <hr tpl-node="modal:okcancel" />
</form>
