import{Filter as t}from"./filter.js";import{Spliter as e,UmpCaller as n,UmpString as r}from"./spliter.js";import{Util as o}from"./util.js";
//! $ID: render.js 2022.06.03 Tpb.Tools $
const s=window.$,i=new WeakMap,a=Symbol("scope-data"),l=Symbol("each-done"),u=Symbol("switch-case"),f=new e("|",new n,new r),c=new Map,p=new WeakMap,h={Method:[["tpb-each","$each"],["tpb-with","$with"],["tpb-var","$var"],["tpb-else","$else"],["tpb-if","$if"],["tpb-case","$case"],["tpb-last","$last"],["tpb-switch","$switch"],["tpb-for","$for"]],grammar(t){let e=new Map;for(const[n,r]of this.Method)t.hasAttribute(n)&&(this[r](e,t.getAttribute(n)),t.removeAttribute(n));return this.assign(e,t)},$each:(t,e)=>t.set("Each",[m.loop(e)]),$for:(t,e)=>t.set("For",[m.loop(e)]),$with:(t,e)=>t.set("With",[m.value(e)]),$var:(t,e)=>t.set("Var",[m.value(e)]),$if:(t,e)=>t.set("If",[m.value(e)]),$else:(t,e)=>t.set("Else",[e?m.value(e):null]),$switch:(t,e)=>t.set("Switch",[m.value(e)]),$case:(t,e)=>t.set("Case",[m.value(e)]),$last:(t,e)=>t.set("Last",[e?m.value(e):null]),assign(t,e){let n=[],r=[];for(let t of Array.from(e.attributes)){let o=t.name;"_"==o[0]&&(n.push(o.substring(1)),r.push(m.assign(t.value)),e.removeAttribute(o))}return n.length?t.set("Assign",[n,r]):t}},$={Each(t,e,n,r){t[l]||s.replace(t,function(t,e,n){let r=[];for(const[o,s]of e.entries()){let e=v(t);e[l]=!0,e[a]=A(s,o,n),r.push(e)}return r}(t,e(n,r),n))},For(t,e,n,r){s.append(t,function(t,e,n){let r=[];for(const[o,s]of e.entries())r.push(d(E(t),o,s,n));return r}(s.empty(t),e(n,r),n).flat())},With(t,e,n,r){let o=e(n,r);"object"!=typeof o&&(o=Object(o)),o.$=n,t[a]=o},Var(t,e,n,r){e(n,r)},If(t,e,n,r){e(n,r)?y(t):s.remove(t)},Else(t,e,n,r){e&&(e(n,r)?y(t):s.remove(t))},Switch(t,e,n,r){t[u]=e(n,r)},Case(t,e,n,r){if(t.parentElement[u]===e(n,r))return function(t){let e;for(const n of s.nextAll(t,"[_]"))e=c.get(n),(e.has("Case")||e.has("Last"))&&s.remove(n)}(t);s.remove(t)},Last(t,e,n,r){let o=t.parentElement;e&&o[u]!==e(n,r)&&s.remove(o)},Assign(t,e,n,r,o){e.forEach(((e,i)=>s.attr(t,e||"text",n[i](r,o))))}},m={value:t=>new Function("$","$$",`return ${t};`),loop:t=>t?new Function("$","$$",`return ${t};`):t=>t,assign(t){let e=[...f.split(t)],n=new Function("$","$$",`return ${e.shift()};`);if(0==e.length)return n;let r=e.map(b);return(t,e)=>r.reduce(((n,r)=>r[0](n,...r[1](t,e))),n(t,e))}};function b(e){let n=o.funcArgs(e.trim());return[t[n.name],new Function("$","$$",`return [${n.args}]`)]}function g(t,e,n,r){let o=s.find("[_]",t,!0);return s.find("[_]",e,!0).forEach(((t,e)=>r.set(t,n.get(o[e])))),e}function w(t,e=t){let n=s.find("[tpb-top]",t,!0);return s.find("[tpb-top]",e,!0).forEach(((t,e)=>p.set(t,p.get(n[e])||n[e]))),e}function v(t){return g(t,w(t,s.clone(t,!0,!0,!0)),c,c)}function d(t,e,n,r){return t.forEach((t=>1===t.nodeType&&(t[a]=A(n,e,r)))),t}function E(t){return t.map((t=>1===t.nodeType?v(t):t.cloneNode(!0)))}function A(t,e,n){return null==t?t:Object.assign(t,{INDEX:e,SIZE:n.length,$:n})}function y(t){let e;for(const n of s.nextAll(t,"[_]")){if(e=c.get(n),e.has("If"))break;e.has("Else")&&s.remove(n)}}function _(t,e,n){e=function(t,e,n){let r=c.get(t);if(r){for(const[o,s]of r)$[o](t,...s,t[a]||e,n);t.removeAttribute("_")}return t.removeAttribute("tpb-top"),t[a]||e}(t,e,n);for(let r=0;r<t.children.length;r++)_(t.children[r],e,n);return t}const j={parse:function(t){let e;for(const n of s.find("*",t,!0))e=h.grammar(n),e.size>0&&(i.set(n,e),n.setAttribute("_",""));return w(t)},render:function(t,e){let n=p.get(t);if(!n)throw new Error("[tpb-top] element not found.");let r=w(n,s.clone(n,!0,!0,!0));return _(g(n,r,i,c),e,e),c.clear(),s.replace(t,r)},clone:function(t,e){return g(t,e,i,i)},get:function(t){return i.get(t)}};export{j as Render};
//# sourceMappingURL=render.js.map
