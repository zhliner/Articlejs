import{Filter as t}from"./filter.js";import{Spliter as e,UmpCaller as n,UmpString as r}from"./spliter.js";import{Util as l}from"./util.js";
//! $ID: render.js 2019.09.17 Tpb.Tools $
const o=window.$,i=new WeakMap,s=Symbol("scope-data"),a=Symbol("each-index"),c=Symbol("compare-result"),u=Symbol("switch-value"),f=Symbol("case-pase"),h=Symbol("switch-display"),p=Symbol("for-children"),g=new e("|",new n,new r),m={Method:[["tpb-each","$each"],["tpb-with","$with"],["tpb-var","$var"],["tpb-else","$else"],["tpb-if","$if"],["tpb-case","$case"],["tpb-last","$last"],["tpb-switch","$switch"],["tpb-for","$for"]],grammar(t){let e=new Map;for(const[n,r]of this.Method)t.hasAttribute(n)&&(this[r](e,t.getAttribute(n),t),t.removeAttribute(n));return this.assign(e,t)},$each:(t,e,n)=>(function(t){let e=i.get(t),n=e&&e.get("For");n&&(n[2]=!0)}(n.parentElement),t.set("Each",[$.loop(e),1])),$for:(t,e,n)=>(y(n,!0),t.set("For",[$.loop(e),n.childElementCount,!1])),$with:(t,e)=>t.set("With",[$.value(e)]),$var:(t,e)=>t.set("Var",[$.value(e)]),$if:(t,e)=>t.set("If",[$.value(e)]),$else:(t,e)=>t.set("Else",[e?$.value(e):$.pass()]),$switch:(t,e)=>t.set("Switch",[$.value(e)]),$case:(t,e)=>t.set("Case",[$.value(e)]),$last:(t,e)=>t.set("Last",[e?$.value(e):null]),assign(t,e){let n=[],r=[];for(let t of Array.from(e.attributes)){let l=t.name;"_"==l[0]&&(n.push(l.substring(1)),r.push($.assign(t.value)),e.removeAttribute(l))}return n.length>0?t.set("Assign",[n,r]):t}},b={Each(t,e,n,r){let l=t[a]||0,o=e(r);this._alignEach(function(t,e){let n=[];for(;--e>=0&&t;)n.push(t),t=t.nextElementSibling;return n}(t,n-l),o.length,l+1).forEach(((t,e)=>t[s]=A(o[e],e,r))),i.get(t).get("Each")[1]=o.length+l},For(t,e,n,r,l){if(S(t))return;let i=e(l);0===t.childElementCount&&o.append(t,y(t)),this._alignFor(function(t,e){if(e)for(const e of o.children(t,"[_]"))e[a]>0&&o.remove(e);return o.children(box)}(t,r),n,i.length).forEach(((t,e)=>{let r=parseInt(e/n);t[s]=A(i[r],r,l)}))},With(t,e,n){let r=e(n);r||(r=Object(r)),r.$=n,"Object"==o.type(r)&&"Object"==o.type(n)&&o.proto(r,n),t[s]=r},Var(t,e,n){e(n)},If:(t,e,n)=>e(n)?F(t):_(t),Else(t,e,n){return function(t){let e;for(const n of o.prevAll(t,"[_]")){if(e=i.get(n),e.has("If"))return!n[c];if(e.has("Else")&&n[c])return!1}throw new Error("Else not find previous If.")}(t)?this.If(t,e,n):_(t)},Switch(t,e,n){S(t)||(t[u]=e(n),t.style.display=function(t){void 0===t[h]&&(t[h]=t.style.display);return t[h]}(t))},Case(t,e,n){let r=t.parentElement;I(r)&&r[u]===e(n)?(F(t),r[f]=!0):(_(t),r[f]=!1)},Last(t,e,n){let r=t.parentElement;if(!e)return I(r)?F(t):_(t);this.Case(t,e,n),I(r)&&(r.style.display="none")},Assign(t,e,n,r){S(t)||e.forEach(((e,l)=>o.attr(t,e||"text",n[l](r))))},_alignEach(t,e,n){let r=e-t.length;if(r<0)t.splice(r).forEach((t=>o.remove(t)));else if(r>0){let e=t[t.length-1];t.push(...o.after(e,function(t,e,n){let r=[];for(let l=0;l<e;l++){let e=o.clone(t,!0,!0,!0);e[a]=n+l,r.push(w(t,e))}return r}(e,r,n)))}return t},_alignFor(t,e,n){let r=n-parseInt(t.length/e);if(r<0)t.splice(r*e).forEach((t=>o.remove(t)));else if(t.length>0&&r>0){let n=function(t,e){let n=[];for(let r=0;r<e;r++)n=n.concat(v(t));return n}(t.slice(-e),r);t.push(...o.after(t[t.length-1],n))}return t}},$={value:t=>new Function("$",`return ${t};`),loop:t=>t?new Function("$",`return ${t};`):t=>t,pass:()=>()=>!0,assign(t){let e=[...g.split(t)],n=new Function("$",`return ${e.shift()};`);if(0==e.length)return n;let r=e.map(E);return t=>r.reduce(((e,n)=>n[0](e,...n[1](t))),n(t))}};function E(e){let n=l.funcArgs(e.trim());return[t[n.name],new Function("$",`return [${n.args}]`)]}function d(t,e){let n=[t];return"TEMPLATE"===t.nodeName&&(t=t.content),n.concat(o.find(e,t))}function w(t,e){var n,r;return n=d(t,"[_]"),r=d(e,"[_]"),n.forEach(((t,e)=>i.set(r[e],i.get(t)))),e}function v(t){let e=t.map((t=>o.clone(t,!0,!0,!0)));return e.forEach(((e,n)=>w(t[n],e))),e}function y(t,e){if(!e)return t[p];t[p]=[...t.children]}function A(t,e,n){return null==t?t:Object.assign(t,{INDEX:e,SIZE:n.length,$:n})}function S(t){return!1===t[c]}function _(t){let e=o.attr(o.elem("template"),"_","");o.append(o.replace(t,e).content,t),e[c]=!1,i.set(e,i.get(t))}function F(t){S(t)&&o.replace(t,t.content.firstElementChild),t[c]=!0}function I(t){return!t[f]}const j={parse:function(t){let e;for(const n of o.find("*",t,!0))e=m.grammar(n),e.size>0&&(i.set(n,e),n.setAttribute("_",""));return t},clone:w,update:function t(e,n){n=function(t,e){let n=i.get(t);if(n)for(const[r,l]of n)b[r](t,...l,t[s]||e);return t[s]||e}(e,n);for(let r=0;r<e.children.length;r++)t(e.children[r],n);return e},get:function(t){return i.get(t)}};export{j as Render};
//# sourceMappingURL=render.js.map
