# Tpb 详细设计

> `tpb`: Template Presentational Behavior


## 目的

在HTML上简单直观地设计UI。因为UI的交互逻辑也应当属于页面设计师的工作，所以事件的绑定规划也需要包含。

HTML的代码有着严格的树形结构，虽然浏览器可以正常解析杂乱无章的HTML源码，但这样的结构也可以是人工友好的，设计师可以在这样的树形结构中思考。同时，简明清晰的HTML源码既方便分享，也可以节省数据的存储和流量。

HTML源码不应当脱离设计师的视野，**源码**这一逻辑也并不就是程序员专属，实际上，HTML就是一种模板，在模板上定义交互逻辑十分正常。因此，本设计中的事件绑定在模板中定义，由设计师完全主导。设计师唯一需要知道的是有哪些数据可用，而这些数据都是纯数据，与页面展示无关。

同时，程序员也不需要知道数据将如何展现，即：理论上，数据中不应当有HTML标签结构。



## 指令

以模板为驱动，功能指令书写在HTML元素上，自动解析完成事件的绑定和行为序列的编译。

1. **行为定义：**<br>
    由三个属性 `on`、`by`、`to` 定义，在元素上配置需要处理的事件和相应的行为链。其中：
    - `on`：事件绑定和取值逻辑。
    - `by`：具体的业务处理。可以在内部划分为 `EMR`（`Entry`, `Model`, `Render`）三个环节，可选。
    - `to`：用业务环节来的数据更新UI。逻辑上可选，但通常是必需的。

2. **节点渲染：**<br>
    由十个渲染属性 `tpb-[for|each|if|elseif|else|with|var|switch|case|default]` 表达模板的语法结构，以及一个 **属性名前置下划线** 指定属性赋值的规则，如：`_href="$.url"` 表示对 `href` 属性赋值为变量 `url` 的值，单独的属性名 `_` 指对元素内容赋值。
    - `tpb-for`: 子元素的循环。
    - `tpb-each`: 当前元素的循环迭代。
    - `tpb-if`: 当前元素 if 测试，真值显示，假值移除。下同。
    - `tpb-elseif`: 当前元素 `elseif` 测试，与 `if` 匹配使用。
    - `tpb-else`: 当前元素 `else` 测试，与 `if` 匹配使用。
    - `tpb-with`: 新建局部域，变量引用为局部域成员。
    - `tpb-var`: 新建变量，方便后续简化使用。
    - `tpb-switch`: 创建子元素 `switch` 逻辑。
    - `tpb-case`: 当前元素 `case` 测试，与 `switch` 标的值比较，相等则显示，否则移除。
    - `tpb-default`: 当前元素的 `switch` 默认分支，其它 `case` 不匹配时显示，否则移除。

3. **模板管理：**<br>
    由两个属性 `tpl-[name|load]` 配置。
    - `tpl-name`: 当前元素命名为一个具名模板，用于外部检索或子模版导入时引用。
    - `tpl-load`: 标记当前元素为一个容器，内部需要导入目标名称的子模版。



## 基本规则

所有方法中的首个实参都为 `evo`，它们是在方法调用时自动传入的，在模板中并不可见（在程序代码中定义）。

```js
evo: {
    event: {Event}                  // 原生事件对象（未侵入）
    origin: {Element}               // 事件起点元素（event.target）
    current: {Element}              // 触发事件的当前元素（event.currentTarget|matched）
    related: {Element|null}         // 事件相关联元素（event.relatedTarget）
    delegate: {Element|undefined}   // 委托绑定的元素（event.currentTarget）
    selector: {String|undefined}    // 委托匹配选择器（for match）
}
```

### 取栈规则

由暂存区取值函数执行（由方法自行调用），实参含义：

- `0` 若暂存区有值则返回值，否则返回 `undefined`。不取栈。
- `n` 若暂存区有值则返回值（通常是一个集合），否则取栈顶 `n` 项返回。


### 附：设计参考

- **实参null**：如果 `当前条目` 有效，通常表示取条目本身为实参替代。
- **自动取栈**：方法**明确需要**有操作目标时，暂存区为空会自动取栈顶条目。目标**可有可无**时，目标自身会成为一种可选项，此时不会自动取栈。



## 全局PB集

### 顶层全局（适用 On/By/To 三个域）

```js
$( rid: String | null ): Element
// 检索元素入栈：tQuery.get( down, up )
// 目标：当前条目。不自动取栈。
// rid:
// - String 以当前条目或事件当前元素为起点，上/下检索目标元素。
// - null   以当前条目为rid。
// 注：
// 当前条目充当2种角色，起点元素或rid替代。

$$( rid: String | Value | null ): Collector
// 检索元素集入栈：tQuery(...)
// 目标：当前条目。不自动取栈。
// rid:
// - String （同上）
// - null   （同上）
// - Value  非预设类型/值时，封装为Collector。
// 注：
// 当前条目充当2种角色：起点元素和rid替代（实参为null时）。
// 如果rid实参为null而当前条目非字符串时，当前条目值封装为Collector。

evo( name: String | Number ): Value
// 从当前evo对象上取值入栈。
// name: {
//     -1|'event'     evo.event
//      0|'origin'    evo.origin
//      1|'current'   evo.current
//      2|'delegate'  evo.delegate
//      3|'related'   evo.related
//      9|'selector'  evo.selector
// }
// 目标：从（隐藏的）首个实参上取值。无需当前条目。

ev( ...name: String | [String] ): Value | [Value]
// 从事件对象上取值入栈。
// name为事件对象内的成员名，多个实参取值会自动展开入栈。
// name: {
//      'key':      evo.event.key
//      'detail':   evo.event.detail
//      '...':      evo.event[...]
// }
// 目标：实参事件对象。无需当前条目。
// 注：
// 如果需要入栈一个值集，实参自身需要是一个数组。

nil(): void
// 一个空行为，占位。
// 既不从暂存区取值，也不向数据栈添加值。
// 通常在On无需取值时作为视觉友好使用。如：click|nil;

del( start, count ): void
// 删除栈任意位置段条目，位置指定支持负数从末尾算起。
// count 可选，默认删除到末尾。
// 注：移除的值不会进入暂存区。


// 控制类
//===============================================

pass( val?, name? ): void
// 通过性检测（是否中断执行流）。
// 目标：当前条目/栈顶项。
// val:
// - 有值则为相等（===）测试，否则为真值测试。
// name:
// - 进阶目标定位，取当前条目内name键的值用于对比。
// - 未定义时取当前条目整体对比，默认。
// 注记：
// name的进阶定位主要用于普通对象的成员值获取。
// 元素对象可通过attr()/prop()/css()等取值，因此name不支持首字符特殊指引。

avoid(): void
// 停止事件默认的行为。
// 即调用：event.preventDefault()
// 目标：当前条目。
// - 如果当前条目为空，无条件执行。
// - 否则为条件执行：真值执行，假值跳过。

stop( end ): void
// 停止事件冒泡，如果end为真，同时停止执行流。
// 即调用：stopPropagation()
// 目标：当前条目。
// - 如果当前条目为空，无条件执行。
// - 否则为条件执行：真值执行，假值跳过。

stopAll( end ): void
// 停止事件冒泡并阻止本事件其它处理器的执行。
// 如果end为真，同时停止当前执行流。
// 内部调用：event.stopImmediatePropagation()
// 目标：当前条目。
// - 如果当前条目为空，无条件执行。
// - 否则为条件执行：真值执行，假值跳过。


// 暂存区赋值
// 赋值为单值或Collector。
//===============================================

pop( n ): void
// 弹出栈顶 n 个条目，构建为一个Collector赋值。
// 无实参调用弹出末尾条目，作为单个值赋值。
// 即：pop() 和 pop(1) 的返回值不一样。
// pop(0) 不会弹出任何内容，但会创建一个空集赋值。
//
// 弹出：单值|Collector。

slice( begin, end ): void
// 复制数据栈某区段条目，构造为一个Collector赋值。
// 两个下标位置支持负数。
//
// 克隆：任意区段，Collector。

item( idx ): void
// 引用数据栈idx位置的单个值赋值到暂存区。
//
// 克隆：任意位置，单值。


// 下面的方法会移除栈内条目
//-----------------------------------------------
// 逻辑上这不是栈操作，但JavaScript中的数组提供了这种能力。
// 因此这里提供相关方法，应该不常用。

shift( n ): void
// 移除栈底 n 个条目，构建为一个Collector赋值。
// 无实参调用移除首个条目，作为单个值赋值。
// 即：shift() 和 shift(1) 返回值不同。
//
// 移除：单值|Collector。

splice( start, count ): void
// 移除数据栈某区段条目，构造为一个Collector赋值。
// start下标位置支持负数。
//
// 移除：任意区段，Collector。

pick( idx ): void
// 移除数据栈idx位置的单个值赋值到暂存区。
// 效果同：splice(idx, 1)[0]
//
// 移除：任意位置，单值。
```


### 运算全局（仅用于 On/By 两个域）

```js
// 类型转换
// 目标：当前条目/栈顶1项。
//===============================================

Arr( ext: Boolean ): Array
// 转换为数组。
// 如果 ext 为真，表示按类数组扩展目标为一个新数组（Array.from）。
// 否则只是简单的封装目标为一个单值数组（Array.of）。

Str( prefix?, suffix? ): String
// 转换为字符串。
// 可以选择性的添加前/后缀。

Bool(): Boolean
// 转换为布尔值（false|true）
// '', 0, false, null, undefined 为假，其它为真。

Int( radix ): Number
// 将字符串转为整数，即 parseInt()

Float(): Number
// 将字符串转为浮点数，即 parseFloat()


// 简单取值
//===============================================

env( name: String, $val?: Value ): void | Value
// 全局环境设置或取值。
// $val 有值时为设置，未定义时为取值入栈。
// 设置时：
// 目标：当前条目。不自动取栈。
// 如果当前条目非空，$val字符串支持首字符特殊指引，null指当前条目自身。
// 否则 $val 视为字面量设置值。
// 否则任意的$val只是一个字面值。

put( ...$val: Value | [Value] ): Value | [Value]
// 简单赋值。
// 目标：当前条目。不自动取栈。
// 若目标非空，$val字符串支持首字符特殊指引，null指当前条目自身（无实际意义）。
// 否则 $val 视为字面量入栈。
// 注：
// 多个实参会自动展开入栈。如果要入栈数组，实参需为数组。
// 无实参调用入栈 undefined。

data( name, $val ): void | Value
// 关联数据存储/取出。
// 目标：当前条目/栈顶项。
// 在一个WeakMap实例中存储目标关联的数据项或取出数据项入栈。
// 数据本身是一个Map对象：
// - name 数据项名称（键）。
// - $val 数据项值。当前条目非空时，字符串支持首字符特殊指引，null指当前条目自身。
// 注：
// 如果当前条目为空，$val的任意值都为字面量。
// 当然，关联对象本身（作为WeakMap的键）是需要自动取栈的。


// 集合操作
// 取当前条目（集合）操作后自动入栈。
//===============================================

sort( unique, $comp ): Collector
// 数据栈排序。
// $comp为比较函数体，null表示采用默认规则。
// 参数名固定：(a, b)。
// $comp支持首字符（!）特殊指引，引用X函数库成员。

flat( depth = 1, all = false): Collector
// 数据栈扁平化，可指定最深层级。
// all为真表示整个数据栈，否则默认指上一次添加的集合。
// 实现：Arr.push( ...Arr.pop() )
// 如果最后一次入栈的不是集合，调用会出错。
// 注：
// 这是入栈模式由concat改为push的细粒度分解要求。

reverse(): Collector
// 集合成员序位反转。


// 集合筛选
//===============================================
// $fltr为过滤表达式或函数名，表达式可用参数名：（v, i, o）。
// 注：
// $fltr如果为表达式，执行结果自动返回（无需return）。
// $fltr支持首字符特殊指引，引用X函数库成员。

filter( $fltr, flat: Number = 0 ): [Value]
// 值集过滤，匹配者构建一个新集合入栈。
// flat为集合扁平化层级：
// 0    整体入栈，默认
// 1    一维展开
// n    n 维展开
// 注：取当前条目或栈顶项，它们应当是一个集合。

not( $fltr, flat: Number = 0 ): [Value]
// 值集排除。符合者被排除集合，剩余的创建为一个新集合入栈。
// flat 含义同上。

has( $fltr, flat: Number = 0 ): [Element]
// 子元素包含。
// 仅适用于元素集，普通值集无效。



// 简单运算
//===============================================

add(): Number     // (x, y) => x + y
sub(): Number     // (x, y) => x - y
mul(): Number     // (x, y) => x * y
div(): Number     // (x, y) => x / y
mod(): Number     // (x, y) => x % y
// 标准算术。
// 目标：当前条目/栈顶2项。

divmod( flat:Number ): [Number, Number]
// 除并求余。(x, y) => [x/y, x%y]
// 目标：当前条目/栈顶2项。
// flat：扁平化展开的层级，最多为1，0值不展开（默认）。

nneg( flat:Number ): Number | [Number]
// 数值取负（-x）。
// 目标：当前条目（不定成员数）/栈顶1项。
// flat 含义同上。
// 注：
// 当前条目为集合时返回一个Collector。

vnot( flat:Number ): Boolean | [Boolean]
// 逻辑取反（!x）。
// 目标：当前条目（不定成员数）/栈顶1项。
// flat 含义同上。
// 注：
// 当前条目为集合时返回一个Collector。

dup( flat:Number ): Value | [Value]
// 复制。
// 目标：当前条目（不定成员数）/栈顶1项。
// flat 含义同上。
// 注：
// 当前条目为集合时返回一个Collector。
// 自动取条目克隆时，返回值类型与源值类型相同。


// 比较&逻辑运算
//===============================================
// 下面的 $expr 为测试表达式或函数名，表达式可用参数名：（v, i, o）。
// $expr 支持首字符特殊指引，引用X函数库成员。

equal(): Boolean    // (x, y) => x === y
nequal(): Boolean   // (x, y) => x !== y
lt(): Boolean       // (x, y) => x < y
lte(): Boolean      // (x, y) => x <= y
gt(): Boolean       // (x, y) => x > y
gte(): Boolean      // (x, y) => x >= y
// 标准比较。
// 目标：当前条目/栈顶2项。


within( min, max ): Boolean
// 是否在 [min, max] 的范围内（包含边界值）。
// 目标：当前条目/栈顶项。

inSet( ...val ): Boolean
// 是否在集合内。
// 目标：当前条目/栈顶项。
// 实现：实参数组的简单存在性测试（Array.includes）。

isAnd( $expr ): Boolean
// 二者为真判断。
// $expr 可选，默认简单真值判断。
// 目标：当前条目/栈顶2项。

isOr( $expr ): Boolean
// 二者任一为真测试。
// $expr 可选，默认简单真值判断。
// 目标：当前条目/栈顶2项。

every( $expr ): Boolean
// 集合成员全为真测试。
// $expr 可选，默认简单真值判断。
// 目标：当前条目。不自动取栈。

some( n, $expr ): Boolean
// 集合成员至少 n 项为真测试。
// $expr 可选，默认简单真值判断。
// 目标：当前条目。不自动取栈。


// 判断执行。
//===============================================
// - vtrue(...) 简单的 if 逻辑。
// - vtrue(..., true)  模拟 else 逻辑，后跟 vtrue()。
// - vtrue(..., false) 模拟 else 逻辑，后跟 vfalse()。
// - vtrue(..., xxx) 可模拟 switch/case 逻辑，后跟进一步比较。

vtrue( $code, vback ): Value | vback
// 真值执行，否则跳过。
// $code 为函数体代码（无实参），支持首字符特殊指引（X函数库成员）。
// 目标：当前条目/栈顶1项。
// 注：
// vback 为跳过状态时回送入栈的值，可选。
// vback 在执行状态下无效，因为此时是代码的执行结果入栈。

vfalse( $ccode, vback ): Value | vback
// 假值执行，否则跳过。
// $code 为函数体代码（无实参），支持首字符特殊指引（X函数库成员）。
// 目标：当前条目/栈顶1项。
// 注：vback 参数含义同上。


// 其它
//===============================================

tpl( name: String | null, timeout: Number ): Element | false
// 从全局模板空间获取name模板。
// 目标：当前条目/栈顶1项。
// 如果设置 name 为 null 值，表示从目标获取模板名称。这在动态指定模板名时有用。
// 注：
// 模板请求可能是异步的，如果异步超时返回false入栈。
```



## 应用

### 交互文档

最简单的形式，让普通网页包含互动，不涉及向服务器请求新的数据。可为本地文件（`file://`）方式查看，适合普通的离线文档文章手册等。


### 动态页（Taker）

需要连网，页面可以向服务器实时请求数据更新页面。内容展示逻辑较简单，不包含向外请求新的模板。


### 页程序（WebApp）

功能复杂的页面应用，通常需要向服务器请求数据和新的模板，内部可进一步分解成 `EMR`（`Entry/Model/Render`） 三层逻辑。



## 附录

### 缩写

> `OBT`: `On-By-To` 在HTML页面中定义行为。
> `GPS`: `Get, Process, Set` 页面UI的整体逻辑。
> `EMR`: `Entry, Model, Render` 属于GPS中的Process深入分层（如果需要）。


### 事件

- `tplend`: 模板读取完毕。在 `document` 上触发。
- `tpldone`: 模板构建完毕，包括 `OBT` 解析绑定。在有 `OBT` 配置上的每一个元素上触发，不冒泡。


### 全局对象

- `OBT.on`： On 的方法集。
- `OBT.by`： By 的方法集。
- `OBT.to`： To 的方法集。


### 模板特殊字符

在模板中部分标点符号用于特别的目的。

- **`;`** 分号。分隔符，用于通用的逻辑区隔，如OBT定义分组。
- **`,`** 逗号。表示并列的关系，如参数列表、PB调用链。
- **`|`** 竖线。递进处置，如输出数据的过滤处理、事件关联的PB行为链。
- **`-`** 横线。空值占位，主要用于OBT分组定义中的顺序保持。
- **`$`** 对当前域或父域对象的引用。


### 实参首字符指引

- **`@`**: 元素特性取值（Attribute）。
- **`&`**: 元素属性取值（Property）。
- **`%`**: 元素样式取值。
- **`-`**: 元素data-系属性名简写。
- **`$`**: tQuery/Collector方法调用（On段无实参传递）。
- **`?`**: 普通对象属性值或方法调用，如 `Date` 成员取值。
- **`!`**: 外部扩展函数库（X）检索获取。

> **注：**
> 除最后一个外，前面的操作目标都是当前条目或栈顶项。
