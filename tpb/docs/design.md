# Tpb 详细设计

> `tpb`: Template Presentational Behavior


## 目的

在HTML上简单直观地设计UI。因为UI的交互逻辑也应当属于页面设计师的工作，所以事件的绑定规划也需要包含。

HTML的代码有着严格的树形结构，虽然浏览器可以正常解析杂乱无章的HTML源码，但这样的结构也可以是人工友好的，设计师可以在这样的树形结构中思考。同时，简明清晰的HTML源码既方便分享，也可以节省数据的存储和流量。

HTML源码不应当脱离设计师的视野，**源码**这一逻辑也并不就是程序员专属，实际上，HTML就是一种模板，在模板上定义交互逻辑十分正常。因此，本设计中的事件绑定在模板中定义，由设计师完全主导。设计师唯一需要知道的是有哪些数据可用，而这些数据都是纯数据，与页面展示无关。

同时，程序员也不需要知道数据将如何展现，即：理论上，数据中不应当有HTML标签结构。



## 指令

以模板为驱动，功能指令书写在HTML元素上，自动解析完成事件的绑定和行为序列的编译。

1. **行为定义：**<br>
    由三个属性 `on`、`by`、`to` 定义，在元素上配置需要处理的事件和相应的行为链。其中：
    - `on`：事件绑定和取值逻辑。
    - `by`：具体的业务处理。可以在内部划分为 `EMR`（`Entry`, `Model`, `Render`）三个环节，可选。
    - `to`：用业务环节来的数据更新UI。逻辑上可选，但通常是必需的。

2. **节点渲染：**<br>
    由十个渲染属性 `tpb-[for|each|if|elseif|else|with|var|switch|case|default]` 表达模板的语法结构，以及一个 **属性名前置下划线** 指定属性赋值的规则，如：`_href="$.url"` 表示对 `href` 属性赋值为变量 `url` 的值，单独的属性名 `_` 指对元素内容赋值。
    - `tpb-for`: 子元素的循环。
    - `tpb-each`: 当前元素的循环迭代。
    - `tpb-if`: 当前元素 if 测试，真值显示，假值移除。下同。
    - `tpb-elseif`: 当前元素 `elseif` 测试，与 `if` 匹配使用。
    - `tpb-else`: 当前元素 `else` 测试，与 `if` 匹配使用。
    - `tpb-with`: 新建局部域，变量引用为局部域成员。
    - `tpb-var`: 新建变量，方便后续简化使用。
    - `tpb-switch`: 创建子元素 `switch` 逻辑。
    - `tpb-case`: 当前元素 `case` 测试，与 `switch` 标的值比较，相等则显示，否则移除。
    - `tpb-default`: 当前元素的 `switch` 默认分支，其它 `case` 不匹配时显示，否则移除。

3. **模板管理：**<br>
    由两个属性 `tpl-[name|load]` 配置。
    - `tpl-name`: 当前元素命名为一个具名模板，用于外部检索或子模版导入时引用。
    - `tpl-load`: 标记当前元素为一个容器，内部需要导入目标名称的子模版。



## 应用

### 交互文档

最简单的形式，让普通网页包含互动，不涉及向服务器请求新的数据。可为本地文件（`file://`）方式查看，适合普通的离线文档文章手册等。


### 动态页（Taker）

需要连网，页面可以向服务器实时请求数据更新页面。内容展示逻辑较简单，不包含向外请求新的模板。


### 页程序（WebApp）

功能复杂的页面应用，通常需要向服务器请求数据和新的模板，内部可进一步分解成 `EMR`（`Entry/Model/Render`） 三层逻辑。



## 附录

### 缩写

> `OBT`: `On-By-To` 在HTML页面中定义行为。
> `GPS`: `Get, Process, Set` 页面UI的整体逻辑。
> `EMR`: `Entry, Model, Render` 属于GPS中的Process深入分层（如果需要）。


### 事件

- `tplend`: 模板读取完毕。在 `document` 上触发。
- `tpldone`: 模板构建完毕，包括 `OBT` 解析绑定。在有 `OBT` 配置上的每一个元素上触发，不冒泡。


### 全局对象

- `OBT.on`： On 的方法集。
- `OBT.by`： By 的方法集。
- `OBT.to`： To 的方法集。


### 模板特殊字符

在模板中部分标点符号用于特别的目的。

- **`;`** 分号。分隔符，用于通用的逻辑区隔，如OBT定义分组。
- **`,`** 逗号。表示并列的关系，如参数列表、PB调用链。
- **`|`** 竖线。递进处置，如输出数据的过滤处理、事件关联的PB行为链。
- **`-`** 横线。空值占位，主要用于OBT分组定义中的顺序保持。
- **`$`** 对当前域或父域对象的引用。


### 实参首字符指引

- **`@`**: 元素特性取值（Attribute）。
- **`&`**: 元素属性取值（Property）。
- **`%`**: 元素样式取值。
- **`-`**: 元素data-系属性名简写。
- **`!`**: By外部函数扩展集检索。
- **`$`**: tQuery/Collector方法引用。
